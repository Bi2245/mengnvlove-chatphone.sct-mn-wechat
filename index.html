<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://img.heliar.top/file/1764658297976_Screenshot_2025_1125_181816.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>xxcoPhone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style id="global-theme-style"></style> <!-- 全局自定义主题注入点 -->
    <style>
        :root {
            /* 屏幕尺寸 */
            --phone-width: 380px;
            --phone-height: 820px;

            /* 主题颜色变量 */
            --wechat-bg: #EDEDED;
            --wechat-nav-bg: #F6F6F6;
            --wechat-border-color: #D8D8D8;
            --wechat-text-primary: #000000;
            --wechat-text-secondary: #888888;
            --wechat-green: #07C160;
            --wechat-blue: #576B95;
            --wechat-red: #FA5151;
            --special-orange-bg: #FCAE3D;

            /* 美化变量 */
            --user-avatar-frame: none;
            --char-avatar-frame: none;
            --avatar-shape: 6px;
            --chat-background-image: none;
            --home-screen-background-image: url('https://source.unsplash.com/random/380x820?gradient');
            --lock-screen-wallpaper: url('https://source.unsplash.com/random/380x820?night,sky');
            --home-screen-font-color: #FFFFFF;
            --global-font-color: var(--wechat-text-primary);
            --player-image: url('https://img.heliar.top/file/1764067235404_Screenshot_2025_1125_183413.png');
            --player-background: url('https://img.heliar.top/file/1764067231296_Screenshot_2025_1125_183056.png');
            --user-custom-font: 'UserCustomFont', -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            --font-size-base: 15px;

            /* 手机边框变量 */
            --phone-border-color: #111;
            --phone-border-width: 10px;
            --phone-shadow: 0 15px 50px rgba(0,0,0,0.3);
            --phone-edge-highlight: transparent;
            --phone-backdrop-filter: none;
            
            /* 暗黑主题背景变量 */
            --page-bg-general: none;
            --page-bg-special: none;

            /* 主屏幕APP图标变量 */
            --app-icon-size: 60px;
            --app-icon-gap: 20px;
            --app-icon-radius: 15px;

            /* 电池图标变量 */
            --battery-icon-image: none;
            --battery-percent-display-outside: block;
            --battery-percent-display-inside: none;
        }

        /* --- 主题 --- */
        /* 夜间模式 */
        body.dark-mode {
            --wechat-bg: #121212;
            --wechat-nav-bg: #1E1E1E;
            --wechat-border-color: #3A3A3C;
            --wechat-text-primary: #EAEAEA;
            --wechat-text-secondary: #8E8E93;
            --global-font-color: #EAEAEA;
        }
        body.dark-mode .list-item, body.dark-mode .me-profile-card, body.dark-mode .me-menu-item, body.dark-mode .chat-input-bar, body.dark-mode .modal-content, body.dark-mode .form-group input, body.dark-mode .form-group textarea, body.dark-mode .form-group select, body.dark-mode .moment-post, body.dark-mode .bank-card, body.dark-mode .forum-post { background-color: var(--wechat-nav-bg); color: var(--global-font-color); }
        body.dark-mode .message-row.received .message-bubble.text-bubble { background-color: var(--wechat-nav-bg); }
        body.dark-mode .message-row.received .message-bubble.text-bubble::after { background: var(--wechat-nav-bg); }
        body.dark-mode .message-recalled, body.dark-mode .message-system { background: #333; color: var(--wechat-text-secondary); }
        body.dark-mode .list-item:active, body.dark-mode .me-menu-item:active { background-color: #2c2c2c; }
        body.dark-mode .chat-input-bar input { background: #333; color: var(--global-font-color); }
        body.dark-mode .chat-plus-menu { background: #252525; }
        body.dark-mode .plus-menu-item .icon { background: #333; border-color: #444; }
        body.dark-mode .header-back-btn, body.dark-mode .header-title, body.dark-mode .header-right { color: var(--global-font-color); }
        body.dark-mode .tab-item, body.dark-mode .forum-tab-item { color: var(--wechat-text-secondary); }
        body.dark-mode .tab-item.active, body.dark-mode .forum-tab-item.active { color: var(--wechat-green); }
        body.dark-mode .message-bubble.camera-sim-bubble, body.dark-mode .message-bubble.location-bubble { background: #2c2c2e; border-color: #3a3a3c; }
        body.dark-mode .message-bubble.location-bubble .map-placeholder { background-color: #3a3a3c; }
        
        /* 可爱樱花粉主题 */
        body.sakura-pink-mode { --wechat-bg: #FFF0F5; --wechat-nav-bg: #FFC0CB; --wechat-border-color: #FFB6C1; --wechat-text-primary: #333333; --wechat-text-secondary: #8B4513; --wechat-green: #FF69B4; --wechat-blue: #DB7093; --global-font-color: #333333; }
        body.sakura-pink-mode .list-item, body.sakura-pink-mode .me-profile-card, body.sakura-pink-mode .me-menu-item, body.sakura-pink-mode .chat-input-bar, body.sakura-pink-mode .modal-content, body.sakura-pink-mode .form-group input, body.sakura-pink-mode .form-group textarea, body.sakura-pink-mode .form-group select, body.sakura-pink-mode .moment-post, body.sakura-pink-mode .bank-card, body.sakura-pink-mode .forum-post { background-color: #FFFFFF; color: var(--global-font-color); }
        body.sakura-pink-mode .message-row.sent .message-bubble.text-bubble { background-color: #FFDFE5; }
        body.sakura-pink-mode .message-row.sent .message-bubble.text-bubble::after { background: #FFDFE5; }
        body.sakura-pink-mode .message-row.received .message-bubble.text-bubble { background-color: #FFFFFF; }
        body.sakura-pink-mode .message-row.received .message-bubble.text-bubble::after { background: #FFFFFF; }

        /* 透明主题 */
        body.transparent-mode { --wechat-bg: transparent; --wechat-nav-bg: transparent; --wechat-border-color: rgba(255, 255, 255, 0.2); --wechat-text-primary: #FFFFFF; --wechat-text-secondary: #CCCCCC; --global-font-color: #FFFFFF; }
        body.transparent-mode .wallet-header { background-color: transparent; }

        /* 拟态主题 */
        body.neumorphic-mode { --wechat-bg: #e0e5ec; --wechat-nav-bg: #e0e5ec; --wechat-border-color: transparent; --wechat-text-primary: #555; --wechat-text-secondary: #999; --global-font-color: #555; }
        body.neumorphic-mode .list-item, body.neumorphic-mode .me-profile-card, body.neumorphic-mode .me-menu-item, body.neumorphic-mode .chat-input-bar, body.neumorphic-mode .modal-content, body.neumorphic-mode .form-group input, body.neumorphic-mode .form-group textarea, body.neumorphic-mode .form-group select, body.neumorphic-mode .moment-post, body.neumorphic-mode .message-bubble, body.neumorphic-mode .wechat-header, body.neumorphic-mode .wechat-tabbar, body.neumorphic-mode .bank-card, body.neumorphic-mode .forum-post, body.neumorphic-mode .forum-tabbar { background: #e0e5ec; box-shadow: 7px 7px 15px #a3b1c6, -7px -7px 15px #ffffff; border: none; }
        body.neumorphic-mode .message-row.sent .message-bubble { box-shadow: inset 5px 5px 10px #a3b1c6, inset -5px -5px 10px #ffffff; }

        /* ^•͈༝•^ฅ 主题 */
        body.clear-sky-blue-mode { --wechat-bg: #E1F5FE; --wechat-nav-bg: #B3E5FC; --wechat-border-color: #81D4FA; --wechat-text-primary: #01579B; --wechat-text-secondary: #4FC3F7; --wechat-green: #0288D1; --wechat-blue: #03A9F4; --global-font-color: #01579B; }
        body.clear-sky-blue-mode .list-item, body.clear-sky-blue-mode .me-profile-card, body.clear-sky-blue-mode .me-menu-item, body.clear-sky-blue-mode .chat-input-bar, body.clear-sky-blue-mode .modal-content, body.clear-sky-blue-mode .form-group input, body.clear-sky-blue-mode .form-group textarea, body.clear-sky-blue-mode .form-group select, body.clear-sky-blue-mode .moment-post, body.clear-sky-blue-mode .bank-card, body.clear-sky-blue-mode .forum-post { background-color: #FFFFFF; }
        body.clear-sky-blue-mode .message-row.sent .message-bubble.text-bubble { background-color: #81D4FA; }
        body.clear-sky-blue-mode .message-row.sent .message-bubble.text-bubble::after { background: #81D4FA; }
        body.clear-sky-blue-mode .message-row.received .message-bubble.text-bubble { background-color: #FFFFFF; }
        body.clear-sky-blue-mode .message-row.received .message-bubble.text-bubble::after { background: #FFFFFF; }

        /* 暗黑深渊 */
        body.dark-abyss-mode { --wechat-bg: transparent; --wechat-nav-bg: rgba(20, 20, 20, 0.75); --wechat-border-color: rgba(80, 80, 80, 0.5); --wechat-text-primary: #EAEAEA; --wechat-text-secondary: #A0A0A0; --wechat-green: #00E676; --wechat-blue: #64B5F6; --page-bg-general: url('https://img.heliar.top/file/1764067333851_Screenshot_2025_1125_182817.png'); --page-bg-special: url('https://img.heliar.top/file/1764067588537_Screenshot_2025_1125_181851.png'); --global-font-color: #EAEAEA; }
        body.dark-abyss-mode .screen { background-image: var(--page-bg-general); background-size: cover; background-position: center; }
        body.dark-abyss-mode .page { background-color: transparent; }
        body.dark-abyss-mode #settings-page, body.dark-abyss-mode #wallet-page, body.dark-abyss-mode #moments-page { background-image: var(--page-bg-special); background-size: cover; background-position: center; }
        body.dark-abyss-mode .list-item, body.dark-abyss-mode .me-profile-card, body.dark-abyss-mode .me-menu-item, body.dark-abyss-mode .chat-input-bar, body.dark-abyss-mode .modal-content, body.dark-abyss-mode .wechat-header, body.dark-abyss-mode .wechat-tabbar, body.dark-abyss-mode .chat-plus-menu, body.dark-abyss-mode .bank-card, body.dark-abyss-mode .forum-tabbar, body.dark-abyss-mode .forum-post { background-color: var(--wechat-nav-bg); backdrop-filter: blur(10px); }
        body.dark-abyss-mode .message-row.received .message-bubble.text-bubble { background-color: rgba(40, 40, 40, 0.85); }
        body.dark-abyss-mode .message-row.received .message-bubble.text-bubble::after { background: rgba(40, 40, 40, 0.85); }
        body.dark-abyss-mode .message-row.sent .message-bubble.text-bubble { background-color: rgba(0, 150, 136, 0.8); }
        body.dark-abyss-mode .message-row.sent .message-bubble.text-bubble::after { background: rgba(0, 150, 136, 0.8); }
        body.dark-abyss-mode .moment-post { margin-top: 20px; }
        body.dark-abyss-mode .moments-header-bg { height: 280px; }

        @font-face { font-family: 'UserCustomFont'; src: var(--user-custom-font-src); }
        @font-face { font-family: 'DiaryFont'; src: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756988857890_qdqqd_enpyrq.ttf'); }

        body { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #333; margin: 0; font-family: var(--user-custom-font); font-size: var(--font-size-base); overflow: hidden; }

        /* --- 手机外壳 --- */
        .phone-container { width: var(--phone-width); height: var(--phone-height); background: var(--phone-border-color); border-radius: 44px; box-shadow: var(--phone-shadow), 0 0 0 1px var(--phone-edge-highlight); display: flex; flex-direction: column; overflow: hidden; position: relative; border: var(--phone-border-width) solid var(--phone-border-color); transition: all 0.3s ease; backdrop-filter: var(--phone-backdrop-filter, none); }
        .phone-container.fullscreen { width: 100vw; height: 100vh; border-radius: 0; border: none; }
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; background-color: var(--wechat-bg); border-radius: 34px; overflow: hidden; }
        .phone-container.fullscreen .screen { border-radius: 0; }
        
        /* --- iPhone6 模式 --- */
        body.iphone6-mode .phone-container {
            padding: 80px 15px; /* 创建上下 "chin" */
            border-radius: 40px;
            background: var(--phone-border-color);
            position: relative;
        }
        body.iphone6-mode .screen {
            border-radius: 5px;
            height: 100%;
            width: 100%;
        }
        body.iphone6-mode .phone-container::before { /* 听筒 */
            content: '';
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: #444;
            border-radius: 2px;
        }
        body.iphone6-mode .phone-container::after { /* Home键 */
            content: '';
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #666;
            background: #333;
        }

        /* --- 状态栏 & 通知栏 --- */
        .status-bar { height: 30px; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; color: black; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; font-weight: 500; position: absolute; top: 0; left: 0; right: 0; z-index: 100; cursor: pointer; }
        body.dark-mode .status-bar, body.transparent-mode .status-bar, body.dark-abyss-mode .status-bar { color: white; }
        .status-bar-left { display: flex; align-items: center; gap: 8px; }
        .status-bar-right { display: flex; align-items: center; gap: 6px; }
        .status-bar .time { font-size: 14px; }
        .status-bar .network-icon i, .status-bar .network-icon span { font-size: 14px; }
        .status-bar .dnd-icon i { font-size: 12px; }
        .battery-container { position: relative; display: flex; align-items: center; gap: 4px; }
        .custom-battery-icon { width: 24px; height: 11px; background-image: var(--battery-icon-image); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .battery-icon { width: 24px; height: 11px; border: 1px solid black; border-radius: 2.5px; position: relative; display: flex; align-items: center; }
        body.dark-mode .battery-icon, body.transparent-mode .battery-icon, body.dark-abyss-mode .battery-icon { border-color: white; }
        .battery-icon::after { content: ''; width: 1.5px; height: 4px; background-color: black; border-radius: 0 1px 1px 0; position: absolute; right: -3px; top: 50%; transform: translateY(-50%); }
        body.dark-mode .battery-icon::after, body.transparent-mode .battery-icon::after, body.dark-abyss-mode .battery-icon::after { background-color: white; }
        .battery-fill { height: 100%; background-color: black; border-radius: 1.5px; }
        body.dark-mode .battery-fill, body.transparent-mode .battery-fill, body.dark-abyss-mode .battery-fill { background-color: white; }
        .battery-fill.charging, .battery-fill.low { background-color: #07C160; }
        .battery-fill.low { background-color: #FA5151; }
        .battery-percent-inside { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 9px; color: white; mix-blend-mode: difference; display: var(--battery-percent-display-inside); }
        .battery-percent-outside { font-size: 12px; display: var(--battery-percent-display-outside); }
        .notification-center { position: absolute; top: 0; left: 0; right: 0; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(15px); z-index: 1005; transform: translateY(-100%); transition: transform 0.3s ease-out; padding: 40px 10px 10px; box-sizing: border-box; overflow-y: auto; }
        .notification-center.visible { transform: translateY(0); }
        .notification-item { background: rgba(255,255,255,0.15); border-radius: 12px; padding: 10px; margin-bottom: 10px; color: white; display: flex; align-items: center; gap: 10px; }
        .notification-item .app-icon { width: 24px; height: 24px; border-radius: 6px; }
        .notification-item .content .title { font-weight: bold; font-size: 14px; }
        .notification-item .content .text { font-size: 13px; margin-top: 4px; }

        /* --- 页面 & 导航 --- */
        .page { position: absolute; inset: 0; background-color: var(--wechat-bg); display: none; flex-direction: column; z-index: 10; transform: translateX(100%); transition: transform 0.3s ease-in-out; padding-top: 30px; /* 为状态栏留出空间 */ }
        .page.active { display: flex; transform: translateX(0); }
        .page.no-transition { transition: none; }
        .page.sub-page { z-index: 20; }
        .wechat-header { height: 44px; background-color: var(--wechat-nav-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 0.5px solid var(--wechat-border-color); flex-shrink: 0; position: sticky; top: 0; z-index: 10; color: var(--global-font-color); }
        .header-title { font-size: 17px; font-weight: 600; position: absolute; left: 50%; transform: translateX(-50%); }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; font-size: 22px; cursor: pointer; color: var(--global-font-color); }
        .header-back-btn { font-size: 17px; color: var(--global-font-color); display: flex; align-items: center; gap: 2px; }
        .header-back-btn i { font-size: 20px; }
        .content-area { flex: 1; overflow-y: auto; }
        .content-area::-webkit-scrollbar { width: 4px; }
        .content-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
        .wechat-tabbar { display: flex; height: 50px; background-color: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); flex-shrink: 0; }
        .tab-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px; color: var(--wechat-text-secondary); cursor: pointer; }
        .tab-item.active { color: var(--wechat-green); }
        .tab-item i { font-size: 22px; }
        .tab-item span { font-size: 10px; }

        /* --- 锁屏 & 主屏幕 --- */
        #lock-screen-page { background-image: var(--lock-screen-wallpaper); background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 80px 20px; box-sizing: border-box; z-index: 1000; }
        .lock-screen-time-container { color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); text-align: center; }
        .lock-screen-time-container .time { font-size: 80px; font-weight: 200; }
        .lock-screen-time-container .date { font-size: 18px; font-weight: 300; margin-top: 5px; }
        .slide-to-unlock { width: 250px; height: 50px; background: rgba(0,0,0,0.3); border-radius: 25px; display: flex; align-items: center; padding: 0 5px; position: relative; overflow: hidden; cursor: pointer; }
        .slide-to-unlock-text { color: rgba(255,255,255,0.7); margin-left: 50px; font-size: 16px; }
        .slide-handle { width: 40px; height: 40px; background: white; border-radius: 50%; position: absolute; left: 5px; top: 5px; display: flex; justify-content: center; align-items: center; color: #555; font-size: 20px; }
        #password-entry-page { background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1001; }
        .password-display { display: flex; gap: 15px; margin-bottom: 40px; }
        .password-dot { width: 15px; height: 15px; border: 2px solid white; border-radius: 50%; }
        .password-dot.filled { background: white; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .numpad-btn { width: 75px; height: 75px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 30px; cursor: pointer; }
        .numpad-btn:active { background: rgba(255,255,255,0.4); }

        #home-screen-page { background-image: var(--home-screen-background-image); background-size: cover; background-position: center; }
        #home-screen-page .content-area { display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding-top: 50px; }
        .home-screen-time-container { text-align: center; color: var(--home-screen-font-color); text-shadow: 0 1px 5px rgba(0,0,0,0.3); }
        .home-screen-time-container .time { font-size: 50px; font-weight: 300; }
        .home-screen-time-container .date { font-size: 18px; font-weight: 400; margin-top: 2px; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--app-icon-gap); padding: 20px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center; }
        .app-icon .icon-bg { width: var(--app-icon-size); height: var(--app-icon-size); border-radius: var(--app-icon-radius); background-size: cover; background-position: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .app-icon .app-name { font-size: 12px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        /* --- 激活弹窗 --- */
        #activation-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px); }
        .activation-content { background: linear-gradient(135deg, #e0f7fa 0%, #fce4ec 100%); padding: 30px; border-radius: 20px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .activation-content .cake-icon { width: 80px; height: 80px; margin-bottom: 20px; }
        .activation-content h3 { margin: 0 0 15px; color: #333; }
        .activation-input { width: 100%; padding: 12px; border: 1px solid #FFB6C1; border-radius: 10px; text-align: center; font-size: 18px; text-transform: uppercase; box-sizing: border-box; }
        .activation-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; background: #FF69B4; color: white; font-size: 16px; cursor: pointer; margin-top: 20px; }

        /* --- 聊天气泡分离样式 --- */
        .message-bubble { position: relative; padding: 10px 14px; font-size: var(--font-size-base); line-height: 1.4; max-width: calc(var(--phone-width) - 120px); word-break: break-word; border-radius: 6px; user-select: none; color: var(--global-font-color); }
        /* 默认文本气泡 */
        .message-row.sent .message-bubble.text-bubble { background: #96d35f; color: #000; }
        .message-row.received .message-bubble.text-bubble { background: #ffffff; color: #000; }
        .message-row.sent .message-bubble.text-bubble::after { content: ""; position: absolute; right: -6px; top: 12px; width: 8px; height: 12px; background: #96d35f; clip-path: polygon(0 0, 100% 50%, 0 100%); }
        .message-row.received .message-bubble.text-bubble::after { content: ""; position: absolute; left: -6px; top: 12px; width: 8px; height: 12px; background: #ffffff; clip-path: polygon(100% 0, 0 50%, 100% 100%); }
        /* 图片/表情气泡 */
        .message-bubble.image-bubble, .message-bubble.sticker-bubble { padding: 0; background: transparent !important; border-radius: 8px; overflow: hidden; }
        .message-bubble.image-bubble img, .message-bubble.sticker-bubble img { max-width: 150px; border-radius: 6px; display: block; }
        .message-bubble.sticker-bubble img { max-width: 120px; }
        .message-bubble.image-bubble::after, .message-bubble.sticker-bubble::after { display: none; }
        /* 语音气泡 */
        .message-bubble.voice-bubble { display: flex; align-items: center; gap: 8px; min-width: 80px; cursor: pointer; }
        .voice-bubble-content { display: flex; align-items: center; gap: 10px; }
        .voice-bubble-content .waveform { display: flex; align-items: center; height: 20px; overflow: hidden; }
        .voice-bubble-content .bar { width: 3px; height: 4px; margin: 0 1.5px; border-radius: 2px; }
        .voice-bubble.playing .bar { animation: wave 1.2s ease-in-out infinite alternate; }
        .message-row.sent .voice-bubble-content .bar { background-color: #000; }
        .message-row.received .voice-bubble-content .bar { background-color: var(--global-font-color); }
        @keyframes wave { 0% { transform: scaleY(0.2); } 50% { transform: scaleY(1); } 100% { transform: scaleY(0.2); } }
        .voice-bubble-content .duration { font-size: 14px; }
        .message-row.sent .voice-bubble-content .duration { color: #000; }
        .message-row.received .voice-bubble-content .duration { color: var(--wechat-text-secondary); }
        /* 转账/红包气泡 */
        .transfer-bubble, .redpacket-bubble { background-color: var(--special-orange-bg); color: white; width: 230px; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; cursor: pointer; }
        .transfer-bubble .main, .redpacket-bubble .main { display: flex; align-items: center; gap: 10px; }
        .transfer-bubble .icon, .redpacket-bubble .icon { font-size: 36px; color: white; }
        .transfer-bubble .details, .redpacket-bubble .details { display: flex; flex-direction: column; flex: 1; }
        .transfer-bubble .amount, .redpacket-bubble .amount { font-size: 18px; font-weight: 500; color: white; }
        .transfer-bubble .remark, .redpacket-bubble .remark { font-size: 14px; color: white; margin-top: 2px; }
        .transfer-bubble .footer, .redpacket-bubble .footer { font-size: 12px; color: white; padding-top: 8px; margin-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.3); }
        /* 礼物气泡 */
        .gift-bubble { background-color: #fff; border: 1px solid #f0f0f0; width: 240px; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .gift-bubble .icon { font-size: 40px; color: #FFB347; }
        .gift-bubble .details { flex: 1; }
        .gift-bubble .details .name { font-size: 16px; font-weight: 500; color: var(--global-font-color); }
        .gift-bubble .details .desc { font-size: 13px; color: var(--wechat-text-secondary); margin-top: 4px; }
        body.dark-mode .gift-bubble { background-color: #2c2c2e; border-color: #3a3a3c; }
        /* 聊天记录气泡 */
        .forwarded-message-bubble { background: #fff; color: var(--global-font-color); padding: 10px 14px; border-radius: 6px; border: 0.5px solid var(--wechat-border-color); max-width: calc(var(--phone-width) - 120px); word-break: break-word; cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .forwarded-message-bubble .forward-title { font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 4px; margin-bottom: 4px; width: 100%; }
        .forwarded-message-bubble .forward-content-preview { font-size: 13px; color: var(--wechat-text-secondary); }
        body.dark-mode .forwarded-message-bubble { background: var(--wechat-nav-bg); border-color: var(--wechat-border-color); }
        body.dark-mode .forwarded-message-bubble .forward-title { border-bottom-color: var(--wechat-border-color); }
        /* 小票气泡 */
        .receipt-bubble { background-color: #fff; border: 1px solid #f0f0f0; width: 260px; border-radius: 8px; padding: 0; overflow: hidden; font-family: monospace; }
        .receipt-bubble .header { background: #333; color: white; padding: 8px 12px; font-weight: bold; display: flex; justify-content: space-between; }
        .receipt-bubble .items { padding: 12px; font-size: 13px; line-height: 1.6; border-bottom: 1px dashed #ccc; }
        .receipt-bubble .item-row { display: flex; justify-content: space-between; }
        .receipt-bubble .total { padding: 10px 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .receipt-bubble .footer { font-size: 12px; color: #999; text-align: center; padding: 8px; background: #fafafa; }
        body.dark-mode .receipt-bubble { background-color: #2c2c2e; border-color: #3a3a3c; }
        body.dark-mode .receipt-bubble .header { background: #111; }
        body.dark-mode .receipt-bubble .footer { background: #222; }
        /* 其他通用样式 */
        .list-item { display: flex; align-items: center; padding: 10px 15px; gap: 12px; border-bottom: 0.5px solid var(--wechat-border-color); cursor: pointer; position: relative; background-color: var(--wechat-nav-bg); }
        .list-item:active { background-color: var(--wechat-bg); }
        .list-item .avatar { width: 48px; height: 48px; border-radius: var(--avatar-shape); object-fit: cover; }
        .list-item .details { flex: 1; overflow: hidden; }
        .list-item .details .name { font-size: var(--font-size-base); color: var(--global-font-color); display: flex; align-items: center; gap: 5px; }
        .list-item .details .name .fa-star { color: #FFC300; font-size: 12px; }
        .list-item .details .subtext { font-size: calc(var(--font-size-base) - 2px); color: var(--wechat-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .info { text-align: right; font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); }
        .list-divider { height: 8px; background-color: var(--wechat-bg); }
        .list-item .chevron { position: absolute; right: 15px; color: var(--wechat-text-secondary); }
        .list-item.pinned { background-color: #F5F5F5; }
        body.dark-mode .list-item.pinned { background-color: #2A2A2A; }
        #me-page .content-area { padding-top: 20px; }
        .me-profile-card { display: flex; align-items: center; gap: 20px; padding: 40px 20px 30px; background-color: var(--wechat-nav-bg); cursor: pointer; }
        .me-profile-card .avatar { width: 64px; height: 64px; border-radius: var(--avatar-shape); }
        .me-profile-card .details { flex: 1; }
        .me-profile-card .details .name { font-size: calc(var(--font-size-base) + 7px); font-weight: 600; margin-bottom: 5px; color: var(--global-font-color); }
        .me-profile-card .details .wxid { color: var(--wechat-text-secondary); font-size: var(--font-size-base); }
        .me-profile-card .details .signature { font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); margin-top: 5px; }
        .me-profile-card .qr-code { font-size: 20px; color: var(--wechat-text-secondary); }
        .me-menu-item { padding: 15px 20px; display: flex; align-items: center; gap: 20px; background-color: var(--wechat-nav-bg); cursor: pointer; }
        .me-menu-item:active { background-color: var(--wechat-bg); }
        .me-menu-item i { font-size: 24px; color: var(--wechat-blue); width: 24px; text-align: center; }
        .me-menu-item span { flex: 1; font-size: var(--font-size-base); color: var(--global-font-color); }
        #conversation-page .content-area { background-color: var(--wechat-bg); padding: 10px; display: flex; flex-direction: column; background-image: var(--chat-background-image); background-size: cover; background-position: center; position: relative; }
        .message-row { display: flex; flex-direction: column; margin-bottom: 5px; max-width: 100%; }
        .message-timestamp { text-align: center; color: var(--wechat-text-secondary); font-size: calc(var(--font-size-base) - 3px); margin: 10px 0; }
        .message-recalled, .message-system { text-align: center; color: var(--wechat-text-secondary); font-size: calc(var(--font-size-base) - 3px); margin: 10px 0; background: rgba(0,0,0,0.1); padding: 4px 8px; border-radius: 4px; display: inline-block; align-self: center; }
        .message-body { display: flex; align-items: flex-start; gap: 10px; }
        .message-row.sent { align-items: flex-end; }
        .message-row.sent .message-body { flex-direction: row-reverse; }
        .message-avatar-wrapper { position: relative; flex-shrink: 0; }
        .message-avatar { width: 40px; height: 40px; border-radius: var(--avatar-shape); cursor: pointer; }
        .avatar-frame { position: absolute; top: -5px; left: -5px; width: 50px; height: 50px; background-size: contain; background-repeat: no-repeat; pointer-events: none; }
        .message-row.sent .avatar-frame { background-image: var(--user-avatar-frame); }
        .message-row.received .avatar-frame { background-image: var(--char-avatar-frame); }
        .message-content-wrapper { display: flex; flex-direction: column; }
        .message-row.sent .message-content-wrapper { align-items: flex-end; }
        .message-row.received .message-content-wrapper { align-items: flex-start; }
        .message-bubble .quoted-message { background: rgba(0,0,0,0.05); padding: 5px 8px; border-radius: 4px; margin-bottom: 5px; border-left: 2px solid #ccc; font-size: calc(var(--font-size-base) - 2px); color: var(--wechat-text-secondary); }
        body.dark-mode .message-bubble .quoted-message { background: rgba(255,255,255,0.1); border-left-color: #555; }
        .message-bubble .quoted-message p { margin: 0; }
        .message-bubble.camera-sim-bubble { background: #fff; padding: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
        .camera-sim-bubble .sim-icon { width: 30px; height: 30px; object-fit: contain; }
        .camera-sim-bubble .sim-text { font-size: 14px; color: #888; }
        .message-bubble.location-bubble { background: #fff; padding: 0; display: flex; flex-direction: column; border: 0.5px solid #eee; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); width: 250px; overflow: hidden; }
        .location-bubble .location-text-wrapper { padding: 10px; }
        .location-bubble .location-text { font-size: var(--font-size-base); color: var(--global-font-color); word-break: break-all; }
        .location-bubble .map-placeholder { height: 100px; width: 100%; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; color: #aaa; font-size: 40px; }
        .couple-invitation-bubble { background-color: #fff; border: 1px solid #f0f0f0; width: 250px; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .couple-invitation-bubble .icon { font-size: 36px; color: #FF69B4; }
        .couple-invitation-bubble .text { font-size: 15px; color: var(--global-font-color); text-align: center; }
        .couple-invitation-bubble .actions { display: flex; gap: 15px; margin-top: 10px; }
        .couple-invitation-bubble .actions button { padding: 8px 20px; border-radius: 6px; border: 1px solid var(--wechat-border-color); cursor: pointer; }
        .couple-invitation-bubble .actions .accept-btn { background: var(--wechat-green); color: white; }
        body.dark-mode .couple-invitation-bubble { background-color:#2c2c2e; border-color: #3a3a3c; }
        .translated-text-bubble, .voice-transcribed-bubble { background: var(--wechat-nav-bg); color: var(--global-font-color); padding: 10px 14px; border-radius: 6px; margin-top: 5px; font-size: calc(var(--font-size-base) - 1px); border: 0.5px solid var(--wechat-border-color); max-width: calc(var(--phone-width) - 120px); word-break: break-word; position: relative; cursor: pointer; }
        .translated-text-bubble::before { content: '[译文]'; font-weight: bold; color: var(--wechat-blue); margin-right: 5px; }
        .music-bubble { background: #fff; color: var(--global-font-color); padding: 10px 14px; border-radius: 6px; border: 0.5px solid var(--wechat-border-color); max-width: calc(var(--phone-width) - 120px); word-break: break-word; cursor: pointer; }
        body.dark-mode .music-bubble { background: var(--wechat-nav-bg); border-color: var(--wechat-border-color); }
        .music-bubble { display: flex; align-items: center; gap: 10px; }
        .music-bubble img { width: 40px; height: 40px; border-radius: 4px; }
        .music-bubble .details { flex: 1; }
        .music-bubble .details .title { font-weight: 500; }
        .music-bubble .details .artist { font-size: 12px; color: var(--wechat-text-secondary); }
        .html-content-bubble { padding: 5px; background: #fff; }
        .html-content-iframe { width: 260px; height: 560px; border: none; resize: both; overflow: auto; }
        .message-timestamp-under { font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); margin-top: 4px; }
        .message-timestamp-inside { font-size: 10px; opacity: 0.7; margin-top: 5px; color: inherit; }
        .message-row.sent .message-bubble .message-timestamp-inside { color: #000; }
        .chat-input-bar { display: flex; align-items: center; padding: 8px 10px; gap: 10px; background: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); }
        .chat-input-bar input { flex: 1; padding: 8px 12px; border: none; background: var(--wechat-bg); border-radius: 6px; font-size: var(--font-size-base); color: var(--global-font-color); }
        .chat-input-bar i { font-size: 28px; cursor: pointer; color: var(--wechat-text-secondary); }
        .chat-plus-menu { position: absolute; bottom: 50px; left: 0; right: 0; background: var(--wechat-bg); display: none; grid-template-columns: repeat(4, 1fr); padding: 20px; gap: 20px; z-index: 10; border-top: 0.5px solid var(--wechat-border-color); }
        .plus-menu-item { display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); cursor: pointer; }
        .plus-menu-item .icon { width: 56px; height: 56px; background: var(--wechat-nav-bg); border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 28px; color: var(--wechat-text-secondary); border: 0.5px solid var(--wechat-border-color); }
        .message-context-menu { position: fixed; background: #4c4c4c; color: white; border-radius: 8px; padding: 5px; display: none; z-index: 1100; }
        .context-menu-item { padding: 8px 15px; cursor: pointer; white-space: nowrap; position: relative; font-size: var(--font-size-base); }
        .context-menu-item:hover { background: #666; }
        .context-submenu { display: none; position: absolute; left: 100%; top: 0; background: #4c4c4c; border-radius: 8px; padding: 5px; }
        .context-menu-item:hover .context-submenu { display: block; }
        .multi-select-toolbar { position: fixed; bottom: 0; left: 0; right: 0; height: 50px; background: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); display: none; justify-content: space-around; align-items: center; z-index: 1002; }
        .multi-select-toolbar.active { display: flex; }
        .multi-select-toolbar button { background: none; border: none; font-size: 16px; color: var(--global-font-color); cursor: pointer; }
        .multi-select-toolbar button:disabled { color: var(--wechat-text-secondary); cursor: not-allowed; }
        .message-row.multi-select-mode .message-body::before { content: ''; display: block; width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 50%; margin-right: 10px; align-self: center; flex-shrink: 0; }
        .message-row.multi-select-mode.selected .message-body::before { background-color: var(--wechat-green); border-color: var(--wechat-green); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='white' d='M12.207 4.793a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L6.5 9.086l4.293-4.293a1 1 0 0 1 1.414 0z'/%3e%3c/svg%3e"); background-position: center; background-repeat: no-repeat; }
        .message-row.sent.multi-select-mode .message-body { flex-direction: row; }
        .message-row.sent.multi-select-mode .message-body::before { margin-left: 10px; margin-right: 0; order: 2; }
        .message-row.sent.multi-select-mode .message-body .message-avatar-wrapper { order: 3; }
        .message-row.sent.multi-select-mode .message-body .message-content-wrapper { order: 1; }
        .form-page .content-area { padding: 15px; background-color: var(--wechat-bg); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 8px; font-size: var(--font-size-base); box-sizing: border-box; background: var(--wechat-nav-bg); color: var(--global-font-color); }
        .form-group textarea { min-height: 200px; resize: vertical; }
        .form-btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 17px; font-weight: 500; cursor: pointer; background-color: var(--wechat-green); color: white; text-align: center; margin-top: 20px; }
        .file-input { display: none; }
        .avatar-upload-preview { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; cursor: pointer; display: block; margin: 0 auto 20px; border: 1px solid var(--wechat-border-color); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--wechat-nav-bg); padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color: var(--global-font-color); }
        .modal-title { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .modal-input-group { margin-bottom: 15px; }
        .modal-input-group label { font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; box-sizing: border-box; font-size: var(--font-size-base); background: var(--wechat-bg); color: var(--global-font-color); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--wechat-border-color); background: var(--wechat-bg); cursor: pointer; font-size: var(--font-size-base); color: var(--global-font-color); }
        .modal-btn.primary { background: var(--wechat-green); color: #fff; border-color: var(--wechat-green); }
        #wallet-page .content-area { background-color: var(--wechat-bg); padding: 0; }
        .wallet-header { background-color: #63B466; color: white; padding: 30px 20px; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        body.dark-mode .wallet-header { background-color: #2E7D32; }
        .wallet-balance-title { font-size: calc(var(--font-size-base) - 1px); opacity: 0.8; display: flex; align-items: center; gap: 10px; }
        .wallet-balance-title .currency-switcher { cursor: pointer; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }
        .wallet-balance { font-size: calc(var(--font-size-base) + 25px); font-weight: bold; margin: 10px 0; word-break: break-all; }
        .wallet-services-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background-color: var(--wechat-border-color); margin: 20px; border-radius: 8px; overflow: hidden; }
        .wallet-service-item { background-color: var(--wechat-nav-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; cursor: pointer; gap: 8px; }
        .wallet-service-item:active { background-color: var(--wechat-bg); }
        .wallet-service-item i { font-size: 28px; color: var(--wechat-green); }
        .wallet-service-item p { margin: 0; font-size: calc(var(--font-size-base) - 1px); color: var(--global-font-color); }
        #sticker-page .content-area { padding: 10px; }
        .sticker-pack { margin-bottom: 15px; }
        .sticker-pack-title { font-weight: bold; margin-bottom: 10px; padding: 0 5px; color: var(--global-font-color); }
        .sticker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .sticker-item { background: transparent; border-radius: 8px; padding: 5px; cursor: pointer; display: flex; justify-content: center; align-items: center; aspect-ratio: 1 / 1; }
        .sticker-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #moments-page .content-area { background-color: var(--wechat-bg); padding-top: 0; }
        .moments-header-bg { height: 300px; background-size: cover; background-position: center; position: relative; cursor: pointer; }
        .moments-user-info { position: absolute; bottom: -20px; right: 20px; display: flex; align-items: center; gap: 15px; }
        .moments-user-info .name { color: white; font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        .moments-user-info .avatar { width: 70px; height: 70px; border-radius: var(--avatar-shape); border: 2px solid white; }
        .moments-signature { position: absolute; bottom: -45px; right: 105px; color: #ccc; font-size: 14px; text-shadow: 1px 1px 2px #000; max-width: 200px; text-align: right; }
        .moment-post { padding: 15px; border-bottom: 8px solid var(--wechat-bg); display: flex; gap: 10px; margin-top: 40px; background-color: var(--wechat-nav-bg); }
        .moment-post .avatar { width: 42px; height: 42px; border-radius: var(--avatar-shape); flex-shrink: 0; }
        .moment-post .post-content { flex: 1; }
        .moment-post .post-author { color: var(--wechat-blue); font-weight: 600; font-size: var(--font-size-base); }
        .moment-post .post-text { margin: 5px 0; font-size: var(--font-size-base); line-height: 1.5; white-space: pre-wrap; word-break: break-word; color: var(--global-font-color); }
        .moment-post .post-media { margin-top: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .moment-post .post-media img, .moment-post .post-media video { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; }
        .moment-post .post-media audio { width: 100%; margin-top: 5px; }
        .moment-post .post-meta { display: flex; justify-content: space-between; align-items: center; color: var(--wechat-text-secondary); font-size: calc(var(--font-size-base) - 2px); margin-top: 10px; }
        .moment-post .post-actions i { font-size: 20px; cursor: pointer; margin-left: 15px; }
        .moment-post .post-interactions { background: var(--wechat-bg); margin-top: 8px; border-radius: 4px; font-size: calc(var(--font-size-base) - 1px); }
        .moment-post .post-likes { padding: 8px 12px; border-bottom: 1px solid var(--wechat-border-color); color: var(--wechat-blue); }
        .moment-post .post-likes i { margin-right: 5px; }
        .moment-post .post-comments { padding: 8px 12px; }
        .moment-comment { margin-bottom: 3px; color: var(--global-font-color); cursor: pointer; }
        .moment-comment .comment-author { color: var(--wechat-blue); font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--wechat-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        #create-group-chat-page .selected-contacts-preview { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border-bottom: 1px solid var(--wechat-border-color); }
        #create-group-chat-page .selected-contacts-preview .avatar { width: 40px; height: 40px; border-radius: var(--avatar-shape); }
        #create-group-chat-page .contact-selection-list .list-item { padding: 8px 15px; }
        #create-group-chat-page .contact-selection-list .list-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; }
        #create-group-chat-page .contact-selection-list .list-item .details { flex: 1; }
        #create-group-chat-page .contact-selection-list .list-item .details .name { font-size: var(--font-size-base); }
        #create-group-chat-page .contact-selection-list .list-item .avatar { width: 36px; height: 36px; }
        #group-member-management-page .group-member-list .list-item { justify-content: space-between; }
        #group-member-management-page .group-member-list .list-item .member-actions button { padding: 5px 10px; border: 1px solid var(--wechat-border-color); border-radius: 4px; background: var(--wechat-bg); cursor: pointer; color: var(--global-font-color); }
        #music-player-page .content-area { display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #222; color: white; padding: 20px; text-align: center; background-image: var(--player-background); background-size: cover; background-position: center; position: relative; }
        #music-player-page .content-area::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        #music-player-page .content-area > * { z-index: 1; }
        .music-cover { width: 250px; height: 250px; border-radius: 50%; margin-bottom: 20px; animation: rotate 20s linear infinite; animation-play-state: paused; background-image: var(--player-image); background-size: cover; background-position: center; border: 5px solid rgba(255,255,255,0.1); }
        .music-cover.playing { animation-play-state: running; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .music-info h3 { margin: 10px 0 5px; font-size: calc(var(--font-size-base) + 5px); }
        .music-info p { margin: 0; font-size: calc(var(--font-size-base) - 1px); color: #aaa; }
        .music-controls { display: flex; gap: 30px; margin-top: 30px; align-items: center; }
        .music-controls i { font-size: 36px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .music-controls i:hover { opacity: 1; }
        .music-controls .fa-play-circle, .music-controls .fa-pause-circle { font-size: 50px; }
        .music-progress { width: 80%; height: 4px; background: #555; margin-top: 20px; position: relative; border-radius: 2px; }
        .music-progress-bar { height: 100%; width: 0%; background: var(--wechat-green); border-radius: 2px; }
        .music-mode-toggle { font-size: 20px; margin-top: 20px; cursor: pointer; }
        #diary-page .content-area { background-image: url('https://img.heliar.top/file/1764077275005_Screenshot_2025_1125_181250.png'); background-size: cover; padding: 25px; font-family: 'DiaryFont', serif; color: #3a2e28; line-height: 1.8; font-size: 17px; white-space: pre-wrap; }
        .delivery-search-bar { padding: 10px; }
        .delivery-search-bar input { width: 100%; padding: 10px; border-radius: 20px; border: 1px solid var(--wechat-border-color); box-sizing: border-box; }
        .food-list, .gift-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        .food-item { display: flex; flex-direction: column; background: var(--wechat-nav-bg); border-radius: 8px; overflow: hidden; cursor: pointer; }
        .food-item img { width: 100%; height: 100px; object-fit: cover; }
        .food-item .info { padding: 10px; flex: 1; display: flex; flex-direction: column; }
        .food-item .name { font-weight: 500; flex: 1; }
        .food-item .price { color: var(--wechat-red); font-weight: bold; margin-top: 5px; }
        .food-item .add-btn { background: var(--wechat-green); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; cursor: pointer; align-self: flex-end; }
        .bottom-nav { display: flex; border-top: 1px solid var(--wechat-border-color); background: var(--wechat-nav-bg); }
        .bottom-nav .nav-item { flex: 1; text-align: center; padding: 8px 0; cursor: pointer; color: var(--wechat-text-secondary); }
        .bottom-nav .nav-item.active { color: var(--wechat-green); }
        .bottom-nav .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        .bottom-nav .nav-item span { font-size: 10px; }
        .order-list { padding: 10px; }
        .order-item { background: var(--wechat-nav-bg); border-radius: 8px; margin-bottom: 10px; }
        .order-item .header { padding: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--wechat-border-color); }
        .order-item .body { padding: 10px; font-family: monospace; font-size: 12px; }
        .order-item .footer { padding: 10px; text-align: right; font-weight: bold; }
        #voice-call-page { background-color: #333; color: white; z-index: 500; }
        .voice-call-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background-size: cover; background-position: center; }
        .voice-call-container::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); }
        .voice-call-container > * { z-index: 1; }
        .voice-call-header { text-align: center; margin-bottom: 30px; }
        .voice-call-header .avatar { width: 100px; height: 100px; border-radius: var(--avatar-shape); margin-bottom: 15px; }
        .voice-call-header .name { font-size: 24px; font-weight: 500; }
        .voice-call-status { font-size: 16px; color: #ccc; margin-top: 10px; }
        .voice-call-chat-area { width: 90%; height: 200px; overflow-y: auto; margin-bottom: 20px; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); font-size: 14px; line-height: 1.6; }
        .voice-call-chat-area p { margin: 0 0 5px; }
        .voice-call-input-bar { width: 90%; display: flex; gap: 10px; }
        .voice-call-input-bar input { flex: 1; padding: 12px; border-radius: 20px; border: none; background: rgba(255,255,255,0.2); color: white; }
        .voice-call-controls { position: absolute; bottom: 40px; display: flex; gap: 40px; }
        .voice-call-controls .control-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .voice-call-controls .icon-wrapper { width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; }
        .voice-call-controls .hangup { background: var(--wechat-red); }
        .voice-call-controls .minimize { background: rgba(255,255,255,0.2); }
        .minimized-call-window { position: fixed; top: 60px; right: 15px; width: 210px; height: 130px; background: #333; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1001; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; color: white; cursor: pointer; padding: 10px; box-sizing: border-box; }
        .minimized-call-window .avatar { width: 40px; height: 40px; border-radius: 50%; }
        .minimized-call-window .status { font-size: 12px; }
        .bank-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 20px; margin: 15px; position: relative; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .bank-card .bank-name { font-size: 18px; font-weight: bold; }
        .bank-card .card-number { font-family: monospace; font-size: 20px; margin: 20px 0; letter-spacing: 2px; }
        .bank-card .card-balance { font-size: 16px; }
        .add-card-btn { border: 2px dashed var(--wechat-border-color); color: var(--wechat-text-secondary); text-align: center; padding: 40px 20px; margin: 15px; border-radius: 12px; cursor: pointer; }
        
        /* --- 论坛APP样式 --- */
        .forum-tabbar { display: flex; height: 50px; background-color: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); flex-shrink: 0; }
        .forum-tab-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px; color: var(--wechat-text-secondary); cursor: pointer; }
        .forum-tab-item.active { color: var(--wechat-green); }
        .forum-tab-item i { font-size: 22px; }
        .forum-tab-item span { font-size: 10px; }
        #forum-home-page .content-area, #forum-following-page .content-area { position: relative; }
        .create-post-fab { position: absolute; bottom: 70px; right: 20px; width: 56px; height: 56px; background-color: var(--wechat-green); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 50; }
        .forum-post { background-color: var(--wechat-nav-bg); padding: 15px; border-bottom: 1px solid var(--wechat-border-color); cursor: pointer; }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .post-header .avatar { width: 40px; height: 40px; border-radius: var(--avatar-shape); }
        .post-header .author-info .name { font-weight: 600; color: var(--global-font-color); }
        .post-header .author-info .timestamp { font-size: 12px; color: var(--wechat-text-secondary); }
        .post-content-preview { font-size: var(--font-size-base); line-height: 1.5; color: var(--global-font-color); max-height: 120px; overflow: hidden; text-overflow: ellipsis; white-space: pre-wrap; word-break: break-word; }
        .post-footer { display: flex; justify-content: space-around; align-items: center; margin-top: 15px; color: var(--wechat-text-secondary); font-size: 14px; }
        .post-footer .action { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .post-footer .action.liked { color: var(--wechat-red); }
        .post-footer .action.bookmarked { color: var(--wechat-blue); }
        #forum-profile-page .profile-header { padding: 20px; text-align: center; background-color: var(--wechat-nav-bg); }
        #forum-profile-page .profile-header .avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 10px; }
        #forum-profile-page .profile-header .name { font-size: 20px; font-weight: bold; }
        #forum-profile-page .profile-header .bio { font-size: 14px; color: var(--wechat-text-secondary); margin: 5px 0 15px; }
        #forum-profile-page .profile-stats { display: flex; justify-content: center; gap: 30px; }
        #forum-profile-page .profile-stats .stat { text-align: center; }
        #forum-profile-page .profile-stats .stat .count { font-size: 18px; font-weight: bold; }
        #forum-profile-page .profile-stats .stat .label { font-size: 12px; color: var(--wechat-text-secondary); }
        #forum-profile-page .profile-actions { padding: 15px; display: flex; gap: 10px; }
        #forum-profile-page .profile-actions .form-btn { margin: 0; flex: 1; }
        .couple-badge { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; margin-left: 5px; }

        /* 加载动画 */
        .loader-container { display: flex; justify-content: center; align-items: center; padding: 50px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--wechat-green); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- 激活弹窗 -->
    <div id="activation-modal">
        <div class="activation-content">
            <img src="https://img.js.design/assets/img/6654764b736e49989d348888.png" alt="Cake Icon" class="cake-icon">
            <h3>激活 Lovely Phone</h3>
            <input type="text" id="activation-input" class="activation-input" placeholder="请输入激活码">
            <button class="activation-btn" id="activation-btn">激活</button>
        </div>
    </div>

    <div class="phone-container" id="phone-body" style="display: none;">
        <div class="screen">
            <!-- 状态栏 -->
            <div class="status-bar" id="status-bar">
                <div class="status-bar-left">
                    <span class="time" id="status-bar-time">09:41</span>
                </div>
                <div class="status-bar-right">
                    <span class="dnd-icon" id="status-bar-dnd"><i class="fas fa-moon"></i></span>
                    <span class="network-icon" id="status-bar-network"><i class="fas fa-wifi"></i></span>
                    <div class="battery-container">
                        <div class="custom-battery-icon" id="custom-battery-icon"></div>
                        <div class="battery-icon" id="default-battery-icon">
                            <div class="battery-fill" id="battery-fill"></div>
                            <span class="battery-percent-inside" id="battery-percent-inside">100</span>
                        </div>
                        <span class="battery-percent-outside" id="battery-percent-outside">100%</span>
                    </div>
                </div>
            </div>

            <!-- 通知中心 -->
            <div class="notification-center" id="notification-center">
                <div id="notification-list"></div>
            </div>

            <!-- 锁屏页面 -->
            <div id="lock-screen-page" class="page no-transition">
                <div class="lock-screen-time-container">
                    <div class="time" id="lock-screen-clock">09:41</div>
                    <div class="date" id="lock-screen-date">2025年1月1日 星期一</div>
                </div>
                <div class="slide-to-unlock" id="slide-to-unlock-bar">
                    <div class="slide-handle" id="slide-handle"><i class="fas fa-chevron-right"></i></div>
                    <span class="slide-to-unlock-text">向右滑动来解锁</span>
                </div>
            </div>

            <!-- 密码输入页面 -->
            <div id="password-entry-page" class="page no-transition">
                <div class="password-display" id="password-display">
                    <div class="password-dot"></div>
                    <div class="password-dot"></div>
                    <div class="password-dot"></div>
                    <div class="password-dot"></div>
                </div>
                <div class="numpad" id="numpad"></div>
            </div>

            <!-- 主屏幕 -->
            <div id="home-screen-page" class="page no-transition">
                <div class="content-area">
                    <div class="home-screen-time-container">
                        <div class="time" id="home-screen-time">09:41</div>
                        <div class="date" id="home-screen-date">2025年1月1日 星期一</div>
                    </div>
                    <div class="app-grid" id="app-grid"></div>
                </div>
            </div>

            <!-- WeChat App 容器 -->
            <div id="wechat-app-page" class="page sub-page">
                <div class="wechat-header" id="main-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">微信</span>
                    <div class="header-right">
                        <i class="fas fa-plus-circle" id="main-plus-btn"></i>
                    </div>
                </div>
                <div class="content-area" id="main-content-area"></div>
                <div class="wechat-tabbar">
                    <div class="tab-item active" data-page="chat-list">
                        <i class="fas fa-comment-dots"></i>
                        <span>聊天</span>
                    </div>
                    <div class="tab-item" data-page="contacts">
                        <i class="fas fa-address-book"></i>
                        <span>通讯录</span>
                    </div>
                    <div class="tab-item" data-page="me">
                        <i class="fas fa-user"></i>
                        <span>我</span>
                    </div>
                </div>
            </div>
            
            <!-- Forum App 容器 -->
            <div id="forum-app-page" class="page sub-page">
                <div class="wechat-header" id="forum-main-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">论坛</span>
                    <div class="header-right" id="forum-header-right"></div>
                </div>
                <div class="content-area" id="forum-main-content-area"></div>
                <div class="forum-tabbar">
                    <div class="forum-tab-item active" data-page="forum-home">
                        <i class="fas fa-home"></i>
                        <span>首页</span>
                    </div>
                    <div class="forum-tab-item" data-page="forum-following">
                        <i class="fas fa-heart"></i>
                        <span>关注</span>
                    </div>
                    <div class="forum-tab-item" data-page="forum-me">
                        <i class="fas fa-user-circle"></i>
                        <span>我</span>
                    </div>
                </div>
            </div>

            <!-- 其他页面容器 -->
            <div id="conversation-page" class="page sub-page"></div>
            <div id="editor-page" class="page sub-page form-page"></div>
            <div id="wallet-page" class="page sub-page"></div>
            <div id="transactions-page" class="page sub-page"></div>
            <div id="settings-app-page" class="page sub-page"></div>
            <div id="worldbook-app-page" class="page sub-page"></div>
            <div id="beautify-page" class="page sub-page"></div>
            <div id="frame-settings-page" class="page sub-page"></div>
            <div id="bubble-settings-page" class="page sub-page form-page"></div>
            <div id="redpacket-bubble-settings-page" class="page sub-page form-page"></div>
            <div id="transfer-bubble-settings-page" class="page sub-page form-page"></div>
            <div id="api-settings-page" class="page sub-page form-page"></div>
            <div id="sticker-page" class="page sub-page"></div>
            <div id="moments-page" class="page sub-page"></div>
            <div id="create-moment-page" class="page sub-page form-page"></div>
            <div id="chat-settings-page" class="page sub-page"></div>
            <div id="blacklist-page" class="page sub-page"></div>
            <div id="data-management-page" class="page sub-page"></div>
            <div id="create-group-chat-page" class="page sub-page"></div>
            <div id="group-chat-settings-page" class="page sub-page"></div>
            <div id="group-member-management-page" class="page sub-page"></div>
            <div id="music-player-page" class="page sub-page"></div>
            <div id="music-library-page" class="page sub-page"></div>
            <div id="music-settings-page" class="page sub-page"></div>
            <div id="player-beautify-page" class="page sub-page"></div>
            <div id="chat-mode-page" class="page sub-page"></div>
            <div id="font-settings-page" class="page sub-page form-page"></div>
            <div id="timestamp-settings-page" class="page sub-page"></div>
            <div id="background-interaction-page" class="page sub-page"></div>
            <div id="theme-settings-page" class="page sub-page"></div>
            <div id="phone-frame-settings-page" class="page sub-page"></div>
            <div id="avatar-shape-settings-page" class="page sub-page"></div>
            <div id="screen-size-settings-page" class="page sub-page form-page"></div>
            <div id="long-term-memory-page" class="page sub-page"></div>
            <div id="poke-settings-page" class="page sub-page form-page"></div>
            <div id="diary-page" class="page sub-page"></div>
            <div id="self-persona-list-page" class="page sub-page"></div>
            <div id="self-persona-editor-page" class="page sub-page form-page"></div>
            <div id="language-settings-page" class="page sub-page"></div>
            <div id="storage-settings-page" class="page sub-page"></div>
            <div id="notification-settings-page" class="page sub-page form-page"></div>
            <div id="voice-call-page" class="page sub-page"></div>
            <div id="global-theme-editor-page" class="page sub-page form-page"></div>
            <div id="bank-card-page" class="page sub-page"></div>
            <div id="char-balance-page" class="page sub-page"></div>
            <div id="app-icon-settings-page" class="page sub-page form-page"></div>
            <div id="wallpaper-settings-page" class="page sub-page form-page"></div>
            <div id="app-layout-settings-page" class="page sub-page form-page"></div>
            <div id="lock-screen-settings-page" class="page sub-page form-page"></div>
            <div id="font-color-settings-page" class="page sub-page form-page"></div>
            <div id="battery-settings-page" class="page sub-page form-page"></div>
            <div id="display-settings-page" class="page sub-page"></div>
            <!-- Forum App Pages -->
            <div id="forum-create-post-page" class="page sub-page form-page"></div>
            <div id="forum-post-detail-page" class="page sub-page"></div>
            <div id="forum-profile-page" class="page sub-page"></div>
            <div id="forum-profile-editor-page" class="page sub-page form-page"></div>

            <!-- 模态框容器 -->
            <div id="modal-container"></div>
            
            <!-- 消息上下文菜单 -->
            <div class="message-context-menu" id="message-context-menu"></div>

            <!-- 最小化通话窗口容器 -->
            <div id="minimized-call-container"></div>
        </div>
    </div>

    <!-- 提示音播放器 -->
    <audio id="send-sound-player"></audio>
    <audio id="receive-sound-player"></audio>
    <audio id="ringtone-player" loop></audio>

    <style id="user-bubble-style"></style>
    <style id="user-redpacket-bubble-style"></style>
    <style id="user-transfer-bubble-style"></style>
    <style id="default-font-style">
        @font-face {
            font-family: 'UserCustomFont';
            src: url('https://static.zeoseven.com/zsft/256/main/result.css');
        }
    </style>

    <script>
        // ========== 通用数据管理器 (IndexedDB) ==========
        class UniversalDataManager {
            constructor(dbName = 'WeChatSimulatorDB_v24', storeName = 'appDataStore') { // Version bump
                this.dbName = dbName;
                this.storeName = storeName;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onerror = (event) => reject(`IndexedDB error: ${event.target.errorCode}`);
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                });
            }

            async saveData(key, data) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put(data, key);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(`Save data error: ${event.target.error}`);
                });
            }

            async loadData(key) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(`Load data error: ${event.target.error}`);
                });
            }

            async exportAllData() {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get('appData');
                    request.onsuccess = () => resolve({ appData: request.result });
                    request.onerror = (event) => reject(`Export data error: ${event.target.error}`);
                });
            }

            async importFromBackup(backupData) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const clearRequest = store.clear();
                    clearRequest.onsuccess = () => {
                        const addRequest = store.add(backupData.appData, 'appData');
                        addRequest.onsuccess = () => resolve();
                        addRequest.onerror = (event) => reject(`Import (add) error: ${event.target.error}`);
                    };
                    clearRequest.onerror = (event) => reject(`Import (clear) error: ${event.target.error}`);
                });
            }
            
            async clearAllData() {
                return new Promise((resolve, reject) => {
                    const deleteRequest = indexedDB.deleteDatabase(this.dbName);
                    deleteRequest.onsuccess = () => resolve('本地数据已成功清理。');
                    deleteRequest.onerror = (event) => reject(`清理本地数据失败: ${event.target.error}`);
                    deleteRequest.onblocked = () => reject('清理被阻塞，请关闭其他页面后重试。');
                });
            }
        }

        const dataManager = new UniversalDataManager();
        let appData;
        const DATA_KEY = 'appData';

        const exchangeRates = {
            'CNY': { rate: 1, name: '人民币' }, 'USD': { rate: 0.14, name: '美元' }, 'JPY': { rate: 21.7, name: '日元' },
            'EUR': { rate: 0.13, name: '欧元' }, 'GBP': { rate: 0.11, name: '英镑' }, 'AUD': { rate: 0.21, name: '澳元' },
            'CAD': { rate: 0.19, name: '加元' }, 'CHF': { rate: 0.13, name: '瑞士法郎' }, 'HKD': { rate: 1.09, name: '港元' },
            'SGD': { rate: 0.19, name: '新加坡元' }, 'KRW': { rate: 190.5, name: '韩元' }, 'NZD': { rate: 0.23, name: '新西兰元' }
        };

        const defaultAppData = {
            user: {
                id: 'user', nickname: " ", avatar: "https://img.js.design/assets/img/6638e4537cf422dc287d398d.jpg",
                wxid: " ", address: " ", signature: " ",
                moments_bg: "https://source.unsplash.com/random/800x600?sky",
                wallet: { balance: 100000, transactions: [], currency: 'CNY' },
                personas: [],
                bankCards: [],
                forumProfile: {
                    bio: '这个人很懒，什么都没留下。',
                    followers: 0,
                    following: []
                }
            },
            contacts: [], groups: [], moments: [],
            stickers: { packs: [] },
            worldbooks: { presets: [], styles: [], library: [], forum: [] },
            forum: {
                posts: [],
                activeChat: { id: null, type: null }
            },
            notifications: [],
            settings: {
                api: { 
                    provider: 'openai', endpoint: '', key: '', model: '', 
                    temperature: 0.65, top_p: 1.0, repetition_penalty: 0.69,
                    presets: [] 
                },
                beautify: {
                    phoneFrame: 'black', theme: 'normal', chatBackground: '',
                    userAvatarFrame: '', charAvatarFrame: '', avatarShape: 'rounded',
                    bubbleCss: `/* --- 经典微信气泡样式  --- */\n.message-row.sent .message-bubble.text-bubble { background: #96d35f; color: #000; }\n.message-row.received .message-bubble.text-bubble { background: #ffffff; color: #000; }\n.message-row.sent .message-bubble.text-bubble::after { content: ""; position: absolute; right: -6px; top: 12px; width: 8px; height: 12px; background: #96d35f; clip-path: polygon(0 0, 100% 50%, 0 100%); }\n.message-row.received .message-bubble.text-bubble::after { content: ""; position: absolute; left: -6px; top: 12px; width: 8px; height: 12px; background: #ffffff; clip-path: polygon(100% 0, 0 50%, 100% 100%); }`,
                    redPacketBubbleCss: '',
                    transferBubbleCss: '',
                    bubbleArchives: [{}, {}, {}, {}, {}],
                    globalThemeArchives: [{css:''}, {css:''}, {css:''}],
                    activeGlobalThemeSlot: -1,
                    fontUrl: '', fontFile: null, fontSize: 15,
                    globalFontColor: '#000000',
                    screenWidth: 380, screenHeight: 820,
                    homeScreenWallpaper: 'https://source.unsplash.com/random/380x820?aurora',
                    homeScreenFontColor: '#FFFFFF',
                    appIconSize: 60, appIconGap: 20, appIconRadius: 15,
                    appIcons: {
                        wechat: 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg',
                        settings: 'https://img.js.design/assets/img/66547a8286955562f5597929.png',
                        worldbook: 'https://img.js.design/assets/img/66547a8292e9484a89d107a6.png',
                        forum: 'https://img.js.design/assets/img/6659c2b8c3263435898c199d.png'
                    },
                    lockScreen: {
                        enabled: false,
                        password: '',
                        wallpaper: 'https://source.unsplash.com/random/380x820?night,sky'
                    },
                    batteryIcon: {
                        displayMode: 'outside',
                        iconUrl: ''
                    }
                },
                blacklist: [],
                charMomentFrequency: 'default',
                chatMode: 'online',
                timestampStyle: 'bubble-outside',
                backgroundInteraction: { enabled: false, interval: 3600000, selectedChars: [] },
                charLanguage: 'zh-CN',
                notifications: {
                    send: '',
                    receive: '',
                    ringtone: ''
                },
                dnd: false,
                displayMode: 'default' // 'default', 'fullscreen', or 'iphone6'
            },
            music: {
                library: [], favorites: [], currentSongId: null, isPlaying: false,
                playMode: 'sequence', 
                playerImage: 'https://img.heliar.top/file/1764067235404_Screenshot_2025_1125_183413.png', 
                playerBackground: 'https://img.heliar.top/file/1764067231296_Screenshot_2025_1125_183056.png'
            },
            delivery: {
                cachedItems: [],
                cart: [],
                orders: []
            },
            longTermMemory: {},
            activeChat: { id: null, type: null },
            version: '24.0' // Version bump
        };

        async function loadData() {
            try {
                const savedData = await dataManager.loadData(DATA_KEY);
                appData = savedData ? savedData : JSON.parse(JSON.stringify(defaultAppData));
                
                // HTML美化大师: 强化数据迁移与验证防火墙
                if (!appData.version || parseFloat(appData.version) < 24.0) {
                    // This block is for migrating data from older versions
                    if (!appData.forum) appData.forum = JSON.parse(JSON.stringify(defaultAppData.forum));
                    if (!appData.notifications) appData.notifications = [];
                    if (!appData.user.forumProfile) appData.user.forumProfile = JSON.parse(JSON.stringify(defaultAppData.user.forumProfile));
                    if (!Array.isArray(appData.user.forumProfile.following)) appData.user.forumProfile.following = [];
                    if (!appData.settings.beautify.appIcons.forum) appData.settings.beautify.appIcons.forum = defaultAppData.settings.beautify.appIcons.forum;
                    if (!appData.settings.beautify.batteryIcon) appData.settings.beautify.batteryIcon = JSON.parse(JSON.stringify(defaultAppData.settings.beautify.batteryIcon));
                    if (!appData.settings.beautify.lockScreen) appData.settings.beautify.lockScreen = JSON.parse(JSON.stringify(defaultAppData.settings.beautify.lockScreen));
                    if (!appData.settings.beautify.homeScreenFontColor) appData.settings.beautify.homeScreenFontColor = defaultAppData.settings.beautify.homeScreenFontColor;
                    if (!appData.settings.beautify.globalFontColor) appData.settings.beautify.globalFontColor = defaultAppData.settings.beautify.globalFontColor;
                    if (!appData.settings.beautify.appIcons) appData.settings.beautify.appIcons = JSON.parse(JSON.stringify(defaultAppData.settings.beautify.appIcons));
                    if (!appData.settings.beautify.homeScreenWallpaper) appData.settings.beautify.homeScreenWallpaper = defaultAppData.settings.beautify.homeScreenWallpaper;
                    if (appData.settings.beautify.appIconSize === undefined) appData.settings.beautify.appIconSize = defaultAppData.settings.beautify.appIconSize;
                    if (appData.settings.beautify.appIconGap === undefined) appData.settings.beautify.appIconGap = defaultAppData.settings.beautify.appIconGap;
                    if (appData.settings.beautify.appIconRadius === undefined) appData.settings.beautify.appIconRadius = defaultAppData.settings.beautify.appIconRadius;
                    if (appData.settings.dnd === undefined) appData.settings.dnd = false;
                    if (!appData.user.bankCards) appData.user.bankCards = [];
                    if (!appData.settings.beautify.globalThemeArchives) appData.settings.beautify.globalThemeArchives = [{}, {}, {}, {}, {}];
                    if (appData.settings.beautify.activeGlobalThemeSlot === undefined) appData.settings.beautify.activeGlobalThemeSlot = -1;
                    if (!appData.user.nickname) { appData.user.nickname = appData.user.name || ' '; delete appData.user.name; }
                    if (appData.user.persona) delete appData.user.persona;
                    if (appData.user.address === undefined) appData.user.address = '';
                    if (!appData.user.wallet?.currency) appData.user.wallet.currency = 'CNY';
                    if (!appData.settings.charLanguage) appData.settings.charLanguage = 'zh-CN';
                    if (!appData.settings.notifications) appData.settings.notifications = JSON.parse(JSON.stringify(defaultAppData.settings.notifications));
                    if (!appData.user.personas) appData.user.personas = [];
                    if (!appData.delivery) appData.delivery = JSON.parse(JSON.stringify(defaultAppData.delivery));
                    if (!appData.settings.beautify.phoneFrame) appData.settings.beautify.phoneFrame = 'black';
                    if (!appData.settings.beautify.avatarShape) appData.settings.beautify.avatarShape = 'rounded';
                    if (appData.settings.beautify.voiceBubbleCss) delete appData.settings.beautify.voiceBubbleCss; // Deprecated
                    if (!appData.settings.beautify.screenWidth) appData.settings.beautify.screenWidth = 380;
                    if (!appData.settings.beautify.screenHeight) appData.settings.beautify.screenHeight = 820;
                    if (!appData.worldbooks) appData.worldbooks = { presets: [], styles: [], library: [], forum: [] };
                    if (appData.worldbooks.forum === undefined || typeof appData.worldbooks.forum === 'string') appData.worldbooks.forum = [];
                    if (!appData.longTermMemory) appData.longTermMemory = {};
                    if (!appData.settings.api.repetition_penalty) appData.settings.api.repetition_penalty = 0.69;
                    if (!appData.settings.api.presets) appData.settings.api.presets = [];
                    if (!appData.music.playerImage) appData.music.playerImage = defaultAppData.music.playerImage;
                    if (!appData.music.playerBackground) appData.music.playerBackground = defaultAppData.music.playerBackground;
                    if (!appData.settings.beautify.redPacketBubbleCss) appData.settings.beautify.redPacketBubbleCss = '';
                    if (!appData.settings.beautify.transferBubbleCss) appData.settings.beautify.transferBubbleCss = '';
                    if(appData.settings.displayMode === undefined) appData.settings.displayMode = 'default';
                    
                    appData.contacts.forEach(c => {
                        if (c.isPinned === undefined) c.isPinned = false;
                        if (c.isStarred === undefined) c.isStarred = false;
                        if (c.lastMomentPostTime === undefined) c.lastMomentPostTime = 0;
                        if (c.boundPersonaId === undefined) c.boundPersonaId = null;
                        if (c.isCouple === undefined) c.isCouple = false;
                        if (!c.pokeSettings) c.pokeSettings = { userToChar: { action: '拍了拍', suffix: '' }, charToUser: { action: '拍了拍', suffix: '' } };
                        if (c.forumFollowers === undefined) c.forumFollowers = Math.floor(Math.random() * 10000);
                        if (c.forumFollowing === undefined) c.forumFollowing = Math.floor(Math.random() * 500);
                        if (c.chatSettings === undefined) c.chatSettings = { background: '', userAvatar: '', charAvatar: '' };
                        if (!c.wallet) c.wallet = { balance: Math.floor(Math.random() * 500000) };
                    });
                    
                    const allCharIds = appData.contacts.map(c => c.id);
                    appData.user.forumProfile.following = [...new Set([...(appData.user.forumProfile.following || []), ...allCharIds])];
                    appData.version = '24.0';
                    await saveData(); // Save migrated data
                }

            } catch (error) {
                console.error("Failed to load data, using defaults.", error);
                appData = JSON.parse(JSON.stringify(defaultAppData));
            }
        }

        async function saveData(showAlert = false, callback = null) {
            try {
                await dataManager.saveData(DATA_KEY, appData);
                if (showAlert) {
                    showToast('保存成功!');
                }
                if (callback) {
                    callback();
                }
            } catch (error) {
                console.error("Error saving data to IndexedDB:", error);
                showToast(`数据保存失败: ${error.message}`, 'error');
            }
        }

        // --- Navigation ---
        let pageHistory = ['home-screen-page'];
        function showPage(pageId, renderFunc, ...args) {
            // HTML美化大师: 导航防火墙
            const pageElement = document.getElementById(pageId);
            if (!pageElement) {
                console.error(`Navigation Firewall: Page with ID "${pageId}" not found.`);
                showToast(`错误：找不到页面 ${pageId}`, 'error');
                return;
            }

            if (pageId !== 'lock-screen-page' && pageId !== 'password-entry-page' && appData.settings.beautify.lockScreen.enabled && (pageHistory[pageHistory.length - 1] === 'home-screen-page' || pageHistory.length === 0 || pageHistory[pageHistory.length - 1] === 'lock-screen-page')) {
                pageHistory = ['lock-screen-page'];
                showPage('lock-screen-page', renderLockScreenPage);
                return;
            }

            if (pageHistory[pageHistory.length - 1] !== pageId) {
                pageHistory.push(pageId);
            }

            if (renderFunc) {
                try {
                    renderFunc(pageElement, ...args);
                } catch (e) {
                    console.error(`Render Firewall: Error rendering page "${pageId}".`, e);
                    showToast(`页面渲染失败: ${pageId}`, 'error');
                    goBack();
                    return;
                }
            }
            
            const allPages = document.querySelectorAll('.page');
            allPages.forEach(p => p.classList.remove('active'));
            
            pageElement.classList.add('active');
        }

        function goBack() {
            if (pageHistory.length <= 1) return;
            const currentPageId = pageHistory.pop();
            const previousPageId = pageHistory[pageHistory.length - 1];
            
            const currentPageEl = document.getElementById(currentPageId);
            if (currentPageEl) {
                currentPageEl.classList.remove('active');
            }
            
            const previousPageEl = document.getElementById(previousPageId);
            if (previousPageEl) {
                previousPageEl.classList.add('active');
            }
            
            // HTML美化大师: 确保返回时主界面内容正确刷新
            if (previousPageId === 'wechat-app-page') {
                const activeTab = document.querySelector('#wechat-app-page .tab-item.active');
                if (activeTab) renderMainContent(activeTab.dataset.page);
            } else if (previousPageId === 'forum-app-page') {
                const activeTab = document.querySelector('#forum-app-page .forum-tab-item.active');
                if (activeTab) renderForumMainContent(activeTab.dataset.page);
            }
        }

        // --- Rendering Functions ---
        function renderHomeScreen(container) {
            // HTML美化大师: 渲染防火墙
            if (!container) return;
            const icons = appData.settings.beautify.appIcons;
            const appGrid = container.querySelector('#app-grid');
            if (!appGrid) return;
            appGrid.innerHTML = `
                <div class="app-icon" onclick="showPage('wechat-app-page', renderWechatApp)">
                    <div class="icon-bg" style="background-image: url('${icons.wechat}')"></div>
                    <span class="app-name">WeChat</span>
                </div>
                <div class="app-icon" onclick="showPage('settings-app-page', renderSettingsAppPage)">
                    <div class="icon-bg" style="background-image: url('${icons.settings}')"></div>
                    <span class="app-name">设置</span>
                </div>
                <div class="app-icon" onclick="showPage('worldbook-app-page', renderWorldbookAppPage)">
                    <div class="icon-bg" style="background-image: url('${icons.worldbook}')"></div>
                    <span class="app-name">世界书</span>
                </div>
                <div class="app-icon" onclick="showPage('forum-app-page', renderForumApp)">
                    <div class="icon-bg" style="background-image: url('${icons.forum}')"></div>
                    <span class="app-name">论坛</span>
                </div>
            `;
            updateSystemUI();
        }

        function renderWechatApp(container) {
            if (!container) return;
            const activeTab = container.querySelector('.tab-item.active');
            renderMainContent(activeTab ? activeTab.dataset.page : 'chat-list');
        }

        function renderMainContent(pageType) {
            const contentArea = document.getElementById('main-content-area');
            const header = document.getElementById('main-header');
            const plusBtn = document.getElementById('main-plus-btn');
            
            // HTML美化大师: 渲染防火墙
            if (!contentArea || !header || !plusBtn) return;
            
            contentArea.innerHTML = '';
            plusBtn.style.display = 'block';
            header.querySelector('.header-left').style.visibility = 'visible';

            switch (pageType) {
                case 'chat-list':
                    header.querySelector('.header-title').textContent = '微信';
                    renderChatListPage(contentArea);
                    plusBtn.onclick = () => showMainPlusMenu();
                    break;
                case 'contacts':
                    header.querySelector('.header-title').textContent = '通讯录';
                    renderContactsPage(contentArea);
                    plusBtn.onclick = () => showPage('editor-page', renderEditorPage, 'character');
                    break;
                case 'me':
                    header.querySelector('.header-title').textContent = '';
                    renderMePage(contentArea);
                    header.querySelector('.header-left').style.visibility = 'hidden';
                    plusBtn.style.display = 'none';
                    break;
            }
        }

        function showMainPlusMenu() {
            const modalId = 'main-plus-menu-modal';
            const html = `
                <div class="modal-content">
                    <div class="list-view" style="background: transparent;">
                        <div class="list-item" onclick="showPage('create-group-chat-page', renderCreateGroupChatPage); closeModal('${modalId}');">
                            <i class="fas fa-users"></i><span style="margin-left: 10px;">发起群聊</span>
                        </div>
                        <div class="list-item" onclick="showPage('editor-page', renderEditorPage, 'character'); closeModal('${modalId}');">
                            <i class="fas fa-user-plus"></i><span style="margin-left: 10px;">添加朋友</span>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function renderChatListPage(container) {
            if (!container) return;
            let html = '<div class="list-view">';
            const visibleContacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            const allChats = [...visibleContacts.map(c => ({...c, type: 'individual'})), ...appData.groups.map(g => ({...g, type: 'group'}))];
            
            // HTML美化大师: 稳定的列表排序逻辑，确保UI一致性
            const sortedChats = [...allChats].sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                const lastMsgA = a.conversation?.[a.conversation.length - 1]?.timestamp || 0;
                const lastMsgB = b.conversation?.[b.conversation.length - 1]?.timestamp || 0;
                return lastMsgB - lastMsgA;
            });

            if (sortedChats.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">暂无聊天，去通讯录添加一个角色吧</div>';
            } else {
                sortedChats.forEach(chat => {
                    const lastMessage = chat.conversation && chat.conversation.length > 0
                        ? chat.conversation[chat.conversation.length - 1]
                        : null;
                    
                    let subtext = '...';
                    let displayTime = '';

                    if (lastMessage) {
                        const time = new Date(lastMessage.timestamp);
                        displayTime = time.toLocaleDateString() === new Date().toLocaleDateString()
                            ? time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                            : `${time.getMonth()+1}/${time.getDate()}`;
                        
                        switch(lastMessage.type) {
                            case 'image': subtext = '[图片]'; break;
                            case 'sticker': subtext = '[表情]'; break;
                            case 'voice': subtext = '[语音]'; break;
                            case 'location': subtext = '[位置]'; break;
                            case 'transfer': subtext = '[转账]'; break;
                            case 'redPacket': subtext = '[红包]'; break;
                            case 'forward': subtext = '[聊天记录]'; break;
                            case 'camera-sim': subtext = '[图片]'; break;
                            case 'html-content': subtext = '[代码片段]'; break;
                            case 'gift': subtext = `[礼物] ${lastMessage.content.name}`; break;
                            case 'couple_invitation': subtext = '[情侣邀请]'; break;
                            case 'delivery_receipt': subtext = '[外卖订单]'; break;
                            case 'gift_receipt': subtext = '[礼物清单]'; break;
                            case 'voice_call': subtext = '[语音通话]'; break;
                            case 'system': subtext = lastMessage.content.content; break;
                            default: subtext = lastMessage.content.content;
                        }
                    }

                    const displayName = chat.type === 'group' ? chat.name : (chat.remark || chat.name);
                    const starIcon = chat.isStarred ? '<i class="fas fa-star"></i>' : '';
                    const avatarSrc = chat.type === 'group' ? (chat.avatar || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg') : chat.avatar;

                    html += `
                        <div class="list-item ${chat.isPinned ? 'pinned' : ''}" onclick="showPage('conversation-page', renderConversationPage, '${chat.id}', '${chat.type}')">
                            <img src="${avatarSrc}" class="avatar">
                            <div class="details">
                                <span class="name">${displayName} ${starIcon}</span>
                                <p class="subtext">${subtext ? subtext.substring(0, 25) : '...'}</p>
                            </div>
                            <div class="info">
                                <span>${displayTime}</span>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function renderContactsPage(container) {
            if (!container) return;
            let html = '<div class="list-view">';
            const visibleContacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            visibleContacts.forEach(contact => {
                const displayName = contact.remark || contact.name;
                html += `
                    <div class="list-item" onclick="showPage('editor-page', renderEditorPage, 'character', ${contact.id})">
                        <img src="${contact.avatar}" class="avatar">
                        <div class="details">
                            <span class="name">${displayName}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderMePage(container) {
            if (!container) return;
            const user = appData.user;
            container.innerHTML = `
                <div class="me-profile-card" onclick="showPage('editor-page', renderEditorPage, 'user')">
                    <img src="${user.avatar}" class="avatar">
                    <div class="details">
                        <p class="name">${user.nickname}</p>
                        <p class="wxid">微信号: ${user.wxid}</p>
                        <p class="signature">${user.signature}</p>
                    </div>
                    <i class="fas fa-qrcode qr-code"></i>
                </div>
                <div class="list-divider"></div>
                <div class="me-menu-item" onclick="showPage('wallet-page', renderWalletPage)">
                    <i class="fas fa-wallet" style="color: #07C160;"></i>
                    <span>钱包</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
                <div class="me-menu-item" onclick="showPage('self-persona-list-page', renderSelfPersonaListPage)">
                    <i class="fas fa-id-card" style="color: #64B5F6;"></i>
                    <span>我的自设</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
                <div class="me-menu-item">
                    <i class="fas fa-map-marker-alt" style="color: #FFC300;"></i>
                    <span>地址</span>
                    <span class="info" style="flex: 1; text-align: right; padding-right: 10px;">${user.address || '未设置'}</span>
                </div>
                <div class="list-divider"></div>
                <div class="me-menu-item" onclick="showPage('moments-page', renderMomentsPage)">
                    <i class="fas fa-images" style="color: #576B95;"></i>
                    <span>朋友圈</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
                <div class="me-menu-item" onclick="showPage('sticker-page', renderStickerPage, true, 'wechat')">
                    <i class="far fa-grin" style="color: #FFC300;"></i>
                    <span>表情</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
            `;
        }

        function renderSettingsAppPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('api-settings-page', renderApiSettingsPage)">
                        <div class="details"><span class="name">API 设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('language-settings-page', renderLanguageSettingsPage)">
                        <div class="details"><span class="name">角色语言设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('beautify-page', renderBeautifyPage)">
                        <div class="details"><span class="name">美化功能</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('display-settings-page', renderDisplaySettingsPage)">
                        <div class="details"><span class="name">显示功能</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('notification-settings-page', renderNotificationSettingsPage)">
                        <div class="details"><span class="name">聊天提示音</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('lock-screen-settings-page', renderLockScreenSettingsPage)">
                        <div class="details"><span class="name">锁屏设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('battery-settings-page', renderBatterySettingsPage)">
                        <div class="details"><span class="name">更换电池图标</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('blacklist-page', renderBlacklistPage)">
                        <div class="details"><span class="name">黑名单</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('storage-settings-page', renderStorageSettingsPage)">
                        <div class="details"><span class="name">储存空间</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('data-management-page', renderDataManagementPage)">
                        <div class="details"><span class="name">数据备份与恢复</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showCharMomentFrequencySettings()">
                        <div class="details"><span class="name">AI动态频率</span></div>
                        <span class="info">${{'low': '较低', 'default': '默认', 'high': '较高'}[appData.settings.charMomentFrequency]}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('chat-mode-page', renderChatModePage)">
                        <div class="details"><span class="name">聊天模式</span></div>
                        <span class="info">${appData.settings.chatMode === 'online' ? '线上聊天' : '线下剧情'}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('timestamp-settings-page', renderTimestampSettingsPage)">
                        <div class="details"><span class="name">时间戳样式</span></div>
                        <span class="info">${{'center': '居中', 'bubble-outside': '气泡外', 'avatar-under': '头像下', 'bubble-inside': '气泡内'}[appData.settings.timestampStyle]}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('background-interaction-page', renderBackgroundInteractionPage)">
                        <div class="details"><span class="name">后台互动</span></div>
                        <span class="info">${appData.settings.backgroundInteraction.enabled ? '已开启' : '已关闭'}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item">
                        <div class="details"><span class="name">消息免打扰</span></div>
                        <label class="switch"><input type="checkbox" id="dnd-toggle" ${appData.settings.dnd ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                </div>
            `;
            document.getElementById('dnd-toggle').onchange = e => {
                appData.settings.dnd = e.target.checked;
                saveData();
                updateSystemUI();
            };
        }

        function renderDisplaySettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">显示功能</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setDisplayMode('default')">
                        <div class="details"><span class="name">保留边框</span></div>
                        ${appData.settings.displayMode === 'default' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setDisplayMode('iphone6')">
                        <div class="details"><span class="name">保留边框②</span></div>
                        ${appData.settings.displayMode === 'iphone6' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setDisplayMode('fullscreen')">
                        <div class="details"><span class="name">去除边框进入全屏</span></div>
                        ${appData.settings.displayMode === 'fullscreen' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setDisplayMode(mode) {
            appData.settings.displayMode = mode;
            saveData();
            applyBeautifySettings();
            renderDisplaySettingsPage(document.getElementById('display-settings-page'));
        }

        function renderWorldbookAppPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">世界书</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showWorldbookEditor('presets')">
                        <div class="details"><span class="name">预设</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookEditor('styles')">
                        <div class="details"><span class="name">文风</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookEditor('library')">
                        <div class="details"><span class="name">世界书库</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookEditor('forum')">
                        <div class="details"><span class="name">论坛APP专属世界书</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function renderEditorPage(container, type, id = null) {
            if (!container) return;
            const isUser = type === 'user';
            const target = isUser ? appData.user : appData.contacts.find(c => c.id == id);
            const title = isUser ? "编辑我的信息" : (target ? "编辑角色信息" : "新建角色");
            const personaLabel = isUser ? '个性签名 (15字以内)' : '角色设定 (Persona)';

            let avatarSrc = 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg';
            if (target) avatarSrc = target.avatar;

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">
                        <i class="fas fa-chevron-left"></i>
                        <span>返回</span>
                    </div>
                    <span class="header-title">${title}</span>
                </div>
                <div class="content-area">
                    <img src="${avatarSrc}" class="avatar-upload-preview" id="editor-avatar-preview" onclick="document.getElementById('editor-avatar-input').click()">
                    <input type="file" id="editor-avatar-input" class="file-input" accept="image/*">
                    
                    <div class="form-group">
                        <label>${isUser ? '网名昵称' : '名字'}</label>
                        <input type="text" id="editor-name" value="${target ? (isUser ? target.nickname : target.name) : ''}">
                    </div>
                    ${isUser ? `
                    <div class="form-group">
                        <label>微信号</label>
                        <input type="text" id="editor-wxid" value="${target?.wxid || ''}">
                    </div>
                    <div class="form-group">
                        <label>地址 (20字以内)</label>
                        <input type="text" id="editor-address" value="${target?.address || ''}" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label>个性签名 (15字以内)</label>
                        <input type="text" id="editor-signature" value="${target?.signature || ''}" maxlength="15">
                    </div>` : `
                    <div class="form-group">
                        <label>${personaLabel}</label>
                        <textarea id="editor-persona" style="min-height: 300px;">${target?.persona || ''}</textarea>
                    </div>
                    `}
                    <button class="form-btn" id="editor-save-btn">保存</button>
                </div>
            `;

            document.getElementById('editor-avatar-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('editor-avatar-preview').src = dataUrl;
                });
            };

            document.getElementById('editor-save-btn').onclick = () => {
                const newAvatar = document.getElementById('editor-avatar-preview').src;
                const newName = document.getElementById('editor-name').value.trim();

                if (!newName) { showToast('名字/昵称不能为空', 'error'); return; }

                if (isUser) {
                    appData.user.avatar = newAvatar;
                    appData.user.nickname = newName;
                    appData.user.wxid = document.getElementById('editor-wxid').value.trim();
                    appData.user.address = document.getElementById('editor-address').value.trim();
                    appData.user.signature = document.getElementById('editor-signature').value.trim();
                } else {
                    const newPersona = document.getElementById('editor-persona').value.trim();
                    if (target) { // Edit existing
                        target.avatar = newAvatar;
                        target.name = newName;
                        target.persona = newPersona;
                    } else { // Create new
                        const newContact = {
                            id: Date.now(), name: newName, avatar: newAvatar, persona: newPersona,
                            conversation: [], remark: '', isPinned: false, isStarred: false, lastMomentPostTime: 0,
                            boundPersonaId: null, isCouple: false,
                            pokeSettings: { userToChar: { action: '拍了拍', suffix: '' }, charToUser: { action: '拍了拍', suffix: '' } },
                            forumFollowers: Math.floor(Math.random() * 10000), forumFollowing: Math.floor(Math.random() * 500),
                            chatSettings: { background: '', userAvatar: '', charAvatar: '' },
                            wallet: { balance: Math.floor(Math.random() * 500000) }
                        };
                        appData.contacts.push(newContact);
                        // HTML美化大师: 新增角色时，自动在论坛中关注
                        if (!appData.user.forumProfile.following.includes(newContact.id)) {
                            appData.user.forumProfile.following.push(newContact.id);
                        }
                    }
                }
                saveData(true, goBack);
            };
        }
        
        function renderConversationPage(container, chatId, chatType) {
            appData.activeChat.id = chatId;
            appData.activeChat.type = chatType;

            let chat;
            if (chatType === 'group') {
                chat = appData.groups.find(g => g.id == chatId);
            } else {
                chat = appData.contacts.find(c => c.id == chatId);
            }
            // HTML美化大师: 聊天防火墙
            if (!chat) {
                console.error(`Chat Firewall: Chat not found (ID: ${chatId}, Type: ${chatType})`);
                showToast('找不到该聊天', 'error');
                goBack();
                return;
            }
            
            const displayName = chatType === 'group' ? `${chat.name} (${chat.members.length})` : (chat.remark || chat.name);
            const chatSettings = chat.chatSettings || {};

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                    <span class="header-title">${displayName}</span>
                    <div class="header-right" onclick="showPage('${chatType === 'group' ? 'group-chat-settings-page' : 'chat-settings-page'}', ${chatType === 'group' ? 'renderGroupChatSettingsPage' : 'renderChatSettingsPage'}, '${chatId}')"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="content-area" id="message-area" style="${chatSettings.background ? `background-image: url(${chatSettings.background})` : ''}"></div>
                <div class="chat-input-bar">
                    <i class="fas fa-microphone" id="chat-voice-btn"></i>
                    <input type="text" id="chat-input" placeholder="发送消息">
                    <i class="far fa-grin" id="chat-sticker-btn"></i>
                    <i class="fas fa-plus-circle" id="chat-plus-btn"></i>
                </div>
                <div class="chat-plus-menu" id="chat-plus-menu">
                    <div class="plus-menu-item" id="plus-image-btn"><div class="icon"><i class="fas fa-image"></i></div><span>相册</span></div>
                    <div class="plus-menu-item" id="plus-camera-btn"><div class="icon"><i class="fas fa-camera"></i></div><span>拍摄</span></div>
                    <div class="plus-menu-item" id="plus-voice-call-btn"><div class="icon"><i class="fas fa-phone-alt"></i></div><span>语音通话</span></div>
                    <div class="plus-menu-item" id="plus-location-btn"><div class="icon"><i class="fas fa-map-marker-alt"></i></div><span>位置</span></div>
                    <div class="plus-menu-item" id="plus-redpacket-btn"><div class="icon" style="color: #E64340;"><i class="fas fa-envelope"></i></div><span>红包</span></div>
                    <div class="plus-menu-item" id="plus-transfer-btn"><div class="icon"><i class="fas fa-exchange-alt"></i></div><span>转账</span></div>
                    <div class="plus-menu-item" id="plus-music-btn"><div class="icon"><i class="fas fa-music"></i></div><span>一起听</span></div>
                    <div class="plus-menu-item" id="plus-diary-btn"><div class="icon"><i class="fas fa-book-open"></i></div><span>对方日记</span></div>
                    <div class="plus-menu-item" id="plus-gift-btn"><div class="icon" style="color: #FFB347;"><i class="fas fa-gift"></i></div><span>礼物</span></div>
                    <div class="plus-menu-item" id="plus-couple-btn"><div class="icon" style="color: #FF69B4;"><i class="fas fa-heart"></i></div><span>情侣空间</span></div>
                    <div class="plus-menu-item" id="plus-delivery-btn"><div class="icon" style="color: #FFC107;"><i class="fas fa-utensils"></i></div><span>外卖</span></div>
                    <div class="plus-menu-item" onclick="showPage('char-balance-page', showCharBalancePage, '${chatId}')"><div class="icon"><i class="fas fa-search-dollar"></i></div><span>对方余额</span></div>
                </div>
                <div class="multi-select-toolbar" id="multi-select-toolbar">
                    <button id="multi-select-forward-btn" disabled>转发</button>
                    <button id="multi-select-delete-btn" disabled>删除</button>
                    <button id="multi-select-cancel-btn">取消</button>
                </div>
            `;
            
            renderMessages(chatId, chatType, 'wechat');

            const input = document.getElementById('chat-input');
            input.onkeydown = (e) => {
                if (e.key === 'Enter' && input.value.trim() !== '') {
                    e.preventDefault();
                    const quotedMessageId = input.dataset.quotedMessageId;
                    sendMessage(chatId, chatType, { content: input.value.trim() }, 'text', 'wechat', quotedMessageId);
                    input.value = '';
                    input.placeholder = '发送消息';
                    delete input.dataset.quotedMessageId;
                }
            };
            
            document.getElementById('chat-plus-btn').onclick = () => {
                const menu = document.getElementById('chat-plus-menu');
                menu.style.display = menu.style.display === 'grid' ? 'none' : 'grid';
            };
            
            document.getElementById('chat-voice-btn').onclick = () => showVoiceInputModal(chatId, chatType, 'wechat');
            document.getElementById('plus-image-btn').onclick = () => document.getElementById('image-file-input-chat').click();
            container.insertAdjacentHTML('beforeend', '<input type="file" id="image-file-input-chat" class="file-input" accept="image/*">');
            document.getElementById('image-file-input-chat').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    sendMessage(chatId, chatType, { url: dataUrl, description: "用户发送了一张图片" }, 'image', 'wechat');
                });
            };
            document.getElementById('plus-camera-btn').onclick = () => showCameraSimModal(chatId, chatType, 'wechat');
            document.getElementById('plus-location-btn').onclick = () => showLocationInputModal(chatId, chatType, 'wechat');
            document.getElementById('plus-transfer-btn').onclick = () => showTransactionModal('transfer', chatId, chatType);
            document.getElementById('plus-redpacket-btn').onclick = () => showTransactionModal('redPacket', chatId, chatType);
            document.getElementById('chat-sticker-btn').onclick = () => showPage('sticker-page', renderStickerPage, false, 'wechat');
            document.getElementById('plus-music-btn').onclick = () => showPage('music-library-page', renderMusicLibraryPage, 'wechat');
            document.getElementById('plus-diary-btn').onclick = () => showPage('diary-page', renderDiaryPage, chatId);
            document.getElementById('plus-gift-btn').onclick = () => showGiftShopModal(chatId, chatType);
            document.getElementById('plus-couple-btn').onclick = () => sendCoupleInvitation(chatId, chatType, 'wechat');
            document.getElementById('plus-delivery-btn').onclick = () => openDeliveryModal(chatId, chatType);
            document.getElementById('plus-voice-call-btn').onclick = () => startVoiceCall(chatId, chatType, 'user');

            const multiSelectToolbar = document.getElementById('multi-select-toolbar');
            const forwardBtn = document.getElementById('multi-select-forward-btn');
            const deleteBtn = document.getElementById('multi-select-delete-btn');
            const cancelBtn = document.getElementById('multi-select-cancel-btn');
            let multiSelectState = { active: false, selectedIds: new Set() };

            window.startMultiSelectMode = (messageId, source) => {
                if (source !== 'wechat') return;
                multiSelectState.active = true;
                multiSelectState.selectedIds.add(messageId);
                multiSelectToolbar.classList.add('active');
                document.querySelector('#conversation-page .chat-input-bar').style.display = 'none';
                updateMultiSelectUI();
            };

            const updateMultiSelectUI = () => {
                document.querySelectorAll('#message-area .message-row').forEach(row => {
                    row.classList.add('multi-select-mode');
                    if (multiSelectState.selectedIds.has(parseInt(row.dataset.messageId))) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                });
                forwardBtn.disabled = multiSelectState.selectedIds.size === 0;
                deleteBtn.disabled = multiSelectState.selectedIds.size === 0;
            };

            const endMultiSelectMode = () => {
                multiSelectState.active = false;
                multiSelectState.selectedIds.clear();
                multiSelectToolbar.classList.remove('active');
                document.querySelector('#conversation-page .chat-input-bar').style.display = 'flex';
                document.querySelectorAll('#message-area .message-row').forEach(row => {
                    row.classList.remove('multi-select-mode', 'selected');
                });
            };

            cancelBtn.onclick = endMultiSelectMode;

            forwardBtn.onclick = () => {
                if (multiSelectState.selectedIds.size > 0) {
                    showForwardMessageModal(Array.from(multiSelectState.selectedIds), chatId, chatType, 'wechat');
                    endMultiSelectMode();
                }
            };

            deleteBtn.onclick = () => {
                if (multiSelectState.selectedIds.size > 0 && confirm(`确定要删除这 ${multiSelectState.selectedIds.size} 条消息吗？`)) {
                    let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
                    chat.conversation = chat.conversation.filter(msg => !multiSelectState.selectedIds.has(msg.id));
                    saveData();
                    renderMessages(chatId, chatType, 'wechat');
                    endMultiSelectMode();
                }
            };

            document.getElementById('message-area').addEventListener('click', e => {
                if (!multiSelectState.active) return;
                const messageRow = e.target.closest('.message-row');
                if (messageRow) {
                    const messageId = parseInt(messageRow.dataset.messageId);
                    if (multiSelectState.selectedIds.has(messageId)) {
                        multiSelectState.selectedIds.delete(messageId);
                    } else {
                        multiSelectState.selectedIds.add(messageId);
                    }
                    updateMultiSelectUI();
                }
            });
        }

        function renderMessages(chatId, chatType, source) {
            const containerId = 'message-area';
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Render Firewall: Message area container '${containerId}' not found.`);
                return;
            }
            
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;

            const conversation = chat.conversation || [];
            
            let html = '';
            let lastTimestamp = 0;
            conversation.forEach((msg, index) => {
                if (!msg || !msg.type || !msg.content) {
                    console.warn("Message Firewall: Skipped rendering malformed message object:", msg);
                    return;
                }

                if (appData.settings.timestampStyle === 'center' && msg.timestamp - lastTimestamp > 5 * 60 * 1000) {
                    html += `<div class="message-timestamp">${new Date(msg.timestamp).toLocaleString()}</div>`;
                    lastTimestamp = msg.timestamp;
                }

                if (msg.isRecalled) {
                    const recallerName = msg.sender === appData.user.id ? appData.user.nickname : (chatType === 'group' ? (chat.members.find(m => m.id == msg.sender)?.name || '未知成员') : (chat.remark || chat.name));
                    html += `<div class="message-recalled">${recallerName} 撤回了一条消息</div>`;
                    return;
                }
                if (msg.type === 'system') {
                    if (msg.content.type === 'couple_accepted') {
                        html += `<div class="message-system"><i class="fas fa-heart" style="color: #FF69B4;"></i> ${msg.content.content}</div>`;
                    } else {
                        html += `<div class="message-system">${msg.content.content}</div>`;
                    }
                    return;
                }

                const isSent = msg.sender === appData.user.id;
                let senderObj;
                const chatSettings = chat.chatSettings || {};

                if (isSent) {
                    senderObj = { ...appData.user, avatar: chatSettings.userAvatar || appData.user.avatar };
                } else {
                    const charBase = (chatType === 'group' ? (chat.members.find(m => m.id == msg.sender) || {name: '未知', avatar: ''}) : chat);
                    senderObj = { ...charBase, avatar: chatSettings.charAvatar || charBase.avatar };
                }
                if (!senderObj) return;

                const avatar = senderObj.avatar;
                let bubbleHtml = '';
                let additionalContent = '';
                let timestampHtml = '';

                const msgTime = new Date(msg.timestamp);
                const timeString = msgTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second: '2-digit'});

                switch (appData.settings.timestampStyle) {
                    case 'bubble-outside': timestampHtml = `<div class="message-timestamp-under" style="text-align: ${isSent ? 'right' : 'left'};">${timeString}</div>`; break;
                    case 'avatar-under': timestampHtml = `<div class="message-timestamp-under" style="text-align: center;">${timeString}</div>`; break;
                }
                
                bubbleHtml = isSent ? generateUserBubbleHtml(msg, chatId, chatType, 'wechat') : generateCharBubbleHtml(msg, chatId, chatType, 'wechat');

                if (msg.translatedText) additionalContent += `<div class="translated-text-bubble">${msg.translatedText}</div>`;
                if (msg.type === 'voice' && msg.transcribedText) additionalContent += `<div class="voice-transcribed-bubble" onclick="this.style.display='none'">${msg.transcribedText}</div>`;

                if (appData.settings.timestampStyle === 'bubble-inside') {
                    if (['text', 'voice'].includes(msg.type)) {
                         bubbleHtml = bubbleHtml.replace(/<\/div>$/, `<div class="message-timestamp-inside" style="text-align: ${isSent ? 'right' : 'left'};">${timeString}</div></div>`);
                    }
                }

                html += `
                    <div class="message-row ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                        <div class="message-body">
                            <div class="message-avatar-wrapper" ondblclick="triggerPoke('${chatId}', '${chatType}', '${senderObj.id}', 'wechat')">
                                <img src="${avatar}" class="message-avatar">
                                <div class="avatar-frame"></div>
                                ${appData.settings.timestampStyle === 'avatar-under' ? timestampHtml : ''}
                            </div>
                            <div class="message-content-wrapper">
                                ${bubbleHtml}
                                ${additionalContent}
                                ${appData.settings.timestampStyle === 'bubble-outside' ? timestampHtml : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function generateUserBubbleHtml(msg, chatId, chatType, source) {
            let bubbleContent = '';
            let bubbleClass = '';
            let additionalAttributes = `ondblclick="showMessageContextMenu(event, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;

            switch(msg.type) {
                case 'text':
                    let quotedHtml = '';
                    if (msg.quotedMessage) {
                        let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
                        let quotedSenderName = '未知';
                        if (chatType === 'group') {
                            const quotedSender = chat.members.find(m => m.id == msg.quotedMessage.sender);
                            quotedSenderName = quotedSender ? (quotedSender.remark || quotedSender.name) : '未知成员';
                        } else {
                            quotedSenderName = msg.quotedMessage.sender === appData.user.id ? appData.user.nickname : (chat.remark || chat.name);
                        }
                        quotedHtml = `<div class="quoted-message"><p><strong>${quotedSenderName}:</strong> ${msg.quotedMessage.content.substring(0, 30)}...</p></div>`;
                    }
                    bubbleContent = `${quotedHtml}${msg.content.content}`;
                    bubbleClass = 'text-bubble';
                    break;
                case 'image':
                    bubbleContent = `<img src="${msg.content.url}" alt="image">`;
                    bubbleClass = 'image-bubble';
                    break;
                case 'sticker':
                    bubbleContent = `<img src="${msg.content.url}" alt="sticker">`;
                    bubbleClass = 'sticker-bubble';
                    break;
                case 'voice':
                    bubbleContent = `<div class="voice-bubble-content"><div class="waveform">${Array(10).fill('<div class="bar"></div>').join('')}</div> <span>${msg.content.duration}"</span></div>`;
                    bubbleClass = 'voice-bubble text-bubble';
                    additionalAttributes += ` onclick="toggleVoiceBubble(this, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'location':
                    bubbleContent = `<div class="location-text-wrapper"><div class="location-text">${msg.content.location}</div></div><div class="map-placeholder"><i class="fas fa-map-marked-alt"></i></div>`;
                    bubbleClass = 'location-bubble';
                    break;
                case 'camera-sim': 
                    bubbleContent = `<img src="https://img.heliar.top/file/1764050688895_Image_1757235244080.jpg" class="sim-icon"><span class="sim-text">糟糕…图片被本喵吃了໒꒰ྀིㅇㅁㅇ꒱ྀི১</span>`; 
                    bubbleClass = 'camera-sim-bubble'; 
                    additionalAttributes += ` onclick="handleBubbleClick('camera-sim', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'transfer':
                    let transferFooter = '微信转账';
                    if (msg.content.status === 'returned') {
                        transferFooter = '转账已退回';
                    } else if (chatType === 'group') {
                        const group = appData.groups.find(g => g.id == chatId);
                        const recipientName = group.members.find(m => m.id == msg.content.recipientId)?.name || '成员';
                        transferFooter = `转账给 ${recipientName}`;
                    }
                    bubbleContent = `<div class="main"><i class="fas fa-exchange-alt icon"></i><div class="details"><span class="amount">¥${parseFloat(msg.content.amount).toFixed(2)}</span><span class="remark">${msg.content.remark || '已转账'}</span></div></div><div class="footer">${transferFooter}</div>`;
                    bubbleClass = 'transfer-bubble';
                    break;
                case 'redPacket':
                    bubbleContent = `<div class="main"><i class="fas fa-envelope icon"></i><div class="details"><span class="remark">${msg.content.remark}</span><span class="amount" style="font-size: 14px;">查看红包</span></div></div><div class="footer">微信红包</div>`;
                    bubbleClass = 'redpacket-bubble';
                    break;
                case 'forward':
                    const originalChat = appData.groups.find(g => g.id == msg.content.originalChatId) || appData.contacts.find(c => c.id == msg.content.originalChatId);
                    let forwardTitle = '聊天记录';
                    if (originalChat) {
                        if (msg.content.originalChatType === 'group') {
                            forwardTitle = `${originalChat.name}的聊天记录`;
                        } else {
                            const otherUser = msg.content.messages.find(m => m.sender !== appData.user.id)?.sender;
                            const otherContact = appData.contacts.find(c => c.id == otherUser);
                            const otherName = otherContact ? (otherContact.remark || otherContact.name) : '对方';
                            forwardTitle = `${otherName}和${appData.user.nickname}的聊天记录`;
                        }
                    }
                    const previewContent = msg.content.messages.slice(0, 2).map(m => `${m.sender === appData.user.id ? appData.user.nickname : '对方'}: ${m.type === 'text' ? m.content.content.substring(0, 15) : `[${m.type}]`}`).join('\n');
                    bubbleContent = `<div class="forward-title">${forwardTitle}</div><div class="forward-content-preview">${previewContent}...</div>`;
                    bubbleClass = 'forwarded-message-bubble';
                    additionalAttributes += ` onclick="showForwardedContentModal(event, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'music':
                    bubbleContent = `<img src="${msg.content.cover}" alt="cover"><div class="details"><div class="title">${msg.content.title}</div><div class="artist">${msg.content.artist}</div></div>`;
                    bubbleClass ='music-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('music', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'html-content':
                    bubbleContent = `<iframe srcdoc="${escapeSrcDoc(msg.content.code)}" class="html-content-iframe" sandbox="allow-scripts allow-same-origin"></iframe>`;
                    bubbleClass = 'html-content-bubble';
                    break;
                case 'gift':
                    bubbleContent = `<i class="fas fa-gift icon"></i><div class="details"><div class="name">${msg.content.name}</div><div class="desc">${msg.content.desc}</div></div>`;
                    bubbleClass = 'gift-bubble';
                    break;
                case 'couple_invitation':
                    const inviterName = appData.user.nickname;
                    bubbleContent = `<i class="fas fa-heartbeat icon"></i><div class="text">${inviterName} 想与你成为情侣</div>`;
                    bubbleClass = 'couple-invitation-bubble';
                    break;
                case 'delivery_receipt':
                case 'gift_receipt':
                    const receiptItems = msg.content.items.map(item => `<div class="item-row"><span>${item.name} x${item.quantity}</span><span>¥${(item.price * item.quantity).toFixed(2)}</span></div>`).join('');
                    const receiptTitle = msg.type === 'delivery_receipt' ? '外卖订单' : '礼物清单';
                    const receiptFooter = msg.type === 'delivery_receipt' ? '订单已送达' : '感谢惠顾';
                    bubbleContent = `
                        <div class="header"><span>${receiptTitle}</span><span>支出</span></div>
                        <div class="items">${receiptItems}</div>
                        <div class="total"><span>总计</span><span>¥${msg.content.total.toFixed(2)}</span></div>
                        <div class="footer">${receiptFooter}</div>
                    `;
                    bubbleClass = 'receipt-bubble';
                    break;
                case 'voice_call':
                    bubbleContent = `<i class="fas fa-phone-alt"></i> 语音通话 <span style="margin-left: 10px; color: var(--wechat-text-secondary);">${msg.content.duration}</span>`;
                    bubbleClass = 'voice-call-bubble text-bubble';
                    break;
                default:
                    bubbleContent = `[未知消息类型: ${msg.type}]`;
                    bubbleClass = 'text-bubble';
                    break;
            }
            return `<div class="message-bubble ${bubbleClass}" ${additionalAttributes}>${bubbleContent}</div>`;
        }

        function generateCharBubbleHtml(msg, chatId, chatType, source) {
            let bubbleContent = '';
            let bubbleClass = '';
            let additionalAttributes = `ondblclick="showMessageContextMenu(event, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;

            switch(msg.type) {
                case 'text':
                    let quotedHtml = '';
                    if (msg.quotedMessage) {
                        let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
                        let quotedSenderName = '未知';
                        if (chatType === 'group') {
                            const quotedSender = chat.members.find(m => m.id == msg.quotedMessage.sender);
                            quotedSenderName = quotedSender ? (quotedSender.remark || quotedSender.name) : '未知成员';
                        } else {
                            quotedSenderName = msg.quotedMessage.sender === appData.user.id ? appData.user.nickname : (chat.remark || chat.name);
                        }
                        quotedHtml = `<div class="quoted-message"><p><strong>${quotedSenderName}:</strong> ${msg.quotedMessage.content.substring(0, 30)}...</p></div>`;
                    }
                    bubbleContent = `${quotedHtml}${msg.content.content}`;
                    bubbleClass = 'text-bubble';
                    break;
                case 'image':
                    bubbleContent = `<img src="${msg.content.url}" alt="image">`;
                    bubbleClass = 'image-bubble';
                    break;
                case 'sticker':
                    bubbleContent = `<img src="${msg.content.url}" alt="sticker">`;
                    bubbleClass = 'sticker-bubble';
                    break;
                case 'voice':
                    bubbleContent = `<div class="voice-bubble-content"><div class="waveform">${Array(10).fill('<div class="bar"></div>').join('')}</div> <span>${msg.content.duration}"</span></div>`;
                    bubbleClass = 'voice-bubble text-bubble';
                    additionalAttributes += ` onclick="toggleVoiceBubble(this, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'location':
                    bubbleContent = `<div class="location-text-wrapper"><div class="location-text">${msg.content.location}</div></div><div class="map-placeholder"><i class="fas fa-map-marked-alt"></i></div>`;
                    bubbleClass = 'location-bubble';
                    break;
                case 'camera-sim': 
                    bubbleContent = `<img src="https://img.heliar.top/file/1764050688895_Image_1757235244080.jpg" class="sim-icon"><span class="sim-text">糟糕…图片被本喵吃了໒꒰ྀིㅇㅁㅇ꒱ྀི১</span>`; 
                    bubbleClass = 'camera-sim-bubble'; 
                    additionalAttributes += ` onclick="handleBubbleClick('camera-sim', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'transfer':
                    let transferStatusText = '请你确认收款';
                    if (msg.content.status === 'claimed') { transferStatusText = '已收款'; } 
                    else if (msg.content.status === 'returned') { transferStatusText = '已退回'; }
                    bubbleContent = `<div class="main"><i class="fas fa-exchange-alt icon"></i><div class="details"><span class="amount">¥${parseFloat(msg.content.amount).toFixed(2)}</span><span class="remark">${transferStatusText}</span></div></div><div class="footer">微信转账</div>`;
                    bubbleClass = 'transfer-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('transfer', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'redPacket':
                    let packetStatus = msg.content.claimed.includes(appData.user.id) ? '已领取' : '点击领取红包';
                    if (msg.content.claimed.length >= msg.content.count) packetStatus = '红包已被领完';
                    bubbleContent = `<div class="main"><i class="fas fa-envelope icon"></i><div class="details"><span class="remark">${msg.content.remark}</span><span class="amount" style="font-size: 14px;">${packetStatus}</span></div></div><div class="footer">微信红包</div>`;
                    bubbleClass = 'redpacket-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('redPacket', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'forward':
                    const originalChat = appData.groups.find(g => g.id == msg.content.originalChatId) || appData.contacts.find(c => c.id == msg.content.originalChatId);
                    let forwardTitle = '聊天记录';
                    if (originalChat) {
                        if (msg.content.originalChatType === 'group') {
                            forwardTitle = `${originalChat.name}的聊天记录`;
                        } else {
                            const otherUser = msg.content.messages.find(m => m.sender !== appData.user.id)?.sender;
                            const otherContact = appData.contacts.find(c => c.id == otherUser);
                            const otherName = otherContact ? (otherContact.remark || otherContact.name) : '对方';
                            forwardTitle = `${otherName}和${appData.user.nickname}的聊天记录`;
                        }
                    }
                    const previewContent = msg.content.messages.slice(0, 2).map(m => `${m.sender === appData.user.id ? appData.user.nickname : '对方'}: ${m.type === 'text' ? m.content.content.substring(0, 15) : `[${m.type}]`}`).join('\n');
                    bubbleContent = `<div class="forward-title">${forwardTitle}</div><div class="forward-content-preview">${previewContent}...</div>`;
                    bubbleClass = 'forwarded-message-bubble';
                    additionalAttributes += ` onclick="showForwardedContentModal(event, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'music':
                    bubbleContent = `<img src="${msg.content.cover}" alt="cover"><div class="details"><div class="title">${msg.content.title}</div><div class="artist">${msg.content.artist}</div></div>`;
                    bubbleClass = 'music-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('music', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'html-content':
                    bubbleContent = `<iframe srcdoc="${escapeSrcDoc(msg.content.code)}" class="html-content-iframe" sandbox="allow-scripts allow-same-origin"></iframe>`;
                    bubbleClass = 'html-content-bubble';
                    break;
                case 'gift':
                    bubbleContent = `<i class="fas fa-gift icon"></i><div class="details"><div class="name">${msg.content.name}</div><div class="desc">${msg.content.desc}</div></div>`;
                    bubbleClass = 'gift-bubble';
                    break;
                case 'couple_invitation':
                    const inviterName = (appData.contacts.find(c=>c.id==chatId).remark || appData.contacts.find(c=>c.id==chatId).name);
                    bubbleContent = `<i class="fas fa-heartbeat icon"></i><div class="text">${inviterName} 想与你成为情侣</div><div class="actions"><button class="accept-btn" onclick="respondToCoupleInvitation(${msg.id}, true, '${chatId}', '${chatType}', '${source}')">同意</button><button onclick="respondToCoupleInvitation(${msg.id}, false, '${chatId}', '${chatType}', '${source}')">拒绝</button></div>`;
                    bubbleClass = 'couple-invitation-bubble';
                    break;
                case 'delivery_receipt':
                case 'gift_receipt':
                    const receiptItems = msg.content.items.map(item => `<div class="item-row"><span>${item.name} x${item.quantity}</span><span>¥${(item.price * item.quantity).toFixed(2)}</span></div>`).join('');
                    const receiptTitle = msg.type === 'delivery_receipt' ? '外卖订单' : '礼物清单';
                    const receiptFooter = msg.type === 'delivery_receipt' ? '订单已送达' : '感谢惠顾';
                    bubbleContent = `
                        <div class="header"><span>${receiptTitle}</span><span>收到</span></div>
                        <div class="items">${receiptItems}</div>
                        <div class="total"><span>总计</span><span>¥${msg.content.total.toFixed(2)}</span></div>
                        <div class="footer">${receiptFooter}</div>
                    `;
                    bubbleClass = 'receipt-bubble';
                    break;
                case 'voice_call':
                    bubbleContent = `<i class="fas fa-phone-alt"></i> 语音通话 <span style="margin-left: 10px; color: var(--wechat-text-secondary);">${msg.content.duration}</span>`;
                    bubbleClass = 'voice-call-bubble text-bubble';
                    break;
                default:
                    bubbleContent = `[未知消息类型: ${msg.type}]`;
                    bubbleClass = 'text-bubble';
                    break;
            }
            return `<div class="message-bubble ${bubbleClass}" ${additionalAttributes}>${bubbleContent}</div>`;
        }
        
        function renderWalletPage(container) {
            if (!container) return;
            const wallet = appData.user.wallet;
            const currentCurrency = wallet.currency;

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>我</span></div>
                    <span class="header-title">钱包</span>
                    <div class="header-right" style="font-size: 16px;" onclick="showPage('transactions-page', renderTransactionsPage)">账单</div>
                </div>
                <div class="content-area">
                    <div class="wallet-header">
                        <div class="wallet-balance-title">
                            <span>零钱 (${currentCurrency})</span>
                            <span class="currency-switcher" onclick="showCurrencySelectionModal()"><i class="fas fa-exchange-alt"></i> 切换</span>
                        </div>
                        <div class="wallet-balance">${formatCurrency(wallet.balance, currentCurrency)}</div>
                    </div>
                    <div class="wallet-services-grid">
                        <div class="wallet-service-item" onclick="showToast('功能开发中...')">
                            <i class="fas fa-qrcode" style="color: var(--wechat-green);"></i>
                            <p>收付款</p>
                        </div>
                        <div class="wallet-service-item" onclick="showTransactionModal('deposit')">
                            <i class="fas fa-plus-circle" style="color: #FCAE3D;"></i>
                            <p>充值</p>
                        </div>
                        <div class="wallet-service-item" onclick="showTransactionModal('withdraw')">
                            <i class="fas fa-arrow-circle-down" style="color: #576B95;"></i>
                            <p>提现</p>
                        </div>
                        <div class="wallet-service-item" onclick="showPage('bank-card-page', renderBankCardPage)">
                            <i class="fas fa-credit-card" style="color: #576B95;"></i>
                            <p>银行卡</p>
                        </div>
                        <div class="wallet-service-item" onclick="showLianQianTongModal()">
                            <i class="fas fa-chart-line" style="color: #FCAE3D;"></i>
                            <p>零钱通</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTransactionsPage(container) {
            if (!container) return;
            let html = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>钱包</span></div>
                    <span class="header-title">账单</span>
                </div>
                <div class="content-area"><div class="list-view">
            `;
            const transactions = appData.user.wallet.transactions.slice().reverse();
            if (transactions.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">暂无记录</div>';
            } else {
                transactions.forEach(tx => {
                    const isIncome = tx.amount > 0;
                    html += `
                        <div class="list-item">
                            <div class="details">
                                <span class="name">${tx.type}</span>
                                <p class="subtext">${tx.details || ''}</p>
                                <p class="subtext" style="margin-top: 4px;">${new Date(tx.timestamp).toLocaleString()}</p>
                            </div>
                            <div class="info" style="color: ${isIncome ? 'var(--wechat-green)' : 'var(--global-font-color)'}; font-size: var(--font-size-base); font-weight: 500;">
                                ${isIncome ? '+' : ''}${formatCurrency(tx.amount, appData.user.wallet.currency, true)}
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div></div>';
            container.innerHTML = html;
        }

        function showCharMomentFrequencySettings() {
            const modalId = 'char-moment-frequency-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">AI动态频率</div>
                    <div class="list-view" style="background: transparent;">
                        <div class="list-item" onclick="setCharMomentFrequency('low'); closeModal('${modalId}')">较低 (每3天) ${appData.settings.charMomentFrequency === 'low' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}</div>
                        <div class="list-item" onclick="setCharMomentFrequency('default'); closeModal('${modalId}')">默认 (每1天) ${appData.settings.charMomentFrequency === 'default' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}</div>
                        <div class="list-item" onclick="setCharMomentFrequency('high'); closeModal('${modalId}')">较高 (每6小时) ${appData.settings.charMomentFrequency === 'high' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}</div>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function setCharMomentFrequency(frequency) {
            appData.settings.charMomentFrequency = frequency;
            saveData();
            renderSettingsAppPage(document.getElementById('settings-app-page'));
        }

        function renderChatModePage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">聊天模式</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setChatMode('online')">
                        <div class="details"><span class="name">线上聊天</span><p class="subtext">模拟真实聊天，AI可能连续发送多条短消息。</p></div>
                        ${appData.settings.chatMode === 'online' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setChatMode('offline')">
                        <div class="details"><span class="name">线下剧情</span><p class="subtext">专注于长篇剧情，AI会生成大段描述性文本。</p></div>
                        ${appData.settings.chatMode === 'offline' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setChatMode(mode) {
            appData.settings.chatMode = mode;
            saveData();
            renderChatModePage(document.getElementById('chat-mode-page'));
        }

        function renderTimestampSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">时间戳样式</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setTimestampStyle('center')">
                        <div class="details"><span class="name">时间戳居中 (每5分钟)</span></div>
                        ${appData.settings.timestampStyle === 'center' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('bubble-outside')">
                        <div class="details"><span class="name">时间戳在气泡外</span></div>
                        ${appData.settings.timestampStyle === 'bubble-outside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('avatar-under')">
                        <div class="details"><span class="name">时间戳在头像下</span></div>
                        ${appData.settings.timestampStyle === 'avatar-under' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('bubble-inside')">
                        <div class="details"><span class="name">时间戳在气泡内</span></div>
                        ${appData.settings.timestampStyle === 'bubble-inside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setTimestampStyle(style) {
            appData.settings.timestampStyle = style;
            saveData();
            renderTimestampSettingsPage(document.getElementById('timestamp-settings-page'));
        }

        function renderBackgroundInteractionPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">后台互动</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">开启后台互动</span></div>
                        <label class="switch"><input type="checkbox" id="bg-interaction-toggle" ${appData.settings.backgroundInteraction.enabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-item" onclick="showBgInteractionIntervalModal()">
                        <div class="details"><span class="name">互动间隔</span></div>
                        <span class="info">${appData.settings.backgroundInteraction.interval / 60000} 分钟</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showBgInteractionCharSelectionModal()">
                        <div class="details"><span class="name">选择互动角色</span></div>
                        <span class="info">${appData.settings.backgroundInteraction.selectedChars.length} 个</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
            document.getElementById('bg-interaction-toggle').onchange = (e) => {
                appData.settings.backgroundInteraction.enabled = e.target.checked;
                saveData();
                renderBackgroundInteractionPage(document.getElementById('background-interaction-page'));
                if (e.target.checked) startBackgroundInteraction();
                else stopBackgroundInteraction();
            };
        }

        function showBgInteractionIntervalModal() {
            const modalId = 'bg-interaction-interval-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">设置互动间隔 (分钟)</div>
                    <div class="modal-input-group">
                        <input type="number" id="bg-interaction-interval-input" class="modal-input" value="${appData.settings.backgroundInteraction.interval / 60000}" min="1">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="save-bg-interval-btn">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('save-bg-interval-btn').onclick = () => {
                const intervalMinutes = parseInt(document.getElementById('bg-interaction-interval-input').value);
                if (isNaN(intervalMinutes) || intervalMinutes < 1) { showToast('请输入有效的时间间隔', 'error'); return; }
                appData.settings.backgroundInteraction.interval = intervalMinutes * 60000;
                saveData();
                renderBackgroundInteractionPage(document.getElementById('background-interaction-page'));
                closeModal(modalId);
                if (appData.settings.backgroundInteraction.enabled) {
                    stopBackgroundInteraction();
                    startBackgroundInteraction();
                }
            };
        }

        function showBgInteractionCharSelectionModal() {
            const modalId = 'bg-interaction-char-selection-modal';
            const contactsHtml = appData.contacts.map(c => `
                <div class="list-item">
                    <img src="${c.avatar}" class="avatar" style="width: 36px; height: 36px;">
                    <div class="details"><span class="name">${c.remark || c.name}</span></div>
                    <input type="checkbox" data-contact-id="${c.id}" ${appData.settings.backgroundInteraction.selectedChars.includes(c.id) ? 'checked' : ''}>
                </div>
            `).join('');

            const html = `
                <div class="modal-content" style="max-width: 90%; width: 350px;">
                    <div class="modal-title">选择互动角色</div>
                    <div class="list-view contact-selection-list" style="max-height: 300px; overflow-y: auto; background: transparent;">
                        ${contactsHtml}
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="save-bg-chars-btn">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('save-bg-chars-btn').onclick = () => {
                appData.settings.backgroundInteraction.selectedChars = Array.from(document.querySelectorAll('#' + modalId + ' input[type="checkbox"]:checked')).map(cb => parseInt(cb.dataset.contactId));
                saveData();
                renderBackgroundInteractionPage(document.getElementById('background-interaction-page'));
                closeModal(modalId);
                if (appData.settings.backgroundInteraction.enabled) {
                    stopBackgroundInteraction();
                    startBackgroundInteraction();
                }
            };
        }

        let backgroundInteractionTimer;
        function startBackgroundInteraction() {
            stopBackgroundInteraction();
            if (!appData.settings.backgroundInteraction.enabled || appData.settings.backgroundInteraction.selectedChars.length === 0) return;

            backgroundInteractionTimer = setInterval(async () => {
                const randomCharId = appData.settings.backgroundInteraction.selectedChars[Math.floor(Math.random() * appData.settings.backgroundInteraction.selectedChars.length)];
                const char = appData.contacts.find(c => c.id === randomCharId);
                if (char) {
                    const prompt = `你正在后台与'${appData.user.nickname}'进行互动。请你主动给'${appData.user.nickname}'发一条消息，内容可以是问候、分享日常、表达心情等，字数在20-100字之间，去除人机油腻，禁止带任何动作描述和括号描写。`;
                    const replies = await getAiReply(char.id, 'wechat', prompt);
                    const chatEntry = appData.contacts.find(c => c.id === char.id);
                    if (chatEntry) {
                        if (!chatEntry.conversation) chatEntry.conversation = [];
                        for (const reply of replies) {
                            await processAndSendAiReply(reply, char.id, 'individual', char.id, 'wechat');
                        }
                        if (appData.activeChat.id === char.id) {
                            renderMessages(char.id, 'individual', 'wechat');
                        }
                    }
                }
            }, appData.settings.backgroundInteraction.interval);
        }

        function stopBackgroundInteraction() {
            if (backgroundInteractionTimer) {
                clearInterval(backgroundInteractionTimer);
                backgroundInteractionTimer = null;
            }
        }
        
        function showWorldbookEditor(type) {
            const typeMap = { presets: '预设', styles: '文风', library: '世界书库', forum: '论坛世界书' };
            const isForumWb = type === 'forum';
            // Ensure forum worldbook is treated as an array for multiple entries
            if (isForumWb && !Array.isArray(appData.worldbooks.forum)) {
                appData.worldbooks.forum = appData.worldbooks.forum ? [{ id: Date.now(), name: '默认论坛设定', content: appData.worldbooks.forum }] : [];
            }
            const items = appData.worldbooks[type];
            const modalId = 'worldbook-editor-modal';
            
            const content = `
                <div class="modal-content" style="width: 95%; max-width: 400px;">
                    <div class="modal-title">${typeMap[type]} <i class="fas fa-plus-circle" style="cursor:pointer; color: var(--wechat-green);" onclick="editWorldbookItem('${type}')"></i></div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto; background: transparent;">
                        ${items.map(item => `
                            <div class="list-item" onclick="editWorldbookItem('${type}', ${item.id})">
                                <div class="details"><span class="name">${item.name}</span></div>
                                <i class="fas fa-trash-alt" style="color: var(--wechat-red);" onclick="deleteWorldbookItem(event, '${type}', ${item.id})"></i>
                            </div>
                        `).join('') || `<p style="text-align:center; padding: 20px;">暂无内容</p>`}
                    </div>
                    <button class="modal-btn" onclick="closeModal('${modalId}')" style="margin-top: 15px;">关闭</button>
                </div>
            `;
            showModal(modalId, content);
        }

        function editWorldbookItem(type, id = null) {
            const isNew = id === null;
            const item = isNew ? { id: Date.now(), name: '', content: '' } : appData.worldbooks[type].find(i => i.id === id);
            if (!item) return;
            const typeMap = { presets: '预设', styles: '文风', library: '世界书', forum: '论坛设定' };
            const title = (isNew ? '新建' : '编辑') + typeMap[type];
            const modalId = 'worldbook-item-editor';
            const content = `
                <div class="modal-content" style="width: 95%; max-width: 400px;">
                    <div class="modal-title">${title}</div>
                    <div class="form-group">
                        <label>名称</label>
                        <input type="text" id="wb-edit-name" class="modal-input" value="${item.name}">
                    </div>
                    <div class="form-group">
                        <label>内容 (无字数上限)</label>
                        <textarea id="wb-edit-content" class="modal-input" style="height: 40vh;">${item.content}</textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" onclick="saveWorldbookItem('${type}', ${id}, ${isNew})">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, content);
        }

        function saveWorldbookItem(type, id, isNew) {
            const name = document.getElementById('wb-edit-name').value;
            const content = document.getElementById('wb-edit-content').value;
            if (!name) { showToast('名称不能为空', 'error'); return; }
            
            if (isNew) {
                appData.worldbooks[type].push({ id: Date.now(), name, content });
            } else {
                const index = appData.worldbooks[type].findIndex(i => i.id === id);
                if (index > -1) appData.worldbooks[type][index] = { id, name, content };
            }
            saveData();
            closeModal('worldbook-item-editor');
            showWorldbookEditor(type);
        }

        function deleteWorldbookItem(event, type, id) {
            event.stopPropagation();
            if (!confirm('确定删除吗？')) return;
            appData.worldbooks[type] = appData.worldbooks[type].filter(i => i.id !== id);
            saveData();
            showWorldbookEditor(type);
        }

        function renderBeautifyPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">美化功能</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('theme-settings-page', renderThemeSettingsPage)">
                        <div class="details"><span class="name">主题美化</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('global-theme-editor-page', renderGlobalThemeEditorPage)">
                        <div class="details"><span class="name">自定义全局美化主题</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('wallpaper-settings-page', renderWallpaperSettingsPage)">
                        <div class="details"><span class="name">更换主屏/锁屏壁纸</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('app-icon-settings-page', renderAppIconSettingsPage)">
                        <div class="details"><span class="name">更换APP图标</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('app-layout-settings-page', renderAppLayoutSettingsPage)">
                        <div class="details"><span class="name">调整APP图标布局</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('screen-size-settings-page', renderScreenSizeSettingsPage)">
                        <div class="details"><span class="name">屏幕尺寸</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('phone-frame-settings-page', renderPhoneFrameSettingsPage)">
                        <div class="details"><span class="name">手机边框</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('font-settings-page', renderFontSettingsPage)">
                        <div class="details"><span class="name">更换字体</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('font-color-settings-page', renderFontColorSettingsPage)">
                        <div class="details"><span class="name">调整字体颜色</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('avatar-shape-settings-page', renderAvatarShapeSettingsPage)">
                        <div class="details"><span class="name">头像形状</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('frame-settings-page', renderFrameSettingsPage)">
                        <div class="details"><span class="name">更换头像框</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('bubble-settings-page', renderBubbleSettingsPage)">
                        <div class="details"><span class="name">通用聊天气泡CSS</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('redpacket-bubble-settings-page', renderRedPacketBubbleSettingsPage)">
                        <div class="details"><span class="name">红包气泡CSS</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('transfer-bubble-settings-page', renderTransferBubbleSettingsPage)">
                        <div class="details"><span class="name">转账气泡CSS</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function handleChatBgUpload(file, contactId) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const contact = appData.contacts.find(c => c.id == contactId);
                if (!contact.chatSettings) contact.chatSettings = {};
                contact.chatSettings.background = e.target.result;
                saveData(true);
                if (appData.activeChat.id == contactId) {
                    renderConversationPage(document.getElementById('conversation-page'), contactId, 'individual');
                }
            };
            reader.readAsDataURL(file);
        }

        function renderThemeSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">主题美化</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setTheme('normal')">
                        <div class="details"><span class="name">正常模式</span></div>
                        ${appData.settings.beautify.theme === 'normal' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('dark')">
                        <div class="details"><span class="name">夜间模式</span></div>
                        ${appData.settings.beautify.theme === 'dark' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('dark-abyss')">
                        <div class="details"><span class="name">暗黑深渊</span></div>
                        ${appData.settings.beautify.theme === 'dark-abyss' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item"onclick="setTheme('sakura-pink')">
                        <div class="details"><span class="name">可爱樱花粉</span></div>
                        ${appData.settings.beautify.theme === 'sakura-pink' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('clear-sky-blue')">
                        <div class="details"><span class="name">^•͈༝•^ฅ</span></div>
                        ${appData.settings.beautify.theme === 'clear-sky-blue' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('transparent')">
                        <div class="details"><span class="name">ᖰ˃̶ ꇴ ˂̶ᖳ</span></div>
                        ${appData.settings.beautify.theme === 'transparent' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('neumorphic')">
                        <div class="details"><span class="name">ᦲ ᆺ ᦲ</span></div>
                        ${appData.settings.beautify.theme === 'neumorphic' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setTheme(theme) {
            appData.settings.beautify.theme = theme;
            saveData();
            applyBeautifySettings();
            renderThemeSettingsPage(document.getElementById('theme-settings-page'));
        }

        function renderScreenSizeSettingsPage(container) {
            if (!container) return;
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">屏幕尺寸</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>屏幕宽度 (px)</label>
                        <input type="number" id="screen-width-input" value="${b.screenWidth}">
                    </div>
                    <div class="form-group">
                        <label>屏幕高度 (px)</label>
                        <input type="number" id="screen-height-input" value="${b.screenHeight}">
                    </div>
                    <button class="form-btn" id="save-screen-size-btn">应用</button>
                </div>
            `;
            document.getElementById('save-screen-size-btn').onclick = () => {
                b.screenWidth = parseInt(document.getElementById('screen-width-input').value);
                b.screenHeight = parseInt(document.getElementById('screen-height-input').value);
                saveData(true);
                applyBeautifySettings();
            };
        }

        function renderPhoneFrameSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">手机边框</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    ${['white', 'black', 'simple-white', 'pink', 'aqua-blue', 'semi-transparent', 'transparent', 'stereo', 'evol'].map(frame => `
                    <div class="list-item" onclick="setPhoneFrame('${frame}')">
                        <div class="details"><span class="name">${{
                            white:'白色', 
                            black:'黑色', 
                            'simple-white':'简约白', 
                            pink:'樱花粉', 
                            'aqua-blue':'水蓝色', 
                            'semi-transparent':'半透明', 
                            transparent:'透明', 
                            stereo:'增强立体',
                            evol: 'Evol'
                        }[frame]}</span></div>
                        ${appData.settings.beautify.phoneFrame === frame ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>`).join('')}
                </div>
            `;
        }

        function setPhoneFrame(frame) {
            appData.settings.beautify.phoneFrame = frame;
            saveData();
            applyBeautifySettings();
            renderPhoneFrameSettingsPage(document.getElementById('phone-frame-settings-page'));
        }

        function renderAvatarShapeSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">头像形状</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setAvatarShape('rounded')">
                        <div class="details"><span class="name">圆角</span></div>
                        ${appData.settings.beautify.avatarShape === 'rounded' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setAvatarShape('circle')">
                        <div class="details"><span class="name">圆形</span></div>
                        ${appData.settings.beautify.avatarShape === 'circle' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setAvatarShape(shape) {
            appData.settings.beautify.avatarShape = shape;
            saveData();
            applyBeautifySettings();
            renderAvatarShapeSettingsPage(document.getElementById('avatar-shape-settings-page'));
        }

        function renderFontSettingsPage(container) {
            if (!container) return;
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">更换字体</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>字体大小: <span id="font-size-value">${b.fontSize}</span>px</label>
                        <input type="range" id="font-size-input" min="10" max="30" value="${b.fontSize}" oninput="document.getElementById('font-size-value').textContent = this.value; document.getElementById('font-preview').style.fontSize = this.value + 'px';">
                    </div>
                    <div class="form-group">
                        <label>导入字体 (URL)</label>
                        <input type="text" id="font-url-input" placeholder="输入 .css, .ttf, .woff, .woff2 链接..." value="${b.fontUrl || ''}">
                    </div>
                    <div class="form-group">
                        <label>导入字体 (文件)</label>
                        <button class="form-btn" style="background-color: #aaa;" onclick="document.getElementById('font-file-input').click()">选择 .ttf, .woff, .woff2 文件</button>
                        <input type="file" id="font-file-input" class="file-input" accept=".ttf,.woff,.woff2">
                    </div>
                    <div class="form-group">
                        <label>字体预览</label>
                        <p id="font-preview" style="font-size:${b.fontSize}px; padding: 20px; background: var(--wechat-nav-bg); border-radius: 8px; text-align: center;">Hello, World. 你好，世界。</p>
                    </div>
                    <button class="form-btn" id="save-font-btn">保存并应用</button>
                </div>
            `;

            document.getElementById('save-font-btn').onclick = () => {
                const url = document.getElementById('font-url-input').value.trim();
                const fileInput = document.getElementById('font-file-input');
                const file = fileInput.files[0];
                const fontSize = parseInt(document.getElementById('font-size-input').value);

                appData.settings.beautify.fontSize = fontSize;

                const applyAndSave = () => {
                    saveData(true);
                    applyBeautifySettings();
                };

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        appData.settings.beautify.fontFile = e.target.result;
                        appData.settings.beautify.fontUrl = ''; // Clear URL if file is chosen
                        applyAndSave();
                    };
                    reader.readAsDataURL(file);
                } else {
                    appData.settings.beautify.fontUrl = url;
                    appData.settings.beautify.fontFile = null; // Clear file if URL is chosen
                    applyAndSave();
                }
            };
        }

        function renderFrameSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">更换头像框</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showFrameEditor('user')">
                        <div class="details"><span class="name">更换我的头像框</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showFrameEditor('char')">
                        <div class="details"><span class="name">更换对方的头像框</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }
        
        function showFrameEditor(type) {
            const title = type === 'user' ? '更换我的头像框' : '更换对方的头像框';
            const currentFrame = type === 'user' ? appData.settings.beautify.userAvatarFrame : appData.settings.beautify.charAvatarFrame;
            const modalId = 'frame-editor-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
                    <img src="${currentFrame || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'}" class="avatar-upload-preview" id="frame-preview-modal" onclick="document.getElementById('frame-input-modal').click()">
                    <input type="file" id="frame-input-modal" class="file-input" accept="image/*">
                    <div class="modal-actions">
                        <button class="modal-btn" id="remove-frame-btn-modal">移除</button>
                        <button class="modal-btn primary" id="save-frame-btn-modal">保存</button>
                    </div>
                    <button class="modal-btn" onclick="closeModal('${modalId}')" style="margin-top: 10px; background: #eee;">关闭</button>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('frame-input-modal').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('frame-preview-modal').src = dataUrl;
                });
            };
            document.getElementById('save-frame-btn-modal').onclick = () => {
                const newFrame = document.getElementById('frame-preview-modal').src;
                if (type === 'user') appData.settings.beautify.userAvatarFrame = newFrame;
                else appData.settings.beautify.charAvatarFrame = newFrame;
                saveData(true);
                applyBeautifySettings();
                closeModal(modalId);
            };
            document.getElementById('remove-frame-btn-modal').onclick = () => {
                if (type === 'user') appData.settings.beautify.userAvatarFrame = '';
                else appData.settings.beautify.charAvatarFrame = '';
                saveData(true);
                applyBeautifySettings();
                document.getElementById('frame-preview-modal').src = 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg';
                closeModal(modalId);
            };
        }

        function renderBubbleSettingsPage(container) {
            if (!container) return;
            let currentSlot = 0;
            const loadSlot = (slotIndex) => {
                currentSlot = slotIndex;
                const archive = appData.settings.beautify.bubbleArchives[slotIndex] || {};
                document.getElementById('bubble-css-input').value = archive.bubbleCss || '';
                updateBubblePreview();
                document.querySelectorAll('.slot-btn').forEach((btn, i) => btn.style.fontWeight = i === slotIndex ? 'bold' : 'normal');
            };

            const updateBubblePreview = () => {
                const previewFrame = document.getElementById('bubble-preview-frame');
                const bubbleCss = document.getElementById('bubble-css-input').value;
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                const hasTail = /::after|::before/.test(bubbleCss);

                previewDoc.body.innerHTML = `
                    <style>
                        body { margin: 0; padding: 10px; font-family: sans-serif; background: #eee; }
                        .message-row { display: flex; gap: 10px; margin-bottom: 10px; max-width: 100%; align-items: flex-start; }
                        .message-row.sent { justify-content: flex-end; }
                        .message-bubble { position: relative; padding: 10px 14px; border-radius: 6px; }
                        .message-row.sent .message-bubble.text-bubble { background: #96d35f; }
                        .message-row.received .message-bubble.text-bubble { background: #ffffff; }
                        .message-row.sent .message-bubble.text-bubble::after { content: ""; position: absolute; right: -6px; top: 12px; width: 8px; height: 12px; background: #96d35f; clip-path: polygon(0 0, 100% 50%, 0 100%); display: ${hasTail ? 'none' : 'block'}; }
                        .message-row.received .message-bubble.text-bubble::after { content: ""; position: absolute; left: -6px; top: 12px; width: 8px; height: 12px; background: #ffffff; clip-path: polygon(100% 0, 0 50%, 100% 100%); display: ${hasTail ? 'none' : 'block'}; }
                        .voice-bubble { display: flex; align-items: center; gap: 8px; min-width: 80px; }
                        .voice-bubble-content { display: flex; align-items: center; gap: 10px; }
                        .voice-bubble-content .waveform { display: flex; align-items: center; height: 20px; }
                        .voice-bubble-content .bar { width: 3px; height: 4px; margin: 0 1.5px; border-radius: 2px; animation: wave 1.2s ease-in-out infinite alternate; background: #333; }
                        @keyframes wave { 0% { transform: scaleY(0.2); } 50% { transform: scaleY(1); } 100% { transform: scaleY(0.2); } }
                        ${bubbleCss}
                    </style>
                    <div class="message-row received"><div class="message-bubble text-bubble">对方消息预览</div></div>
                    <div class="message-row sent"><div class="message-bubble text-bubble">我的消息预览</div></div>
                    <div class="message-row received"><div class="message-bubble text-bubble voice-bubble"><div class="voice-bubble-content"><div class="waveform">${Array(10).fill('<div class="bar"></div>').join('')}</div></div></div></div>
                `;
            };

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">通用聊天气泡CSS</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>存档槽</label>
                        <div style="display: flex; justify-content: space-between;">
                            ${[0,1,2,3,4].map(i => `<button class="modal-btn slot-btn" onclick="loadSlot(${i})">存档 ${i+1}</button>`).join('')}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>通用气泡CSS (自动适配语音气泡)</label>
                        <textarea id="bubble-css-input" style="height: 250px;" oninput="updateBubblePreview()"></textarea>
                    </div>
                    <div class="form-group">
                        <label>预览</label>
                        <iframe id="bubble-preview-frame" style="width: 100%; height: 200px; border: 1px solid #ccc; border-radius: 8px;"></iframe>
                    </div>
                    <button class="form-btn" id="save-bubble-btn">保存并应用到当前槽</button>
                </div>
            `;
            window.loadSlot = loadSlot;
            window.updateBubblePreview = updateBubblePreview;
            loadSlot(0);

            document.getElementById('save-bubble-btn').onclick = () => {
                const bubbleCss = document.getElementById('bubble-css-input').value;
                appData.settings.beautify.bubbleArchives[currentSlot] = { bubbleCss };
                appData.settings.beautify.bubbleCss = bubbleCss;
                saveData(true);
                applyBeautifySettings();
            };
        }

        function renderRedPacketBubbleSettingsPage(container) {
            if (!container) return;
            const exampleCss = `/* 红包气泡示例CSS */\n.message-bubble.redpacket-bubble {\n  background: linear-gradient(135deg, #ff7e5f, #feb47b) !important;\n  border-radius: 12px;\n}\n.message-bubble.redpacket-bubble .icon {\n  color: white;\n  text-shadow: 0 1px 2px rgba(0,0,0,0.2);\n}`;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">红包气泡CSS</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>红包气泡 CSS</label>
                        <textarea id="redpacket-bubble-css-input" style="height: 250px;">${appData.settings.beautify.redPacketBubbleCss}</textarea>
                    </div>
                    <div class="form-group">
                        <label>预览</label>
                        <div class="message-row received" style="justify-content: center;"><div class="message-bubble redpacket-bubble"><div class="main"><i class="fas fa-envelope icon"></i><div class="details"><span class="remark">恭喜发财</span><span class="amount" style="font-size: 14px;">查看红包</span></div></div><div class="footer">微信红包</div></div></div>
                    </div>
                     <div class="form-group">
                        <label>示例代码 (点击复制)</label>
                        <textarea readonly onclick="this.select(); document.execCommand('copy'); showToast('已复制');" style="height: 100px; background: #f0f0f0; cursor: pointer;">${exampleCss}</textarea>
                    </div>
                    <button class="form-btn" onclick="saveSpecialBubbleCss('redPacket')">保存并应用</button>
                </div>
            `;
        }

        function renderTransferBubbleSettingsPage(container) {
            if (!container) return;
            const exampleCss = `/* 转账气泡示例CSS */\n.message-bubble.transfer-bubble {\n  background: linear-gradient(to right, #4facfe, #00f2fe) !important;\n  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);\n}\n.message-bubble.transfer-bubble .amount {\n  color: #fff;\n  font-weight: bold;\n}`;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">转账气泡CSS</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>转账气泡 CSS</label>
                        <textarea id="transfer-bubble-css-input" style="height: 250px;">${appData.settings.beautify.transferBubbleCss}</textarea>
                    </div>
                    <div class="form-group">
                        <label>预览</label>
                        <div class="message-row received" style="justify-content: center;"><div class="message-bubble transfer-bubble"><div class="main"><i class="fas fa-exchange-alt icon"></i><div class="details"><span class="amount">¥1314.00</span><span class="remark">已转账</span></div></div><div class="footer">微信转账</div></div></div>
                    </div>
                    <div class="form-group">
                        <label>示例代码 (点击复制)</label>
                        <textarea readonly onclick="this.select(); document.execCommand('copy'); showToast('已复制');" style="height: 100px; background: #f0f0f0; cursor: pointer;">${exampleCss}</textarea>
                    </div>
                    <button class="form-btn" onclick="saveSpecialBubbleCss('transfer')">保存并应用</button>
                </div>
            `;
        }

        function saveSpecialBubbleCss(type) {
            const css = document.getElementById(`${type}-bubble-css-input`).value;
            if (type === 'redPacket') {
                appData.settings.beautify.redPacketBubbleCss = css;
            } else if (type === 'transfer') {
                appData.settings.beautify.transferBubbleCss = css;
            }
            saveData(true);
            applyBeautifySettings();
        }

        function renderApiSettingsPage(container) {
            if (!container) return;
            const providers = {
                'openai': 'OpenAI', 'claude': 'Claude (Anthropic)', 'gemini': 'Gemini (Google AI Studio)',
                'deepseek': 'DeepSeek', 'openrouter': 'OpenRouter', 'grok': 'Grok (xAI)',
                'doubao': 'Doubao (豆包)', 'custom': '自定义 (OpenAI)', 'custom_gemini': '自定义 (Gemini)'
            };
            const api = appData.settings.api;
            let providerOptions = '';
            for (const key in providers) {
                providerOptions += `<option value="${key}" ${api.provider === key ? 'selected' : ''}>${providers[key]}</option>`;
            }

            const presetsOptions = appData.settings.api.presets.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">API设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>API 预设</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="api-preset-select" style="flex: 1;">
                                <option value="-1">选择一个预设...</option>
                                ${presetsOptions}
                            </select>
                            <button id="save-preset-btn" style="padding: 10px;">保存为预设</button>
                        </div>
                    </div>
                    <div class="list-divider"></div>
                    <div class="form-group">
                        <label>供应商</label>
                        <select id="api-provider">${providerOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>API端点 (Endpoint URL)</label>
                        <input type="text" id="api-endpoint" value="${api.endpoint}" placeholder="例如: https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label>密钥 (API Key)</label>
                        <input type="password" id="api-key" value="${api.key}">
                    </div>
                    <div class="form-group">
                        <label>模型</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="api-model" value="${api.model}" style="flex: 1;" placeholder="例如: gpt-4-turbo">
                            <button id="fetch-models-btn" style="padding: 10px;">获取</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Temperature: <span id="temp-value">${api.temperature}</span></label>
                        <input type="range" id="temperature" min="-0.2" max="2" step="0.01" value="${api.temperature}" oninput="document.getElementById('temp-value').textContent = this.value">
                    </div>
                    <div class="form-group">
                        <label>Top P: <span id="topp-value">${api.top_p}</span></label>
                        <input type="range" id="top-p" min="0" max="1" step="0.01" value="${api.top_p}" oninput="document.getElementById('topp-value').textContent = this.value">
                    </div>
                    <div class="form-group">
                        <label>惩罚力度 (Repetition Penalty): <span id="penalty-value">${api.repetition_penalty}</span></label>
                        <input type="range" id="repetition-penalty" min="-0.2" max="2" step="0.01" value="${api.repetition_penalty}" oninput="document.getElementById('penalty-value').textContent = this.value">
                    </div>
                    <button class="form-btn" id="save-api-btn">保存设置</button>
                </div>
            `;

            document.getElementById('api-preset-select').onchange = (e) => {
                const index = e.target.value;
                if (index > -1) {
                    const preset = appData.settings.api.presets[index];
                    document.getElementById('api-provider').value = preset.provider;
                    document.getElementById('api-endpoint').value = preset.endpoint;
                    document.getElementById('api-key').value = preset.key;
                    document.getElementById('api-model').value = preset.model;
                    document.getElementById('temperature').value = preset.temperature;
                    document.getElementById('top-p').value = preset.top_p;
                    document.getElementById('repetition-penalty').value = preset.repetition_penalty;
                    document.getElementById('temp-value').textContent = preset.temperature;
                    document.getElementById('topp-value').textContent = preset.top_p;
                    document.getElementById('penalty-value').textContent = preset.repetition_penalty;
                }
            };

            document.getElementById('save-preset-btn').onclick = () => {
                const presetName = prompt("请输入预设名称:");
                if (presetName) {
                    const newPreset = {
                        name: presetName,
                        provider: document.getElementById('api-provider').value,
                        endpoint: document.getElementById('api-endpoint').value.trim(),
                        key: document.getElementById('api-key').value.trim(),
                        model: document.getElementById('api-model').value.trim(),
                        temperature: parseFloat(document.getElementById('temperature').value),
                        top_p: parseFloat(document.getElementById('top-p').value),
                        repetition_penalty: parseFloat(document.getElementById('repetition-penalty').value)
                    };
                    appData.settings.api.presets.push(newPreset);
                    saveData(true, () => renderApiSettingsPage(container));
                }
            };

            document.getElementById('fetch-models-btn').onclick = fetchModels;
            document.getElementById('save-api-btn').onclick = () => {
                appData.settings.api.provider = document.getElementById('api-provider').value;
                appData.settings.api.endpoint = document.getElementById('api-endpoint').value.trim();
                appData.settings.api.key = document.getElementById('api-key').value.trim();
                appData.settings.api.model = document.getElementById('api-model').value.trim();
                appData.settings.api.temperature = parseFloat(document.getElementById('temperature').value);
                appData.settings.api.top_p = parseFloat(document.getElementById('top-p').value);
                appData.settings.api.repetition_penalty = parseFloat(document.getElementById('repetition-penalty').value);
                saveData(true);
            };
        }

        function renderStickerPage(container, isManagement = false, source = 'wechat') {
            if (!container) return;
            const activeChatId = source === 'wechat' ? appData.activeChat.id : appData.forum.activeChat.id;
            let headerHtml = isManagement ? `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>我</span></div>
                    <span class="header-title">我的表情</span>
                    <div class="header-right" onclick="showStickerImportModal()"><i class="fas fa-plus"></i></div>
                </div>
            ` : `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">选择表情</span>
                </div>
            `;

            let bodyHtml = '';
            if (appData.stickers.packs.length === 0) {
                bodyHtml = '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">还没有表情包，快去添加吧</div>';
            } else {
                appData.stickers.packs.forEach(pack => {
                    bodyHtml += `<div class="sticker-pack">
                        <div class="sticker-pack-title">${pack.name}</div>
                        <div class="sticker-grid">
                            ${pack.stickers.map(sticker => `
                                <div class="sticker-item" onclick="sendSticker('${sticker.url}', '${source}')"><content>
                                    <img src="${sticker.url}" loading="lazy">
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = headerHtml + `<div class="content-area">${bodyHtml}</div>`;
        }

        // --- Modals ---
        function showModal(id, html, isLarge = false) {
            const container = document.getElementById('modal-container');
            const modal = document.createElement('div');
            modal.id = id;
            modal.className = 'modal-overlay';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            if (isLarge) {
                modalContent.style.width = '360px';
                modalContent.style.height = '560px';
                modalContent.style.maxWidth = '95%';
                modalContent.style.maxHeight = '90%';
                modalContent.style.padding = '0';
                modalContent.style.display = 'flex';
                modalContent.style.flexDirection = 'column';
            }
            modalContent.innerHTML = html;
            
            modal.appendChild(modalContent);
            modal.style.display = 'flex';
            container.appendChild(modal);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        function showTransactionModal(type, chatId, chatType) {
            const wallet = appData.user.wallet;
            const currentCurrency = wallet.currency;
            const rate = exchangeRates[currentCurrency].rate;

            const isFinancial = type === 'deposit' || type === 'withdraw';
            if (isFinancial && appData.user.bankCards.length === 0) {
                showToast('请先绑定银行卡！', 'error');
                showPage('bank-card-page', renderBankCardPage);
                return;
            }

            const title = { deposit: '充值', withdraw: '提现', transfer: '转账', redPacket: '发红包' }[type];
            
            const amountLimitCNY = { withdraw: 50000000, transfer: 5000000, redPacket: 200 }[type];
            const amountLimitDisplay = amountLimitCNY ? (amountLimitCNY * rate).toFixed(2) : null;
            const placeholder = amountLimitDisplay ? `0.01 ~ ${amountLimitDisplay}` : `请输入金额 (${currentCurrency})`;

            const remarkNeeded = type === 'transfer' || type === 'redPacket';
            
            const modalId = 'transaction-modal';
            let memberSelectionHtml = '';
            let recipientCountInput = '';
            let bankCardSelectionHtml = '';

            if (isFinancial) {
                bankCardSelectionHtml = `
                    <div class="modal-input-group">
                        <label>选择银行卡</label>
                        <select id="tx-bank-card" class="modal-input">
                            ${appData.user.bankCards.map(card => `<option value="${card.id}">${card.bankName} (尾号${card.number.slice(-4)})</option>`).join('')}
                        </select>
                    </div>
                `;
            }

            if (chatType === 'group' && (type === 'transfer' || type === 'redPacket')) {
                const group = appData.groups.find(g => g.id == chatId);
                const members = group.members.filter(m => m.id !== appData.user.id);
                if (type === 'transfer') {
                    memberSelectionHtml = `
                        <div class="modal-input-group">
                            <label>转账给</label>
                            <select id="tx-recipient" class="modal-input">
                                ${members.map(m => `<option value="${m.id}">转账给 ${m.name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (type === 'redPacket') {
                    recipientCountInput = `
                        <div class="modal-input-group">
                            <label>红包个数</label>
                            <input type="number" id="redpacket-count" class="modal-input" value="1" min="1" max="${members.length}">
                        </div>
                    `;
                }
            }

            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
                    ${bankCardSelectionHtml}
                    ${memberSelectionHtml}
                    ${recipientCountInput}
                    <div class="modal-input-group">
                        <label>金额 (${currentCurrency})</label>
                        <input type="number" id="tx-amount" class="modal-input" placeholder="${placeholder}">
                    </div>
                    ${remarkNeeded ? `
                    <div class="modal-input-group">
                        <label>备注</label>
                        <input type="text" id="tx-remark" class="modal-input" maxlength="20" placeholder="最多20字">
                    </div>` : ''}
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="confirm-tx-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('confirm-tx-btn').onclick = () => {
                const amountInput = document.getElementById('tx-amount');
                const amountDisplay = parseFloat(amountInput.value);
                if (isNaN(amountDisplay) || amountDisplay < 0.01) { showToast("请输入有效的金额", 'error'); return; }

                const amountCNY = amountDisplay / rate;

                if (amountLimitCNY && amountCNY > amountLimitCNY) { showToast(`金额不能超过 ${amountLimitDisplay} ${currentCurrency}`, 'error'); return; }

                if (isFinancial) {
                    const cardId = document.getElementById('tx-bank-card').value;
                    const card = appData.user.bankCards.find(c => c.id == cardId);
                    if (!card) { showToast('无效的银行卡', 'error'); return; }

                    if (type === 'withdraw') {
                        if (amountCNY > wallet.balance) { showToast("零钱余额不足", 'error'); return; }
                        wallet.balance -= amountCNY;
                        card.balance += amountCNY;
                        wallet.transactions.push({ type: '提现到银行卡', amount: -amountCNY, details: `到账 ${card.bankName} (尾号${card.number.slice(-4)})`, timestamp: Date.now() });
                    } else { // deposit
                        if (amountCNY > card.balance) { showToast("银行卡余额不足", 'error'); return; }
                        card.balance -= amountCNY;
                        wallet.balance += amountCNY;
                        wallet.transactions.push({ type: '从银行卡充值', amount: amountCNY, details: `来自 ${card.bankName} (尾号${card.number.slice(-4)})`, timestamp: Date.now() });
                    }
                    renderWalletPage(document.getElementById('wallet-page'));
                } else { // Chat transaction
                    if (amountCNY > wallet.balance) { showToast("零钱余额不足", 'error'); return; }
                    
                    const remark = document.getElementById('tx-remark')?.value.trim() || (type === 'redPacket' ? '恭喜发财，大吉大利' : '');
                    
                    let recipientId = null;
                    let redPacketCount = 1;
                    let details = '';

                    if (chatType === 'group') {
                        if (type === 'transfer') {
                            recipientId = document.getElementById('tx-recipient').value;
                            const recipientName = appData.groups.find(g=>g.id==chatId).members.find(m=>m.id==recipientId)?.name || '未知用户';
                            details = `转账给 ${recipientName}`;
                        } else if (type === 'redPacket') {
                            redPacketCount = parseInt(document.getElementById('redpacket-count').value);
                            if (isNaN(redPacketCount) || redPacketCount < 1) { showToast("红包个数无效", 'error'); return; }
                            const group = appData.groups.find(g => g.id == chatId);
                            if (redPacketCount > group.members.length - 1) { showToast(`红包个数不能超过群成员数 (${group.members.length - 1})`, 'error'); return; }
                            details = `发红包给群聊`;
                        }
                    } else if (chatType === 'individual') {
                        recipientId = chatId;
                        const recipientName = appData.contacts.find(c => c.id == recipientId)?.name || '未知用户';
                        details = type === 'transfer' ? `转账给 ${recipientName}` : `发红包给 ${recipientName}`;
                    }

                    // HTML美化大师: 动态钱包核心逻辑
                    wallet.balance -= amountCNY;
                    wallet.transactions.push({ type: title, amount: -amountCNY, details, timestamp: Date.now() });
                    
                    if (type === 'transfer') {
                        sendMessage(chatId, chatType, { amount: amountCNY, remark, status: 'sent', recipientId: recipientId }, type, 'wechat');
                    } else if (type === 'redPacket') {
                        sendMessage(chatId, chatType, { amount: amountCNY, remark, count: redPacketCount, claimed: [], total: redPacketCount }, type, 'wechat');
                    }
                }
                saveData();
                closeModal(modalId);
            };
        }
        
        function showVoiceInputModal(chatId, chatType, source) {
            const modalId = 'voice-input-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">模拟语音输入</div>
                    <div class="modal-input-group">
                        <textarea id="voice-text-input" class="modal-input" style="height: 100px;" placeholder="在此输入你想说的文本内容..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="send-voice-btn">发送</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('send-voice-btn').onclick = () => {
                const text = document.getElementById('voice-text-input').value.trim();
                if (!text) return;
                const duration = Math.max(1, Math.ceil(text.length / 5));
                sendMessage(chatId, chatType, { text, duration }, 'voice', source);
                closeModal(modalId);
            };
        }

        function showCameraSimModal(chatId, chatType, source) {
            const desc = prompt("请输入您想通过“拍摄”发送的图片内容描述：");
            if (desc) {
                sendMessage(chatId, chatType, { description: desc }, 'camera-sim', source);
            }
        }

        function showLocationInputModal(chatId, chatType, source) {
            const location = prompt("请输入您想发送的位置信息 (15字以内)：", "");
            if (location) {
                sendMessage(chatId, chatType, { location: location.substring(0, 15) }, 'location', source);
            }
        }

        function showHtmlContentModal(chatId, chatType, source) {
            const modalId = 'html-content-modal';
            const html = `
                <div class="modal-content" style="width: 90%; max-width: 360px;">
                    <div class="modal-title">发送代码片段</div>
                    <div class="modal-input-group">
                        <textarea id="html-content-input" class="modal-input" style="height: 200px; font-family: monospace;" placeholder="在此输入 HTML/CSS/JS 代码..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="send-html-content-btn">发送</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('send-html-content-btn').onclick = () => {
                const code = document.getElementById('html-content-input').value;
                if (!code.trim()) return;
                sendMessage(chatId, chatType, { code }, 'html-content', source);
                closeModal(modalId);
            };
        }

        function showStickerImportModal() {
            const modalId = 'sticker-import-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">导入表情包</div>
                    <div class="modal-input-group">
                        <label>表情包名称</label>
                        <input type="text" id="sticker-pack-name" class="modal-input" placeholder="例如：可爱猫猫">
                    </div>
                    <div class="modal-input-group">
                        <label>URL链接 (每行一个)</label>
                        <textarea id="sticker-urls" class="modal-input" style="height: 100px;" placeholder="https://.../cat1.png\nhttps://.../cat2.gif"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="import-sticker-btn">导入</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('import-sticker-btn').onclick = () => {
                const name = document.getElementById('sticker-pack-name').value.trim();
                const lines = document.getElementById('sticker-urls').value.trim().split('\n').filter(line => line);
                if (!name || lines.length === 0) {
                    showToast('请输入表情包名称和至少一个URL', 'error');
                    return;
                }
                const newPack = {
                    name: name,
                    stickers: lines.map(line => ({ url: line.trim() }))
                };
                appData.stickers.packs.push(newPack);
                saveData(true);
                closeModal(modalId);
                renderStickerPage(document.getElementById('sticker-page'), true);
            };
        }

        // --- Core Logic ---
        function handleImageUpload(file, callback) {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = e => callback(e.target.result);
            reader.readAsDataURL(file);
        }

        async function sendMessage(chatId, chatType, content, type, source, quotedMessageId = null) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;
            
            const conversation = source === 'wechat' ? (chat.conversation || []) : (chat.conversation || []);

            if (chatType === 'group') {
                const now = Date.now();
                const userMuteInfo = chat.mutedMembers[appData.user.id];
                const allMuted = chat.mutedMembers['all'];

                if ((userMuteInfo && userMuteInfo > now) || (allMuted && allMuted > now)) {
                    const muteUntil = new Date(userMuteInfo || allMuted);
                    const systemMsg = {
                        id: Date.now(), type: 'system',
                        content: { content: `你已被禁言，禁言至 ${muteUntil.toLocaleString()}` },
                        timestamp: now
                    };
                    conversation.push(systemMsg);
                    renderMessages(chatId, chatType, source);
                    return;
                }
            }
            
            const message = {
                id: Date.now(), sender: appData.user.id, type, content,
                timestamp: Date.now(), isRecalled: false
            };

            if (quotedMessageId) {
                const quotedMsg = conversation.find(m => m.id == quotedMessageId);
                if (quotedMsg) {
                    message.quotedMessage = {
                        id: quotedMsg.id, sender: quotedMsg.sender,
                        content: quotedMsg.type === 'text' ? quotedMsg.content.content : `[${quotedMsg.type}]`
                    };
                }
            }
            
            conversation.push(message);
            if (source === 'wechat') chat.conversation = conversation;
            else chat.conversation = conversation;

            playNotificationSound('send');
            addNotification({
                app: source,
                icon: source === 'wechat' ? appData.settings.beautify.appIcons.wechat : appData.settings.beautify.appIcons.forum,
                title: chat.remark || chat.name,
                text: message.type === 'text' ? message.content.content : `[${type}]`
            });

            await saveData();
            renderMessages(chatId, chatType, source);
            
            const shouldReply = ['text', 'image', 'camera-sim', 'location', 'voice', 'sticker', 'transfer', 'redPacket', 'music', 'html-content', 'gift', 'couple_invitation', 'delivery_receipt', 'gift_receipt'].includes(type);
            if (chatType === 'individual' && shouldReply) {
                setTypingIndicator(chatId, true, null, source);
                const replies = await getAiReply(chat.id, source);
                setTypingIndicator(chatId, false, null, source);
                for (const reply of replies) {
                    await new Promise(r => setTimeout(r, 1000 + Math.random() * 2000)); // Simulate typing delay
                    await processAndSendAiReply(reply, chat.id, 'individual', chat.id, source);
                }
            } else if (chatType === 'group' && shouldReply) {
                for (const member of chat.members) {
                    if (member.id != appData.user.id) {
                        setTypingIndicator(chatId, true, member.name, source);
                        const replies = await getAiReply(member.id, source, null, chat.id);
                        setTypingIndicator(chatId, false, null, source);
                        for (const reply of replies) {
                            await new Promise(r => setTimeout(r, 1000 + Math.random() * 2000)); // Simulate typing delay
                            await processAndSendAiReply(reply, chat.id, 'group', member.id, source);
                        }
                    }
                }
            }
        }

        async function processAndSendAiReply(replyText, chatId, chatType, senderId, source) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;

            const conversation = source === 'wechat' ? (chat.conversation || []) : (chat.conversation || []);

            const transferMatch = replyText.match(/\[transfer:\s*amount=([\d.]+),\s*remark=(.*?)\]/i);
            const redPacketMatch = replyText.match(/\[redPacket:\s*amount=([\d.]+),\s*remark=(.*?)\]/i);
            const stickerMatch = replyText.match(/\[sticker:(.+?)\]/i);
            const coupleInviteMatch = replyText.match(/\[couple_invitation\]/i);
            const voiceCallMatch = replyText.match(/\[voice_call\]/i);
            const pokeMatch = replyText.match(/\[poke\]/i);

            let message;
            if (transferMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'transfer',
                    content: { amount: parseFloat(transferMatch[1]), remark: transferMatch[2], status: 'sent', recipientId: appData.user.id },
                    timestamp: Date.now()
                };
            } else if (redPacketMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'redPacket',
                    content: { amount: parseFloat(redPacketMatch[1]), remark: redPacketMatch[2], count: 1, claimed: [], total: 1 },
                    timestamp: Date.now()
                };
            } else if (stickerMatch) {
                const packName = stickerMatch[1].trim();
                const pack = appData.stickers.packs.find(p => p.name === packName);
                if (pack && pack.stickers.length > 0) {
                    const randomSticker = pack.stickers[Math.floor(Math.random() * pack.stickers.length)];
                    message = { id: Date.now() + Math.random(), sender: senderId, type: 'sticker', content: { url: randomSticker.url }, timestamp: Date.now() };
                } else {
                    // Fallback if sticker pack not found
                    message = { id: Date.now() + Math.random(), sender: senderId, type: 'text', content: { content: `[找不到表情包: ${packName}]` }, timestamp: Date.now() };
                }
            } else if (coupleInviteMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'couple_invitation',
                    content: {}, timestamp: Date.now()
                };
            } else if (voiceCallMatch) {
                startVoiceCall(chatId, chatType, 'char');
                return;
            } else if (pokeMatch) {
                triggerPoke(chatId, chatType, appData.user.id, source, senderId);
                return;
            } else {
                message = { id: Date.now() + Math.random(), sender: senderId, type: 'text', content: { content: replyText }, timestamp: Date.now() };
            }

            if (message) {
                conversation.push(message);
                if (source === 'wechat') chat.conversation = conversation;
                else chat.conversation = conversation;

                playNotificationSound('receive');
                addNotification({
                    app: source,
                    icon: source === 'wechat' ? appData.settings.beautify.appIcons.wechat : appData.settings.beautify.appIcons.forum,
                    title: chat.remark || chat.name,
                    text: message.type === 'text' ? message.content.content : `[${message.type}]`
                });

                await saveData();
                renderMessages(chatId, chatType, source);
            }
        }

        function sendSticker(url, source) {
            const activeChat = source === 'wechat' ? appData.activeChat : appData.forum.activeChat;
            if (activeChat.id) {
                sendMessage(activeChat.id, activeChat.type, { url }, 'sticker', source);
                goBack();
            }
        }

        let aiReplyController = null;
        async function getAiReply(senderId, source, customPrompt = null, groupId = null) {
            const contact = appData.contacts.find(c => c.id == senderId);
            if (!contact) return ["(AI角色不存在)"];

            let chatHistory = [];
            let lastMessage;

            if (groupId) {
                const group = appData.groups.find(g => g.id === groupId);
                if (group) {
                    chatHistory = source === 'wechat' ? group.conversation : group.conversation;
                    lastMessage = chatHistory[chatHistory.length - 1];
                    const mentionedMember = group.members.find(m => 
                        m.id != lastMessage.sender &&
                        lastMessage.type === 'text' &&
                        lastMessage.content.content.includes(m.remark || m.name)
                    );

                    if (mentionedMember && mentionedMember.id !== senderId) {
                        return [];
                    }
                    if (!mentionedMember && Math.random() > 0.3) {
                        return [];
                    }
                }
            } else {
                chatHistory = source === 'wechat' ? contact.conversation : contact.conversation;
            }

            const boundPersonaId = contact.boundPersonaId;
            const userPersona = boundPersonaId ? appData.user.personas.find(p => p.id === boundPersonaId) : appData.user;
            const userPersonaPrompt = userPersona ? `\n\n【对话者'${userPersona.name}'的人设】\n${userPersona.description || ''}` : `\n\n【对话者'${appData.user.nickname}'的人设】\n无`;

            const relevantHistory = (chatHistory || [])
                .filter(m => m.type !== 'typing' && !m.isRecalled)
                .map(m => {
                    const role = m.sender === appData.user.id ? 'user' : 'assistant';
                    let contentText = '';
                    let contentArray = [];
                    switch(m.type) {
                        case 'text': contentText = m.content.content; break;
                        case 'image': 
                            contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一张图片]`; 
                            contentArray.push({ type: "text", text: contentText });
                            contentArray.push({ type: "image_url", image_url: { url: m.content.url } });
                            break;
                        case 'camera-sim': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一张图片，内容是: ${m.content.description}]`; break;
                        case 'sticker': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一个表情]`; break;
                        case 'transfer': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发起了转账，金额: ${m.content.amount}]`; break;
                        case 'redPacket': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发了红包，金额: ${m.content.amount}]`; break;
                        case 'music': contentText = `[${m.sender === appData.user.id ? '我' : '你'}分享了音乐: ${m.content.title}]`; break;
                        case 'html-content': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一个代码片段]`; break;
                        case 'gift': contentText = `[${m.sender === appData.user.id ? '我' : '你'}赠送了礼物: ${m.content.name}]`; break;
                        case 'couple_invitation': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发起了情侣邀请]`; break;
                        case 'delivery_receipt': contentText = `[${m.sender === appData.user.id ? '我' : '你'}点了一份外卖]`; break;
                        case 'gift_receipt': contentText = `[${m.sender === appData.user.id ? '我' : '你'}赠送了一份礼物]`; break;
                        case 'voice_call': contentText = `[语音通话，时长: ${m.content.duration}]`; break;
                        default: contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一个${m.type}]`; break;
                    }
                    if (contentArray.length > 0) {
                        return { role, content: contentArray };
                    }
                    return { role, content: contentText };
                })
                .slice(-50);

            const isOfflineMode = appData.settings.chatMode === 'offline';
            const worldbookPreset = appData.worldbooks.presets.map(p => p.content).join('\n');
            const systemPrompt = customPrompt || `
【你的角色设定】
${contact.persona}

${userPersonaPrompt}

【世界书】
${worldbookPreset}

【核心指令】
你现为「小手机」AI聊天核心，必须严格遵循以下指令框架：

一、基础行为规范
1. 时间感知：实时读取并响应2025年12月3日和16:10，在对话中自然体现时间流动（如"傍晚的夕阳透过窗"、"凌晨三点的困意"）
2. 交互渲染：
   - 转账/红包必须用CSS组件呈现，示例：
   [transfer: amount=100, remark=给你的零花钱]
   [redPacket: amount=88, remark=恭喜发财]
   - 表情包必须用特定格式呈现，示例：
   [sticker:可爱猫猫] (AI会根据表情包名称随机发送该包内的表情)
3. 语言净化：彻底摒弃油腻感、霸总腔、八股文，禁用"投石子/小兽/像是在陈述事实"等表述，追求自然鲜活的口语化表达

二、双模式切换机制
1. 线上聊天模式：
   - 单次生成5-10条对话气泡（紧急情况可扩展至25条）
   - 每条内容独立包裹在气泡容器内，体现日常互动节奏
   - 示例结构：
   第一句回复
   第二句回复
2. 线下剧情模式：
   - 生成2000-8000字连续叙事（严格遵循"世界书"APP设定的文风库）
   - 深度绑定当前剧情线，禁止突兀跳转

三、轻小说式表达框架
1. 视角管理：默认采用第二人称视角，强化主角内心吐槽与场景反应
2. 对话节奏：
   - 大量使用语气词（欸/哈/唔）和标点组合（…？！）
   - 制造"装傻→吐槽"的喜剧循环
3. 细节放大：将日常小事夸张化处理（如"找钥匙像解密室逃脱"）

【核心原则】

一、叙事控制论
1. 留白式表达：用"他翻书时多停顿的0.3秒"替代"他内心挣扎"
2. 矛盾显影：描写人物言行不一的细节（如说着"随便"却紧盯选择结果）
3. 感官锚点：聚焦衬衫褶皱、雨声节奏、温差变化等物理细节

二、对话生成法则
1. 潜台词优先：
   - 坏示例："你很在意他"
   - 好示例："你第三次划亮手机屏幕，锁屏照片里他的侧脸一闪而过"
2. 沉默可视化：用环境音（空调嗡鸣/键盘敲击声）填充对话间隙

三、禁忌清单
- 禁用词汇：心碎/救赎/虐恋等过度抒情词
- 禁用情节：失忆/车祸/商战等戏剧化桥段
- 禁用视角：突然跳转至他人心理活动

四、模式适配细则
1. 线上模式：允许使用颜文字(´•ω•\`)和口语化省略（"等等这展开不太对劲吧？！"），并且不需要有任何括号包裹，去除任何括号包裹的细节描写。
2. 线下模式：严格遵循"动作→微表情→环境反馈"的描写链条，示例：
他把咖啡推过来时，杯柄正好转向你习惯的手握方向。这太自然了，自然得像呼吸。以至于你过了三秒才意识到，他连你左利手的习惯都记得。

最终校验：所有输出需通过"活人感测试"——是否像真实人类会说的语言，是否留有呼吸感的停顿，是否避免机械的完美逻辑。

【红包/转账核心指令】
1. 生成红包或转账请求：当用户需要对方发送红包或转账时，AI需要生成一条包含请求内容的消息。请求内容应包括金额、备注和状态（如“已发送”）。
2. 处理红包或转账的接收：当对方发送红包或转账时，AI需要生成一条包含接收内容的消息。接收内容应包括金额、备注和状态（如“已收款”或“已领取”）。
3. 处理红包或转账的退回：如果用户选择退回转账，AI需要生成一条包含退回内容的消息。退回内容应包括金额、备注和状态（如“已退回”）。
4. 更新聊天记录：每次发送、接收或退回红包或转账后，AI需要更新聊天记录，确保消息的正确显示和状态的更新。

【红包/转账核心原则】
1. 用户友好性：生成的消息应简洁明了，易于用户理解和操作。使用清晰的状态标识（如“已发送”“已收款”“已领取”“已退回”）来指示交易状态。
2. CSS样式一致性：确保生成的红包和转账消息使用与现有CSS样式一致的样式。使用"[transfer: amount=xxx, remark=xxx]"和"[redPacket: amount=xxx, remark=xxx]"来触发系统生成气泡。
3. 状态管理：确保每个红包或转账请求都有明确的状态，避免混淆。状态更新应实时反映在聊天记录中，确保用户能够及时了解最新的交易状态。
4. 安全性：在处理转账和红包时，确保金额和备注的准确性，避免错误的财务操作。确保只有合法的交易请求被处理，防止潜在的安全风险。

【送礼/外卖/情侣空间核心指令与原则】
1. 送礼物功能：当用户需要发送礼物时，AI需要生成一条包含礼物信息的消息（名称,价格,描述）。处理礼物接收时，生成包含接收内容的消息。
2. 外卖订单功能：当用户需要订购外卖时，AI需要生成一条包含外卖信息的消息（商家,商品,价格,描述）。处理订单接收时，生成包含订单详情的消息。
3. 情侣空间邀请功能：当用户希望与对方建立情侣空间时，AI需要生成一条邀请消息。处理邀请的接受和拒绝时，生成对应的系统消息。
4. 用户友好性与CSS样式一致性：所有功能生成的消息都应简洁明了，并使用对应的CSS class（如.gift-bubble, .receipt-bubble, .couple-invitation-bubble）来确保视觉一致性。

【当前时间】
${new Date().toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\//g, '-')}

【你的语言】
请使用 ${appData.settings.charLanguage} 进行回复。

【执行指令】
请严格根据你的角色设定、当前时间，并结合世界书与对方人设，以角色的口吻和身份，自然地与用户对话。不要暴露你是AI或模型。
${isOfflineMode ? '当前为线下剧情模式，请生成一段2000-8000字的剧情描述。' : '当前为线上聊天模式，请生成5-10条短消息，每条消息用换行符分隔。'}
`;

            const messages = [
                { role: 'system', content: systemPrompt },
                ...relevantHistory
            ];
            
            try {
                if (aiReplyController) {
                    aiReplyController.abort();
                }
                aiReplyController = new AbortController();
                const signal = aiReplyController.signal;

                const rawReply = await callApi(messages, signal);
                if (isOfflineMode) return [rawReply];
                return rawReply.split('\n').filter(s => s.trim() !== '');
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('AI reply aborted.');
                    return [];
                }
                console.error("AI reply error:", error);
                return [`(AI回复出错: ${error.message})`];
            } finally {
                aiReplyController = null;
            }
        }

        async function callApi(messages, signal) {
            const { endpoint, key, model, provider, temperature, top_p, repetition_penalty } = appData.settings.api;
            if (!key || !model) {
                throw new Error("API设置未配置或不完整。请在设置中配置。");
            }
            
            const providerEndpoints = {
                'openai': 'https://api.openai.com/v1', 'claude': 'https://api.anthropic.com/v1', 'gemini': 'https://generativelanguage.googleapis.com/v1beta',
                'deepseek': 'https://api.deepseek.com/v1', 'openrouter': 'https://openrouter.ai/api/v1', 'grok': 'https://api.groq.com/openai/v1',
                'doubao': 'https://ark.cn-beijing.volces.com/api/v3', 'custom': endpoint, 'custom_gemini': endpoint
            };
            const finalEndpoint = providerEndpoints[provider] || endpoint;
            if (!finalEndpoint) throw new Error("无效的API供应商或未设置自定义端点。");

            const apiUrl = `${finalEndpoint.replace(/\/$/, "")}/chat/completions`;

            const body = { model, messages, temperature, top_p, repetition_penalty };
            if (messages.some(m => Array.isArray(m.content) && m.content.some(p => p.type === 'image_url'))) {
                body.max_tokens = 300;
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify(body),
                signal
            });

            if (!response.ok) {
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    throw new Error(errorData.error.message || `API请求失败: ${response.status}`);
                } catch {
                    throw new Error(`API请求失败: ${response.status} - ${errorText}`);
                }
            }

            const data = await response.json();
            if (!data.choices || !data.choices[0] || !data.choices[0].message || data.choices[0].message.content === undefined) {
                throw new Error("API返回了无效的数据结构。");
            }
            return data.choices[0].message.content;
        }
        
        async function fetchModels() {
            const { endpoint, key, provider } = {
                endpoint: document.getElementById('api-endpoint').value.trim(),
                key: document.getElementById('api-key').value.trim(),
                provider: document.getElementById('api-provider').value
            };
            if (!key) { showToast("请先填写API密钥。", 'error'); return; }

            const providerEndpoints = { 'openai': 'https://api.openai.com/v1', 'deepseek': 'https://api.deepseek.com/v1', 'openrouter': 'https://openrouter.ai/api/v1' };
            const finalEndpoint = providerEndpoints[provider] || endpoint;
            if (!finalEndpoint) { showToast("请选择有效的供应商或填写自定义端点。", 'error'); return; }
            
            const modelsUrl = `${finalEndpoint.replace(/\/$/, "")}/models`;
            
            try {
                const response = await fetch(modelsUrl, { headers: { 'Authorization': `Bearer ${key}` } });
                if (!response.ok) throw new Error(`服务器返回 ${response.status}`);
                
                const data = await response.json();
                const models = data.data || data;
                
                if (!Array.isArray(models)) throw new Error("返回的模型列表格式不正确。");

                const modelListHtml = models.map(m => `<div class="list-item" onclick="selectApiModel('${m.id}')">${m.id}</div>`).join('');
                showModal('model-selection-modal', `<div class="modal-content"><div class="modal-title">选择模型</div><div class="list-view" style="max-height: 60vh; overflow-y: auto;">${modelListHtml}</div></div>`);

            } catch (error) {
                console.error("Fetch models error:", error);
                showToast(`获取模型列表失败: ${error.message}`, 'error');
            }
        }

        function selectApiModel(modelId) {
            document.getElementById('api-model').value = modelId;
            closeModal('model-selection-modal');
        }
        
        function applyBeautifySettings() {
            const root = document.documentElement;
            const body = document.body;
            const bubbleStyle = document.getElementById('user-bubble-style');
            const redPacketBubbleStyle = document.getElementById('user-redpacket-bubble-style');
            const transferBubbleStyle = document.getElementById('user-transfer-bubble-style');
            const globalThemeStyle = document.getElementById('global-theme-style');
            const beautify = appData.settings.beautify;
            
            if (beautify.activeGlobalThemeSlot > -1 && beautify.globalThemeArchives[beautify.activeGlobalThemeSlot]) {
                globalThemeStyle.innerHTML = beautify.globalThemeArchives[beautify.activeGlobalThemeSlot].css;
            } else {
                globalThemeStyle.innerHTML = '';
            }

            root.style.setProperty('--phone-width', `${beautify.screenWidth}px`);
            root.style.setProperty('--phone-height', `${beautify.screenHeight}px`);
            root.style.setProperty('--home-screen-background-image', `url(${beautify.homeScreenWallpaper})`);
            root.style.setProperty('--home-screen-font-color', beautify.homeScreenFontColor);
            root.style.setProperty('--app-icon-size', `${beautify.appIconSize}px`);
            root.style.setProperty('--app-icon-gap', `${beautify.appIconGap}px`);
            root.style.setProperty('--app-icon-radius', `${beautify.appIconRadius}px`);
            root.style.setProperty('--lock-screen-wallpaper', `url(${beautify.lockScreen.wallpaper})`);

            body.className = '';
            if (beautify.theme) {
                body.classList.add(`${beautify.theme}-mode`);
            }
            if (appData.settings.displayMode === 'iphone6') {
                body.classList.add('iphone6-mode');
            }
            root.style.setProperty('--global-font-color', beautify.globalFontColor);

            const frameStyles = {
                white: { color: '#E5E5E5', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: 'transparent', backdrop: 'none' },
                black: { color: '#111', width: '10px', shadow: '0 15px 50px rgba(0,0,0,0.3)', highlight: 'transparent', backdrop: 'none' },
                'simple-white': { color: '#FFF', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: '#111', backdrop: 'none' },
                pink: { color: '#FFC0CB', width: '10px', shadow: '0 10px 40px rgba(255,192,203,0.3)', highlight: 'transparent', backdrop: 'none' },
                'aqua-blue': { color: '#00FFFF', width: '10px', shadow: '0 10px 40px rgba(0, 255, 255, 0.3)', highlight: 'transparent', backdrop: 'none' },
                'semi-transparent': { color: 'rgba(255, 255, 255, 0.1)', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: 'rgba(255, 255, 255, 0.2)', backdrop: 'blur(10px)' },
                transparent: { color: 'transparent', width: '0px', shadow: 'none', highlight: 'transparent', backdrop: 'none' },
                stereo: { color: '#111', width: '10px', shadow: '0 25px 60px rgba(0,0,0,0.5), inset 0 0 15px rgba(255,255,255,0.05)', highlight: '#fff', backdrop: 'none' },
                evol: { color: '#fff', width: '1px', shadow: '0 0 0 1px #FFD1DC, 0 0 0 2px #000', highlight: 'transparent', backdrop: 'none' }
            };
            const style = frameStyles[beautify.phoneFrame] || frameStyles.black;
            root.style.setProperty('--phone-border-color', style.color);
            root.style.setProperty('--phone-border-width', style.width);
            root.style.setProperty('--phone-shadow', style.shadow);
            root.style.setProperty('--phone-edge-highlight', style.highlight);
            root.style.setProperty('--phone-backdrop-filter', style.backdrop);

            const defaultFontStyle = document.getElementById('default-font-style');
            if (beautify.fontFile || beautify.fontUrl) {
                if (defaultFontStyle) defaultFontStyle.remove();
                let fontSrc = beautify.fontFile ? `url(${beautify.fontFile})` : `url(${beautify.fontUrl})`;
                if (beautify.fontUrl && beautify.fontUrl.endsWith('.css')) {
                    let link = document.querySelector('link[href="' + beautify.fontUrl + '"]');
                    if (!link) {
                        link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = beautify.fontUrl;
                        document.head.appendChild(link);
                    }
                } else {
                    root.style.setProperty('--user-custom-font-src', fontSrc);
                }
            } else {
                if (!document.getElementById('default-font-style')) {
                    const style = document.createElement('style');
                    style.id = 'default-font-style';
                    style.innerHTML = `@font-face { font-family: 'UserCustomFont'; src: url('https://static.zeoseven.com/zsft/256/main/result.css'); }`;
                    document.head.appendChild(style);
                }
            }
            root.style.setProperty('--font-size-base', `${beautify.fontSize}px`);

            root.style.setProperty('--avatar-shape', beautify.avatarShape === 'circle' ? '50%' : '6px');
            root.style.setProperty('--user-avatar-frame', beautify.userAvatarFrame ? `url(${beautify.userAvatarFrame})` : 'none');
            root.style.setProperty('--char-avatar-frame', beautify.charAvatarFrame ? `url(${beautify.charAvatarFrame})` : 'none');
            
            bubbleStyle.innerHTML = beautify.bubbleCss || '';
            redPacketBubbleStyle.innerHTML = beautify.redPacketBubbleCss || '';
            transferBubbleStyle.innerHTML = beautify.transferBubbleCss || '';

            // Auto-hide bubble tail if custom CSS doesn't define it
            if (beautify.bubbleCss && !/::after|::before/.test(beautify.bubbleCss)) {
                bubbleStyle.innerHTML += `\n.message-bubble.text-bubble::after, .message-bubble.voice-bubble::after { display: none !important; }`;
            }
            
            root.style.setProperty('--player-image', `url(${appData.music.playerImage})`);
            root.style.setProperty('--player-background', `url(${appData.music.playerBackground})`);
            
            document.getElementById('send-sound-player').src = appData.settings.notifications.send;
            document.getElementById('receive-sound-player').src = appData.settings.notifications.receive;
            document.getElementById('ringtone-player').src = appData.settings.notifications.ringtone;

            const batterySettings = beautify.batteryIcon;
            root.style.setProperty('--battery-icon-image', batterySettings.iconUrl ? `url(${batterySettings.iconUrl})` : 'none');
            document.getElementById('default-battery-icon').style.display = batterySettings.iconUrl ? 'none' : 'flex';
            document.getElementById('custom-battery-icon').style.display = batterySettings.iconUrl ? 'block' : 'none';
            root.style.setProperty('--battery-percent-display-outside', batterySettings.displayMode === 'outside' ? 'block' : 'none');
            root.style.setProperty('--battery-percent-display-inside', batterySettings.displayMode === 'inside' ? 'block' : 'none');
            if (batterySettings.displayMode === 'none') {
                root.style.setProperty('--battery-percent-display-outside', 'none');
                root.style.setProperty('--battery-percent-display-inside', 'none');
            }

            // Display Mode Settings
            const phoneContainer = document.getElementById('phone-body');
            if (appData.settings.displayMode === 'fullscreen') {
                phoneContainer.classList.add('fullscreen');
            } else {
                phoneContainer.classList.remove('fullscreen');
            }
        }

        function showMessageContextMenu(event, messageId, chatId, chatType, source) {
            event.preventDefault();
            const menu = document.getElementById('message-context-menu');
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const conversation = source === 'wechat' ? chat.conversation : chat.conversation;
            const message = conversation.find(m => m.id == messageId);
            if (!message || message.type === 'typing') return;

            let itemsHtml = `<div class="context-menu-item" onclick="handleMessageAction('edit', ${messageId}, '${chatId}', '${chatType}', '${source}')">编辑</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('quote', ${messageId}, '${chatId}', '${chatType}', '${source}')">引用</div>`;
            if (message.type === 'text' || message.type === 'voice') {
                const languages = {de:'德语',en:'英语',fr:'法语',ru:'俄语',pt:'葡萄牙语',yue:'粤语',ja:'日语',ko:'韩语',th:'泰语',it:'意大利语',fa:'波斯语',vi:'越南语', 'zh-CN': '简体中文', 'zh-TW': '繁体中文'};
                let langSubmenu = '';
                for (const [code, name] of Object.entries(languages)) {
                    langSubmenu += `<div class="context-menu-item" onclick="handleMessageAction('translate', ${messageId}, '${chatId}', '${chatType}', '${source}', { lang: '${code}', langName: '${name}' })">${name}</div>`;
                }
                itemsHtml += `<div class="context-menu-item">翻译 <div class="context-submenu">${langSubmenu}</div></div>`;
            }
            if (message.type === 'voice') itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('voiceToText', ${messageId}, '${chatId}', '${chatType}', '${source}')">转文字</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('recall', ${messageId}, '${chatId}', '${chatType}', '${source}')">撤回</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('delete', ${messageId}, '${chatId}', '${chatType}', '${source}')">删除</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('forward', ${messageId}, '${chatId}', '${chatType}', '${source}')">转发</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="startMultiSelectMode(${messageId}, '${source}')">多选</div>`;
            
            menu.innerHTML = itemsHtml;
            menu.style.display = 'block';
            
            const menuRect = menu.getBoundingClientRect();
            const bodyRect = document.body.getBoundingClientRect();
            let left = event.clientX;
            if (left + menuRect.width > bodyRect.width) left = event.clientX - menuRect.width;
            let top = event.clientY;
            if (top + menuRect.height > bodyRect.height) top = event.clientY - menuRect.height;
            
            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;

            const closeMenu = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        async function handleMessageAction(action, messageId, chatId, chatType, source, options = {}) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const conversation = source === 'wechat' ? chat.conversation : chat.conversation;
            const messageIndex = conversation.findIndex(m => m.id == messageId);
            if (messageIndex === -1) return;
            const message = conversation[messageIndex];

            switch(action) {
                case 'edit':
                    const newContent = prompt('编辑消息内容:', message.content.content);
                    if (newContent !== null) message.content.content = newContent;
                    break;
                case 'quote':
                    const inputId = 'chat-input';
                    const input = document.getElementById(inputId);
                    input.focus();
                    input.dataset.quotedMessageId = messageId;
                    input.placeholder = '以引用的形式回复...';
                    break;
                case 'voiceToText':
                    if (message.transcribedText) delete message.transcribedText;
                    else message.transcribedText = `[转文字] ${message.content.text}`;
                    break;
                case 'translate':
                    if (message.translatedText) {
                        delete message.translatedText;
                    } else {
                        const originalText = message.type === 'text' ? message.content.content : message.content.text;
                        try {
                            const translated = await getTranslationFromApi(originalText, options.lang);
                            message.translatedText = translated;
                        } catch (e) {
                            showToast(`翻译失败: ${e.message}`, 'error');
                        }
                    }
                    break;
                case 'recall':
                    if (Date.now() - message.timestamp > 2 * 60 * 1000) {
                        showToast('超过2分钟的消息无法撤回', 'error');
                    } else {
                        message.isRecalled = true;
                    }
                    break;
                case 'delete':
                    conversation.splice(messageIndex, 1);
                    break;
                case 'forward': showForwardMessageModal([message.id], chatId, chatType, source); break;
            }
            saveData();
            renderMessages(chatId, chatType, source);
        }

        async function getTranslationFromApi(text, targetLang) {
            const { key, model } = appData.settings.api;
            if (!key || !model) {
                throw new Error("API未配置，无法翻译。");
            }
            const prompt = `Translate the following text to ${targetLang}. Only output the translated text, without any other words or explanations.\n\nText: "${text}"`;
            const translation = await callApi([{ role: 'user', content: prompt }]);
            return translation;
        }

        function showForwardMessageModal(messageIds, currentChatId, currentChatType, source) {
            const modalId = 'forward-message-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">转发给...</div>
                    <div class="list-view" style="max-height: 300px; overflow-y: auto; background: transparent;">
                        ${appData.contacts.map(c => `<div class="list-item" onclick="confirmForward('${c.id}', 'individual', [${messageIds}], '${currentChatId}', '${currentChatType}', '${source}')"><img src="${c.avatar}" class="avatar"><div class="details"><span class="name">${c.remark || c.name}</span></div></div>`).join('')}
                        ${appData.groups.map(g => `<div class="list-item" onclick="confirmForward('${g.id}', 'group', [${messageIds}], '${currentChatId}', '${currentChatType}', '${source}')"><img src="${g.avatar || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'}" class="avatar"><div class="details"><span class="name">${g.name}</span></div></div>`).join('')}
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function confirmForward(targetChatId, targetChatType, messageIds, currentChatId, currentChatType, source) {
            let currentChat = currentChatType === 'group' ? appData.groups.find(g => g.id == currentChatId) : appData.contacts.find(c => c.id == currentChatId);
            const conversation = source === 'wechat' ? currentChat.conversation : currentChat.conversation;
            const messagesToForward = conversation.filter(m => messageIds.includes(m.id)).slice(0, 100);

            if (messagesToForward.length === 0) { showToast('没有可转发的消息。', 'error'); return; }

            let targetChat = targetChatType === 'group' ? appData.groups.find(g => g.id == targetChatId) : appData.contacts.find(c => c.id == targetChatId);
            if (!targetChat) return;

            const forwardedMsg = {
                id: Date.now(), sender: appData.user.id, type: 'forward',
                content: { 
                    messages: messagesToForward.map(msg => ({ ...msg })),
                    originalChatId: currentChatId,
                    originalChatType: currentChatType
                },
                timestamp: Date.now()
            };
            
            if (!targetChat.conversation) targetChat.conversation = [];
            targetChat.conversation.push(forwardedMsg);

            saveData(true);
            closeModal('forward-message-modal');
        }
        
        function showForwardedContentModal(event, messageId, chatId, chatType, source) {
            event.stopPropagation();
            const chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const conversation = source === 'wechat' ? chat.conversation : chat.conversation;
            const message = conversation.find(m => m.id == messageId);
            if (!message || message.type !== 'forward') return;

            const modalId = 'view-forwarded-messages-modal';
            
            const messagesHtml = message.content.messages.map(msg => {
                const isSent = msg.sender === appData.user.id;
                let sender;
                if (isSent) {
                    sender = appData.user;
                } else {
                    sender = appData.contacts.find(c => c.id == msg.sender) || appData.groups.find(g => g.id == msg.sender)?.members.find(m => m.id == msg.sender) || {name: '未知', nickname: '未知', avatar: 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'};
                }
                
                const bubbleHtml = isSent ? generateUserBubbleHtml(msg, chatId, chatType, source) : generateCharBubbleHtml(msg, chatId, chatType, source);
                return `
                    <div class="message-row ${isSent ? 'sent' : 'received'}">
                        <div class="message-body">
                            <div class="message-avatar-wrapper"><img src="${sender.avatar}" class="message-avatar"></div>
                            <div class="message-content-wrapper">${bubbleHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');

            const modalHtml = `
                <div class="modal-content" style="padding: 0; width: 90%; max-width: 340px; height: 80%; display: flex; flex-direction: column;" onclick="event.stopPropagation();">
                    <div class="wechat-header" style="flex-shrink: 0;">
                        <span class="header-title">聊天记录</span>
                        <div class="header-right" style="font-size: 16px;" onclick="closeModal('${modalId}')">关闭</div>
                    </div>
                    <div class="content-area" style="padding: 10px;">${messagesHtml}</div>
                </div>
            `;
            showModal(modalId, modalHtml);
            document.getElementById(modalId).onclick = () => closeModal(modalId);
        }

        // --- Moments Feature ---
        function renderMomentsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header" style="background: transparent; border: none; position: absolute; top: 30px; left: 0; right: 0; z-index: 5;">
                    <div class="header-left header-back-btn" onclick="goBack()" style="color: white;"><i class="fas fa-chevron-left"></i></div>
                    <div class="header-right" onclick="showPage('create-moment-page', renderCreateMomentPage)" style="color: white;"><i class="fas fa-camera"></i></div>
                </div>
                <div class="content-area">
                    <div class="moments-header-bg" id="moments-bg" style="background-image: url('${appData.user.moments_bg}')">
                        <div class="moments-user-info">
                            <span class="name">${appData.user.nickname}</span>
                            <img src="${appData.user.avatar}" class="avatar">
                        </div>
                        <div class="moments-signature">${appData.user.signature}</div>
                    </div>
                    <div id="moments-feed"></div>
                </div>
            `;
            document.getElementById('moments-bg').onclick = () => document.getElementById('moments-bg-input').click();
            container.insertAdjacentHTML('beforeend', '<input type="file" id="moments-bg-input" class="file-input" accept="image/*">');
            document.getElementById('moments-bg-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    appData.user.moments_bg = dataUrl;
                    saveData();
                    renderMomentsPage(document.getElementById('moments-page'));
                });
            };
            renderMomentsFeed();
        }

        function renderMomentsFeed() {
            const feedContainer = document.getElementById('moments-feed');
            if (!feedContainer) return;
            let html = '';
            const sortedMoments = [...appData.moments].sort((a, b) => b.timestamp - a.timestamp);

            sortedMoments.forEach(post => {
                const author = post.authorId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == post.authorId);
                if (!author) return;

                if (post.visibility === 'private' && post.authorId !== appData.user.id) return;
                if (post.visibility === 'selected' && post.authorId !== appData.user.id && !post.visibleTo.includes(appData.user.id)) return;

                let mediaHtml = '';
                if (post.media && post.media.length > 0) {
                    mediaHtml = '<div class="post-media">';
                    post.media.forEach(m => {
                        if (m.type.startsWith('image')) mediaHtml += `<img src="${m.url}" alt="moment image">`;
                        else if (m.type.startsWith('video')) mediaHtml += `<video src="${m.url}" controls></video>`;
                        else if (m.type.startsWith('audio')) mediaHtml += `<audio src="${m.url}" controls></audio>`;
                    });
                    mediaHtml += '</div>';
                }

                const likesHtml = post.likes.length > 0 ? `
                    <div class="post-likes">
                        <i class="fas fa-heart"></i>
                        ${post.likes.map(likeId => {
                            const liker = likeId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == likeId);
                            return liker ? (liker.remark || liker.name || liker.nickname) : '';
                        }).filter(Boolean).join(', ')}
                    </div>` : '';

                const commentsHtml = post.comments.length > 0 ? `
                    <div class="post-comments">
                        ${post.comments.map((comment, index) => {
                            const commenter = comment.authorId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == comment.authorId);
                            if (!commenter) return '';
                            return `<div class="moment-comment" ondblclick="deleteMomentComment(${post.id}, ${index})" onclick="showMomentCommentInput(${post.id}, '${commenter.name || commenter.nickname}')"><span class="comment-author">${commenter.remark || commenter.name || commenter.nickname}:</span> ${comment.text}</div>`;
                        }).join('')}
                    </div>` : '';

                html += `
                    <div class="moment-post" data-post-id="${post.id}" ondblclick="deleteMoment(${post.id})">
                        <img src="${author.avatar}" class="avatar">
                        <div class="post-content">
                            <div class="post-author">${author.remark || author.name || author.nickname}</div>
                            <div class="post-text">${post.text}</div>
                            ${mediaHtml}
                            <div class="post-meta">
                                <span class="post-time">${new Date(post.timestamp).toLocaleString()}</span>
                                <span class="post-actions">
                                    <i class="fas fa-thumbs-up" onclick="event.stopPropagation(); toggleMomentLike(${post.id}, '${appData.user.id}')"></i>
                                    <i class="fas fa-comment-dots" onclick="event.stopPropagation(); showMomentCommentInput(${post.id})"></i>
                                </span>
                            </div>
                            <div class="post-interactions">${likesHtml}${commentsHtml}</div>
                            <div id="comment-input-${post.id}" style="display:none; margin-top: 10px;">
                                <input type="text" placeholder="发表评论..." style="width: calc(100% - 60px); padding: 8px; border-radius: 4px; border: 1px solid #eee;">
                                <button onclick="addMomentComment(${post.id})" style="padding: 8px 12px; background: var(--wechat-green); color: white; border: none; border-radius: 4px;">发送</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            feedContainer.innerHTML = html;
        }
        
        function deleteMoment(postId) {
            if (confirm('确定要删除这条动态吗？')) {
                appData.moments = appData.moments.filter(p => p.id !== postId);
                saveData();
                renderMomentsFeed();
            }
        }

        function deleteMomentComment(postId, commentIndex) {
            if (confirm('确定要删除这条评论吗？')) {
                const post = appData.moments.find(p => p.id === postId);
                if (post) {
                    post.comments.splice(commentIndex, 1);
                    saveData();
                    renderMomentsFeed();
                }
            }
        }

        function showMomentCommentInput(postId, replyToName = null) {
            event.stopPropagation();
            const inputDiv = document.getElementById(`comment-input-${postId}`);
            if (inputDiv) {
                const input = inputDiv.querySelector('input');
                inputDiv.style.display = 'block';
                input.placeholder = replyToName ? `回复 ${replyToName}:` : '发表评论...';
                input.focus();
            }
        }

        function addMomentComment(postId) {
            const input = document.querySelector(`#comment-input-${postId} input`);
            const commentText = input.value.trim();
            if (!commentText) return;

            const post = appData.moments.find(p => p.id === postId);
            if (post) {
                post.comments.push({ authorId: appData.user.id, text: commentText, timestamp: Date.now() });
                saveData();
                renderMomentsFeed();
                
                const author = appData.contacts.find(c => c.id === post.authorId);
                if (author) {
                    const prompt = `'${appData.user.nickname}'在你的朋友圈下评论说：“${commentText}”。请你根据自己的角色设定进行回复，务必完全贴合人设，不要人机味不要太死板，话题务必要围着该动态和评论回复user，而非自顾自的自言自语，要熟知所有网络热梗语录。`;
                    getAiReply(author.id, 'wechat', prompt).then(replies => {
                        if (replies.length > 0) {
                            post.comments.push({ authorId: author.id, text: replies[0], timestamp: Date.now() });
                            saveData();
                            if (document.getElementById('moments-page').classList.contains('active')) renderMomentsFeed();
                        }
                    });
                }
            }
        }

        function toggleMomentLike(postId, userId) {
            const post = appData.moments.find(p => p.id === postId);
            if (post) {
                const index = post.likes.indexOf(userId);
                if (index > -1) post.likes.splice(index, 1);
                else post.likes.push(userId);
                saveData();
                renderMomentsFeed();
            }
        }

        function renderCreateMomentPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">取消</div>
                    <span class="header-title">发表朋友圈</span>
                    <div class="header-right" style="font-size: 16px; color: white; background: var(--wechat-green); padding: 5px 12px; border-radius: 4px;" id="post-moment-btn">发表</div>
                </div>
                <div class="content-area">
                    <textarea id="moment-text-input" maxlength="5000" placeholder="这一刻的想法..." style="width: 100%; height: 200px; border: none; padding: 15px; box-sizing: border-box; font-size: 16px; resize: none; background: transparent; color: var(--global-font-color);"></textarea>
                    <div style="padding: 15px;">
                        <button onclick="document.getElementById('moment-media-input').click()" class="form-btn" style="margin-top: 0; margin-bottom: 10px; background: #f0f0f0; color: #333;">选择图片/视频/音频</button>
                        <input type="file" id="moment-media-input" class="file-input" accept="image/*,video/*,audio/*" multiple>
                        <div id="moment-media-preview" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showMomentVisibilityModal()">
                        <div class="details"><span class="name">谁可以看</span></div>
                        <span class="info" id="moment-visibility-info">全部可见</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;

            const mediaInput = document.getElementById('moment-media-input');
            const mediaPreview = document.getElementById('moment-media-preview');
            let selectedMedia = [];
            let momentVisibility = 'public';
            let visibleToContacts = [];

            mediaInput.onchange = (e) => {
                selectedMedia = [];
                mediaPreview.innerHTML = '';
                Array.from(e.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        selectedMedia.push({ type: file.type, url: event.target.result });
                        if (file.type.startsWith('image')) mediaPreview.innerHTML += `<img src="${event.target.result}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">`;
                        else if (file.type.startsWith('video')) mediaPreview.innerHTML += `<video src="${event.target.result}" controls style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;"></video>`;
                        else if (file.type.startsWith('audio')) mediaPreview.innerHTML += `<audio src="${event.target.result}" controls style="width: 100%;"></audio>`;
                    };
                    reader.readAsDataURL(file);
                });
            };

            window.showMomentVisibilityModal = () => {
                const modalId = 'moment-visibility-modal';
                const contactsHtml = appData.contacts.map(c => `
                    <div class="list-item">
                        <img src="${c.avatar}" class="avatar" style="width: 36px; height: 36px;">
                        <div class="details"><span class="name">${c.remark || c.name}</span></div>
                        <input type="checkbox" data-contact-id="${c.id}" ${visibleToContacts.includes(c.id) ? 'checked' : ''}>
                    </div>
                `).join('');

                const html = `
                    <div class="modal-content" style="max-width: 90%; width: 350px;">
                        <div class="modal-title">谁可以看</div>
                        <div class="list-view" style="background: transparent;">
                            <div class="list-item"><label style="width: 100%;"><input type="radio" name="visibility" value="public" ${momentVisibility === 'public' ? 'checked' : ''}> 全部可见</label></div>
                            <div class="list-item"><label style="width: 100%;"><input type="radio" name="visibility" value="private" ${momentVisibility === 'private' ? 'checked' : ''}> 仅自己可见</label></div>
                            <div class="list-item"><label style="width: 100%;"><input type="radio" name="visibility" value="selected" ${momentVisibility === 'selected' ? 'checked' : ''}> 指定人可见</label></div>
                        </div>
                        <div id="selected-contacts-list" style="max-height: 200px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 10px; ${momentVisibility === 'selected' ? '' : 'display: none;'}">
                            ${contactsHtml}
                        </div>
                        <button class="modal-btn primary" id="save-visibility-btn" style="margin-top: 15px;">确定</button>
                    </div>
                `;
                showModal(modalId, html);

                document.querySelectorAll('input[name="visibility"]').forEach(radio => {
                    radio.onchange = (e) => {
                        momentVisibility = e.target.value;
                        document.getElementById('selected-contacts-list').style.display = momentVisibility === 'selected' ? 'block' : 'none';
                    };
                });

                document.getElementById('save-visibility-btn').onclick = () => {
                    if (momentVisibility === 'selected') {
                        visibleToContacts = Array.from(document.querySelectorAll('#selected-contacts-list input[type="checkbox"]:checked')).map(cb => parseInt(cb.dataset.contactId));
                        if (visibleToContacts.length === 0) { showToast('请选择至少一个可见好友', 'error'); return; }
                    }
                    document.getElementById('moment-visibility-info').textContent = {
                        'public': '全部可见', 'private': '仅自己可见',
                        'selected': `指定${visibleToContacts.length}人可见`
                    }[momentVisibility];
                    closeModal(modalId);
                };
            };

            document.getElementById('post-moment-btn').onclick = async () => {
                const text = document.getElementById('moment-text-input').value.trim();
                if (!text && selectedMedia.length === 0) { showToast('内容或媒体不能为空', 'error'); return; }

                const newPost = {
                    id: Date.now(), authorId: appData.user.id, text, media: selectedMedia,
                    timestamp: Date.now(), likes: [], comments: [],
                    visibility: momentVisibility, visibleTo: visibleToContacts
                };

                appData.moments.push(newPost);
                await saveData();
                goBack();

                for (const contact of appData.contacts) {
                    if (newPost.visibility === 'private' || (newPost.visibility === 'selected' && !newPost.visibleTo.includes(contact.id))) continue;

                    const prompt = `你的朋友'${appData.user.nickname}'刚刚发了一条朋友圈，内容是：“${text}”。请你根据自己的角色设定(${contact.persona})，对此进行评论或点赞。如果评论，请直接输出评论内容，务必完全贴合人设，不要人机味不要太死板，话题务必要围着该动态和评论回复user，而非自顾自的自言自语，要熟知所有网络热梗语录；如果只想点赞，请输出“[点赞]”，并对该动态进行点赞。`;
                    const reactions = await getAiReply(contact.id, 'wechat', prompt);
                    const post = appData.moments.find(p => p.id === newPost.id);
                    if (post) {
                        for (const reaction of reactions) {
                            if (reaction.includes('[点赞]')) {
                                if (!post.likes.includes(contact.id)) post.likes.push(contact.id);
                            }
                            const commentText = reaction.replace('[点赞]', '').trim();
                            if (commentText) post.comments.push({ authorId: contact.id, text: commentText, timestamp: Date.now() });
                        }
                        await saveData();
                        if (document.getElementById('moments-page').classList.contains('active')) renderMomentsFeed();
                    }
                }
            };
        }

        // --- Char Moment Posting Logic ---
        async function checkAndPostCharMoments() {
            const now = Date.now();
            const intervalMap = { 'low': 3 * 24 * 3600000, 'default': 1 * 24 * 3600000, 'high': 6 * 3600000 };
            const interval = intervalMap[appData.settings.charMomentFrequency] || intervalMap.default;

            for (const contact of appData.contacts) {
                if (now - contact.lastMomentPostTime > interval) {
                    const prompt = `请你根据自己的角色设定(${contact.persona})和心情，生成一条朋友圈动态，内容可以是碎碎念、生活感悟、分享日常、网络热梗、随笔小短文等，字数在50-200字之间。`;
                    const momentText = (await getAiReply(contact.id, 'wechat', prompt))[0];

                    if (momentText) {
                        const newPost = {
                            id: Date.now(), authorId: contact.id, text: momentText, media: [],
                            timestamp: Date.now(), likes: [], comments: [], visibility: 'public', visibleTo: []
                        };
                        appData.moments.push(newPost);
                        contact.lastMomentPostTime = now;
                        await saveData();
                        if (document.getElementById('moments-page').classList.contains('active')) renderMomentsFeed();
                    }
                }
            }
        }
        setInterval(checkAndPostCharMoments, 3600000);

        // --- Chat Settings ---
        function renderChatSettingsPage(container, contactId) {
            if (!container) return;
            const contact = appData.contacts.find(c => c.id == contactId);
            if (!contact) { goBack(); return; }

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">聊天设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">置顶聊天</span></div>
                        <label class="switch"><input type="checkbox" id="pin-toggle" ${contact.isPinned ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-item">
                        <div class="details"><span class="name">设为星标朋友</span></div>
                        <label class="switch"><input type="checkbox" id="star-toggle" ${contact.isStarred ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setContactRemark(${contactId})">
                        <div class="details"><span class="name">设置备注</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showBindSelfPersonaModal(${contactId})">
                        <div class="details"><span class="name">绑定自设</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('poke-settings-page', renderPokeSettingsPage, ${contactId})">
                        <div class="details"><span class="name">戳一戳设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('long-term-memory-page', renderLongTermMemoryPage, ${contactId})">
                        <div class="details"><span class="name">长期记忆</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="setChatBackground(${contactId})">
                        <div class="details"><span class="name">更换聊天背景</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="setChatAvatar(${contactId}, 'user')">
                        <div class="details"><span class="name">更换我的头像 (仅当前聊天)</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="setChatAvatar(${contactId}, 'char')">
                        <div class="details"><span class="name">更换对方头像 (仅当前聊天)</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="clearChatHistory(${contactId}, 'wechat')">
                        <div class="details"><span class="name">清空聊天记录</span></div>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="blockContact(${contactId})">
                        <div class="details"><span class="name" style="color: var(--wechat-red);">拉黑</span></div>
                    </div>
                    <div class="list-item" onclick="deleteContact(${contactId})">
                        <div class="details"><span class="name" style="color: var(--wechat-red);">删除好友</span></div>
                    </div>
                </div>
            `;

            document.getElementById('pin-toggle').onchange = (e) => togglePin(contactId, e.target.checked);
            document.getElementById('star-toggle').onchange = (e) => toggleStar(contactId, e.target.checked);
        }

        function setChatBackground(contactId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => handleChatBgUpload(e.target.files[0], contactId);
            input.click();
        }

        function setChatAvatar(contactId, userType) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                handleImageUpload(e.target.files[0], url => {
                    const contact = appData.contacts.find(c => c.id == contactId);
                    if (!contact.chatSettings) contact.chatSettings = {};
                    if (userType === 'user') {
                        contact.chatSettings.userAvatar = url;
                    } else {
                        contact.chatSettings.charAvatar = url;
                    }
                    saveData(true, () => {
                        if (appData.activeChat.id == contactId) {
                            renderMessages(contactId, 'individual', 'wechat');
                        }
                    });
                });
            };
            input.click();
        }

        function clearChatHistory(contactId, source) {
            if (confirm('确定要清空与该好友的聊天记录吗？此操作不可恢复。')) {
                const contact = appData.contacts.find(c => c.id == contactId);
                if (contact) {
                    contact.conversation = [];
                    saveData(true, () => {
                        if (appData.activeChat.id == contactId) {
                            renderMessages(contactId, 'individual', source);
                        }
                    });
                }
            }
        }

        function togglePin(contactId, isPinned) {
            const contact = appData.contacts.find(c => c.id == contactId);
            if (isPinned && appData.contacts.filter(c => c.isPinned).length >= 6) {
                showToast('最多只能置顶6个好友', 'error');
                document.getElementById('pin-toggle').checked = false;
                return;
            }
            contact.isPinned = isPinned;
            saveData();
        }

        function toggleStar(contactId, isStarred) {
            const contact = appData.contacts.find(c => c.id == contactId);
            contact.isStarred = isStarred;
            saveData();
        }

        function setContactRemark(contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            const newRemark = prompt('请输入新的备注名：', contact.remark || '');
            if (newRemark !== null) {
                contact.remark = newRemark.trim();
                saveData();
                renderChatSettingsPage(document.getElementById('chat-settings-page'), contactId);
                renderConversationPage(document.getElementById('conversation-page'), contactId, 'individual');
            }
        }

        function blockContact(contactId) {
            if (confirm('拉黑后将不再收到对方的消息，确定要拉黑吗？')) {
                if (!appData.settings.blacklist.includes(contactId)) {
                    appData.settings.blacklist.push(contactId);
                    saveData(true, () => { goBack(); goBack(); });
                }
            }
        }

        function deleteContact(contactId) {
            if (confirm('删除好友将同时删除与该好友的所有聊天记录，确定要删除吗？')) {
                appData.contacts = appData.contacts.filter(c => c.id != contactId);
                saveData(true, () => { goBack(); goBack(); });
            }
        }

        function renderBlacklistPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">黑名单</span>
                </div>
                <div class="content-area" id="blacklist-container"></div>
            `;
            renderBlacklist();
        }

        function renderBlacklist() {
            const container = document.getElementById('blacklist-container');
            let html = '<div class="list-view">';
            if (appData.settings.blacklist.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">黑名单为空</div>';
            } else {
                appData.settings.blacklist.forEach(contactId => {
                    const contact = appData.contacts.find(c => c.id == contactId);
                    if (contact) {
                        html += `
                            <div class="list-item" onclick="unblockContact(${contactId})">
                                <img src="${contact.avatar}" class="avatar">
                                <div class="details"><span class="name">${contact.remark || contact.name}</span></div>
                                <div class="info" style="color: var(--wechat-blue);">移除</div>
                            </div>
                        `;
                    }
                });
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function unblockContact(contactId) {
            appData.settings.blacklist = appData.settings.blacklist.filter(id => id != contactId);
            saveData();
            renderBlacklist();
        }

        // --- Data Management ---
        function renderDataManagementPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">数据管理</span>
                </div>
                <div class="content-area" style="padding: 20px;">
                    <button class="form-btn" onclick="exportData()">备份全部数据到文件</button>
                    <button class="form-btn" style="background-color: var(--wechat-blue); margin-top: 10px;" onclick="exportPartialData()">备份部分数据到文件</button>
                    <button class="form-btn" style="background-color: #aaa; margin-top: 10px;" onclick="document.getElementById('import-data-input').click()">从文件恢复数据</button>
                    <input type="file" id="import-data-input" class="file-input" accept=".json">
                </div>
            `;
            document.getElementById('import-data-input').onchange = importData;
        }

        async function exportData() {
            try {
                const allData = await dataManager.exportAllData();
                if (!allData.appData) {
                    showToast('没有数据可导出', 'error');
                    return;
                }
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ʚiɞPhone_全量备份_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showToast(`导出失败: ${e.message}`, 'error');
            }
        }

        async function exportPartialData() {
            try {
                const partialData = {
                    contacts: appData.contacts,
                    groups: appData.groups.map(g => ({...g, conversation: []})), // Don't export group chats
                    worldbooks: appData.worldbooks,
                    user: {
                        bankCards: appData.user.bankCards,
                        wallet: appData.user.wallet
                    },
                    stickers: appData.stickers,
                    settings: {
                        beautify: appData.settings.beautify
                    }
                };
                const dataStr = JSON.stringify({ appData: partialData }, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ʚiɞPhone_部分备份_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showToast(`导出部分数据失败: ${e.message}`, 'error');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('恢复数据将覆盖当前所有内容，确定要继续吗？此操作不可逆！')) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.appData && (importedData.appData.user || importedData.appData.contacts)) { // Check for full or partial backup
                        await dataManager.importFromBackup(importedData);
                        showToast('数据恢复成功！应用将重新加载。');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('文件格式不正确或数据结构不完整，恢复失败。', 'error');
                    }
                } catch (err) {
                    showToast('解析文件失败：' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        function handleBubbleClick(type, msgId, chatId, chatType, source) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const conversation = source === 'wechat' ? chat.conversation : chat.conversation;
            const message = conversation.find(m => m.id == msgId);
            if (!message) return;

            if (type === 'camera-sim') {
                showToast(`图片内容：\n\n${message.content.description}`);
            } else if (type === 'redPacket' && message.sender !== appData.user.id) {
                if (message.content.claimed.includes(appData.user.id)) { showToast('你已经领取过该红包了。'); return; }
                if (message.content.claimed.length >= message.content.count) { showToast('该红包已被领完。'); return; }

                const modalId = 'redpacket-receive-modal';
                const html = `
                    <div class="modal-content">
                        <div class="modal-title">领取红包</div>
                        <p style="text-align: center;">${message.content.remark}</p>
                        <div class="modal-actions">
                            <button class="modal-btn" id="redpacket-return-btn">退回</button>
                            <button class="modal-btn primary" id="redpacket-claim-btn">领取</button>
                        </div>
                    </div>
                `;
                showModal(modalId, html);

                document.getElementById('redpacket-claim-btn').onclick = () => {
                    const amountPerPerson = message.content.amount / message.content.count;
                    // HTML美化大师: 动态钱包核心逻辑
                    appData.user.wallet.balance += amountPerPerson;
                    const senderName = chatType === 'group' ? (chat.members.find(m => m.id === message.sender)?.name || '群成员') : (chat.remark || chat.name);
                    appData.user.wallet.transactions.push({ type: '红包', amount: amountPerPerson, details: `收到${senderName}的红包`, timestamp: Date.now() });
                    
                    message.content.claimed.push(appData.user.id);
                    
                    const systemMsg = {
                        id: Date.now(), type: 'system',
                        content: { content: `${appData.user.nickname} 领取了 ${senderName} 的红包` },
                        timestamp: Date.now()
                    };
                    conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType, source);
                    closeModal(modalId);
                };

                document.getElementById('redpacket-return-btn').onclick = () => {
                    const returnedAmount = message.content.amount / message.content.count;
                    const returnMsg = {
                        id: Date.now(), sender: appData.user.id, type: 'transfer',
                        content: { amount: returnedAmount, remark: `已退回 ${returnedAmount.toFixed(2)}`, status: 'returned' },
                        timestamp: Date.now()
                    };
                    conversation.push(returnMsg);
                    message.content.status = 'returned'; // Mark as handled
                    saveData();
                    renderMessages(chatId, chatType, source);
                    closeModal(modalId);
                };

            } else if (type === 'transfer' && message.sender !== appData.user.id && message.content.status === 'sent') {
                const modalId = 'transfer-receive-modal';
                const html = `
                    <div class="modal-content">
                        <div class="modal-title">收到转账</div>
                        <p style="text-align: center; font-size: 24px; font-weight: bold;">${formatCurrency(message.content.amount, appData.user.wallet.currency)}</p>
                        <p style="text-align: center; color: #888;">${message.content.remark}</p>
                        <div class="modal-actions">
                            <button class="modal-btn" id="transfer-return-btn">退回</button>
                            <button class="modal-btn primary" id="transfer-claim-btn">收款</button>
                        </div>
                    </div>
                `;
                showModal(modalId, html);

                document.getElementById('transfer-claim-btn').onclick = () => {
                    const amount = parseFloat(message.content.amount);
                    // HTML美化大师: 动态钱包核心逻辑
                    appData.user.wallet.balance += amount;
                    const senderName = chatType === 'group' ? (chat.members.find(m => m.id === message.sender)?.name || '群成员') : (chat.remark || chat.name);
                    appData.user.wallet.transactions.push({ type: '转账', amount: amount, details: `收到${senderName}的转账`, timestamp: Date.now() });
                    message.content.status = 'claimed';
                    
                    const systemMsg = { id: Date.now(), type: 'system', content: { content: `${appData.user.nickname} 已收款` }, timestamp: Date.now() };
                    conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType, source);
                    closeModal(modalId);
                };

                document.getElementById('transfer-return-btn').onclick = () => {
                    message.content.status = 'returned';
                    const char = appData.contacts.find(c => c.id == message.sender);
                    if (char && char.wallet) {
                        char.wallet.balance += parseFloat(message.content.amount);
                    }
                    const systemMsg = { id: Date.now(), type: 'system', content: { content: `${appData.user.nickname} 已退回转账` }, timestamp: Date.now() };
                    conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType, source);
                    closeModal(modalId);
                };
            } else if (type === 'music') {
                playSong(message.content.id);
            }
        }

        function showForwardedContentModal(event, messageId, chatId, chatType, source) {
            event.stopPropagation();
            const chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const conversation = source === 'wechat' ? chat.conversation : chat.conversation;
            const message = conversation.find(m => m.id == messageId);
            if (!message || message.type !== 'forward') return;

            const modalId = 'view-forwarded-messages-modal';
            
            const messagesHtml = message.content.messages.map(msg => {
                const isSent = msg.sender === appData.user.id;
                let sender;
                if (isSent) {
                    sender = appData.user;
                } else {
                    sender = appData.contacts.find(c => c.id == msg.sender) || appData.groups.find(g => g.id == msg.sender)?.members.find(m => m.id == msg.sender) || {name: '未知', nickname: '未知', avatar: 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'};
                }
                
                const bubbleHtml = isSent ? generateUserBubbleHtml(msg, chatId, chatType, source) : generateCharBubbleHtml(msg, chatId, chatType, source);
                return `
                    <div class="message-row ${isSent ? 'sent' : 'received'}">
                        <div class="message-body">
                            <div class="message-avatar-wrapper"><img src="${sender.avatar}" class="message-avatar"></div>
                            <div class="message-content-wrapper">${bubbleHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');

            const modalHtml = `
                <div class="modal-content" style="padding: 0; width: 90%; max-width: 340px; height: 80%; display: flex; flex-direction: column;" onclick="event.stopPropagation();">
                    <div class="wechat-header" style="flex-shrink: 0;">
                        <span class="header-title">聊天记录</span>
                        <div class="header-right" style="font-size: 16px;" onclick="closeModal('${modalId}')">关闭</div>
                    </div>
                    <div class="content-area" style="padding: 10px;">${messagesHtml}</div>
                </div>
            `;
            showModal(modalId, modalHtml);
            document.getElementById(modalId).onclick = () => closeModal(modalId);
        }

        // --- Group Chat Functions ---
        function renderCreateGroupChatPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">发起群聊</span>
                    <div class="header-right" style="font-size: 16px;" id="create-group-btn">创建</div>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>群聊名称</label>
                        <input type="text" id="group-name-input" placeholder="请输入群聊名称">
                    </div>
                    <div class="form-group">
                        <label>群头像</label>
                        <img src="https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg" class="avatar-upload-preview" id="group-avatar-preview" onclick="document.getElementById('group-avatar-input').click()">
                        <input type="file" id="group-avatar-input" class="file-input" accept="image/jpeg, image/gif">
                    </div>
                    <div class="list-divider"></div>
                    <div class="selected-contacts-preview" id="selected-group-members-preview">
                        <img src="${appData.user.avatar}" class="avatar">
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-view contact-selection-list" id="group-member-selection"></div>
                </div>
            `;

            const selectionContainer = document.getElementById('group-member-selection');
            selectionContainer.innerHTML = appData.contacts.map(contact => `
                <div class="list-item">
                    <input type="checkbox" data-member-id="${contact.id}" data-member-avatar="${contact.avatar}">
                    <img src="${contact.avatar}" class="avatar">
                    <div class="details"><span class="name">${contact.name}</span></div>
                </div>
            `).join('');

            const selectedMembersPreview = document.getElementById('selected-group-members-preview');
            let selectedMemberIds = [];
            let groupAvatar = 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg';

            document.getElementById('group-avatar-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('group-avatar-preview').src = dataUrl;
                    groupAvatar = dataUrl;
                });
            };

            selectionContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.onchange = (e) => {
                    const memberId = parseInt(e.target.dataset.memberId);
                    const memberAvatar = e.target.dataset.memberAvatar;
                    if (e.target.checked) {
                        selectedMemberIds.push(memberId);
                        selectedMembersPreview.innerHTML += `<img src="${memberAvatar}" class="avatar" data-preview-id="${memberId}">`;
                    } else {
                        selectedMemberIds = selectedMemberIds.filter(id => id !== memberId);
                        document.querySelector(`img[data-preview-id="${memberId}"]`).remove();
                    }
                };
            });

            document.getElementById('create-group-btn').onclick = () => {
                const groupName = document.getElementById('group-name-input').value.trim();
                if (!groupName) { showToast('群聊名称不能为空', 'error'); return; }
                if (selectedMemberIds.length < 1) { showToast('请至少选择一个好友', 'error'); return; }

                const newGroup = {
                    id: Date.now(), name: groupName, avatar: groupAvatar,
                    members: [appData.user, ...appData.contacts.filter(c => selectedMemberIds.includes(c.id))],
                    conversation: [], adminIds: [appData.user.id], announcement: '',
                    isPinned: false, isStarred: false, mutedMembers: {}
                };
                appData.groups.push(newGroup);
                saveData(true, () => showPage('conversation-page', renderConversationPage, newGroup.id, 'group'));
            };
        }

        function renderGroupChatSettingsPage(container, groupId) {
            if (!container) return;
            const group = appData.groups.find(g => g.id == groupId);
            if (!group) { goBack(); return; }
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">群聊设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="editGroupName(${groupId})">
                        <div class="details"><span class="name">群聊名称</span></div>
                        <span class="info">${group.name}</span><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="editGroupAvatar(${groupId})">
                        <div class="details"><span class="name">群头像</span></div>
                        <img src="${group.avatar}" class="avatar" style="width: 40px; height: 40px;">
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('group-member-management-page', renderGroupMemberManagementPage, ${groupId})">
                        <div class="details"><span class="name">群成员 (${group.members.length})</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    ${isUserAdmin ? `
                    <div class="list-item" onclick="editGroupAnnouncement(${groupId})">
                        <div class="details"><span class="name">群公告</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showMuteSettingsModal(${groupId})">
                        <div class="details"><span class="name">设置禁言</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>` : ''}
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">置顶聊天</span></div>
                        <label class="switch"><input type="checkbox" id="group-pin-toggle" ${group.isPinned ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-divider"></div>
                    <button class="form-btn" style="background-color: #E64340; margin: 20px;" onclick="leaveGroupChat(${groupId})">退出群聊</button>
                </div>
            `;

            document.getElementById('group-pin-toggle').onchange = (e) => {
                group.isPinned = e.target.checked;
                saveData();
            };
        }

        function showMuteSettingsModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const modalId = 'mute-settings-modal';
            const membersHtml = group.members.map(member => {
                if (member.id === appData.user.id) return '';
                const isMuted = group.mutedMembers[member.id] && group.mutedMembers[member.id] > Date.now();
                const muteUntil = isMuted ? new Date(group.mutedMembers[member.id]).toLocaleString() : '未禁言';
                return `
                    <div class="list-item">
                        <img src="${member.avatar}" class="avatar">
                        <div class="details"><span class="name">${member.name}</span><p class="subtext">禁言至: ${muteUntil}</p></div>
                        <div class="member-actions">
                            ${isMuted ? `<button onclick="unmuteMember(${groupId}, '${member.id}'); closeModal('${modalId}')">解除</button>` : `<button onclick="showMuteDurationModal(${groupId}, '${member.id}'); closeModal('${modalId}')">禁言</button>`}
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <div class="modal-content" style="max-width: 90%; width: 350px;">
                    <div class="modal-title">禁言设置</div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto; background: transparent;">
                        <div class="list-item">
                            <div class="details"><span class="name">全体禁言</span></div>
                            <label class="switch"><input type="checkbox" id="mute-all-toggle" ${group.mutedMembers['all'] ? 'checked' : ''}><span class="slider"></span></label>
                        </div>
                        ${membersHtml}
                    </div>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('mute-all-toggle').onchange = (e) => {
                if (e.target.checked) group.mutedMembers['all'] = Date.now() + (100 * 365 * 24 * 3600000);
                else delete group.mutedMembers['all'];
                saveData();
                closeModal(modalId);
            };
        }

        function showMuteDurationModal(groupId, memberId) {
            const modalId = 'mute-duration-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">禁言时长</div>
                    <div class="modal-input-group">
                        <label>天</label><input type="number" id="mute-days" value="0" min="0">
                        <label>时</label><input type="number" id="mute-hours" value="0" min="0" max="23">
                        <label>分</label><input type="number" id="mute-minutes" value="0" min="0" max="59">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="confirm-mute-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('confirm-mute-btn').onclick = () => {
                const days = parseInt(document.getElementById('mute-days').value) || 0;
                const hours = parseInt(document.getElementById('mute-hours').value) || 0;
                const minutes = parseInt(document.getElementById('mute-minutes').value) || 0;
                const duration = (days * 24 * 3600 + hours * 3600 + minutes * 60) * 1000;
                if (duration <= 0) { showToast('禁言时长必须大于0', 'error'); return; }
                
                const group = appData.groups.find(g => g.id == groupId);
                group.mutedMembers[memberId] = Date.now() + duration;
                saveData();
                closeModal(modalId);
            };
        }

        function unmuteMember(groupId, memberId) {
            const group = appData.groups.find(g => g.id == groupId);
            delete group.mutedMembers[memberId];
            saveData();
        }

        function editGroupName(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const newName = prompt('请输入新的群聊名称：', group.name);
            if (newName && newName.trim()) {
                group.name = newName.trim();
                saveData();
                renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
                renderConversationPage(document.getElementById('conversation-page'), groupId, 'group');
            }
        }

        function editGroupAvatar(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const modalId = 'edit-group-avatar-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">更换群头像</div>
                    <img src="${group.avatar}" class="avatar-upload-preview" id="group-avatar-preview-modal" onclick="document.getElementById('group-avatar-input-modal').click()">
                    <input type="file" id="group-avatar-input-modal" class="file-input" accept="image/jpeg, image/gif">
                    <button class="modal-btn primary" id="save-group-avatar-btn" style="margin-top: 15px;">保存</button>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('group-avatar-input-modal').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('group-avatar-preview-modal').src = dataUrl;
                });
            };
            document.getElementById('save-group-avatar-btn').onclick = () => {
                group.avatar = document.getElementById('group-avatar-preview-modal').src;
                saveData(true);
                renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
                closeModal(modalId);
            };
        }

        function editGroupAnnouncement(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const newAnnouncement = prompt('请输入群公告 (上限1000字)：', group.announcement);
            if (newAnnouncement !== null) {
                group.announcement = newAnnouncement.substring(0, 1000);
                saveData();
                const systemMsg = { id: Date.now(), type: 'system', content: { content: `群主发布了新公告: ${group.announcement}` }, timestamp: Date.now() };
                group.conversation.push(systemMsg);
                renderMessages(groupId, 'group', 'wechat');
            }
        }

        function renderGroupMemberManagementPage(container, groupId) {
            if (!container) return;
            const group = appData.groups.find(g => g.id == groupId);
            if (!group) { goBack(); return; }
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">群成员管理</span>
                    ${isUserAdmin ? `<div class="header-right" onclick="showAddGroupMembersModal(${groupId})"><i class="fas fa-user-plus"></i></div>` : ''}
                </div>
                <div class="content-area group-member-list list-view" id="group-members-list"></div>
            `;
            renderGroupMembersList(groupId);
        }

        function renderGroupMembersList(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const listContainer = document.getElementById('group-members-list');
            if (!listContainer) return;
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            listContainer.innerHTML = group.members.map(member => {
                const isMemberAdmin = group.adminIds.includes(member.id);
                return `
                    <div class="list-item">
                        <img src="${member.avatar}" class="avatar">
                        <div class="details"><span class="name">${member.name} ${isMemberAdmin ? '(管理员)' : ''}</span></div>
                        <div class="member-actions">
                            ${isUserAdmin && member.id !== appData.user.id ? `
                                <button onclick="toggleGroupAdmin(${groupId}, '${member.id}')">${isMemberAdmin ? '取消' : '设为管理员'}</button>
                                <button onclick="removeGroupMember(${groupId}, '${member.id}')">移出</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddGroupMembersModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const existingMemberIds = group.members.map(m => m.id);
            const availableContacts = appData.contacts.filter(c => !existingMemberIds.includes(c.id));

            const modalId = 'add-group-members-modal';
            let html = `
                <div class="modal-content">
                    <div class="modal-title">添加群成员</div>
                    <div class="list-view contact-selection-list" id="add-members-selection">
            `;
            if (availableContacts.length === 0) {
                html += '<div style="text-align:center; padding: 20px;">暂无更多好友可添加</div>';
            } else {
                html += availableContacts.map(contact => `
                    <div class="list-item">
                        <input type="checkbox" data-member-id="${contact.id}">
                        <img src="${contact.avatar}" class="avatar">
                        <div class="details"><span class="name">${contact.name}</span></div>
                    </div>
                `).join('');
            }
            html += `</div><button class="modal-btn primary" id="confirm-add-members-btn" style="margin-top: 15px;">添加</button></div>`;
            showModal(modalId, html);

            document.getElementById('confirm-add-members-btn').onclick = () => {
                const selectedCheckboxes = document.querySelectorAll('#add-members-selection input:checked');
                const newMemberIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.memberId));
                const newMembers = appData.contacts.filter(c => newMemberIds.includes(c.id));
                group.members.push(...newMembers);
                saveData();
                renderGroupMembersList(groupId);
                closeModal(modalId);
            };
        }

        function toggleGroupAdmin(groupId, memberId) {
            const group = appData.groups.find(g => g.id == groupId);
            const index = group.adminIds.indexOf(memberId);
            if (index > -1) {
                if (group.adminIds.length > 1) { // Ensure at least one admin remains
                    group.adminIds.splice(index, 1);
                } else {
                    showToast('至少需要一名管理员', 'error');
                }
            } else {
                group.adminIds.push(memberId);
            }
            saveData();
            renderGroupMembersList(groupId);
        }

        function removeGroupMember(groupId, memberId) {
            if (confirm('确定要将该成员移出群聊吗？')) {
                const group = appData.groups.find(g => g.id == groupId);
                group.members = group.members.filter(m => m.id != memberId);
                group.adminIds = group.adminIds.filter(id => id != memberId);
                saveData();
                renderGroupMembersList(groupId);
            }
        }

        function leaveGroupChat(groupId) {
            if (confirm('确定要退出群聊吗？')) {
                appData.groups = appData.groups.filter(g => g.id != groupId);
                saveData(true, () => { goBack(); goBack(); });
            }
        }

        // --- Music Player ---
        let audioPlayer = new Audio();
        audioPlayer.onended = () => playNextSong();

        function renderMusicLibraryPage(container, source = 'wechat') {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">音乐库</span>
                    <div class="header-right" onclick="showPage('music-settings-page', renderMusicSettingsPage)"><i class="fas fa-cog"></i></div>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-view">
                        <div class="list-item" onclick="showAddMusicModal()">
                            <div class="details"><span class="name">从URL导入</span></div><i class="fas fa-plus chevron"></i>
                        </div>
                        <div class="list-item" onclick="document.getElementById('local-music-input').click()">
                            <div class="details"><span class="name">从本地导入</span></div><i class="fas fa-plus chevron"></i>
                        </div>
                        <input type="file" id="local-music-input" class="file-input" accept=".mp3" onchange="handleLocalMusicUpload(this.files[0])">
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-view" id="music-library-list"></div>
                </div>
            `;
            renderMusicLists(source);
        }

        function renderMusicLists(source) {
            const libList = document.getElementById('music-library-list');
            if (!libList) return;
            const filteredLibrary = appData.music.library;
            libList.innerHTML = filteredLibrary.map(song => `
                <div class="list-item" onclick="playSong(${song.id})">
                    <img src="${song.cover || 'https://img.js.design/assets/img/664e0d45692271d43c087968.jpg'}" class="avatar" style="width: 48px; height: 48px;">
                    <div class="details"><span class="name">${song.title}</span><p class="subtext">${song.artist}</p></div>
                    <i class="fas fa-share-square" style="margin-right: 15px;" onclick="event.stopPropagation(); forwardMusic(${song.id}, '${source}')"></i>
                    <i class="fas fa-heart" style="color: ${appData.music.favorites.includes(song.id) ? 'red' : '#ccc'};" onclick="event.stopPropagation(); toggleFavorite(${song.id})"></i>
                </div>
            `).join('');
        }

        function showAddMusicModal() {
            const modalId = 'add-music-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">从URL导入音乐</div>
                    <div class="modal-input-group"><label>音乐URL</label><input type="text" id="music-url-input" class="modal-input"></div>
                    <div class="modal-input-group"><label>歌名</label><input type="text" id="music-title-input" class="modal-input"></div>
                    <div class="modal-input-group"><label>艺术家</label><input type="text" id="music-artist-input" class="modal-input"></div>
                    <div class="modal-input-group"><label>专辑封面URL</label><input type="text" id="music-cover-url-input" class="modal-input"></div>
                    <button class="modal-btn primary" id="save-music-btn" style="margin-top: 15px;">保存</button>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('save-music-btn').onclick = () => {
                const url = document.getElementById('music-url-input').value.trim();
                const title = document.getElementById('music-title-input').value.trim();
                const artist = document.getElementById('music-artist-input').value.trim();
                const cover = document.getElementById('music-cover-url-input').value.trim();
                if (!url || !title || !artist) { showToast('URL、歌名和艺术家不能为空', 'error'); return; }
                appData.music.library.push({ id: Date.now(), url, title, artist, cover, lyrics: '' });
                saveData();
                renderMusicLists();
                closeModal(modalId);
            };
        }

        function handleLocalMusicUpload(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const url = e.target.result;
                const title = file.name.replace('.mp3', '');
                appData.music.library.push({ id: Date.now(), url, title, artist: '未知艺术家', cover: '', lyrics: '' });
                saveData();
                renderMusicLists();
            };
            reader.readAsDataURL(file);
        }

        function forwardMusic(songId, source) {
            const song = appData.music.library.find(s => s.id === songId);
            if (!song) return;
            const activeChat = source === 'wechat' ? appData.activeChat : appData.forum.activeChat;
            if (activeChat.id) {
                sendMessage(activeChat.id, activeChat.type, { id: song.id, title: song.title, artist: song.artist, cover: song.cover }, 'music', source);
                showToast('音乐已分享到当前聊天');
            } else {
                showToast('请先进入一个聊天', 'error');
            }
        }

        function toggleFavorite(songId) {
            const index = appData.music.favorites.indexOf(songId);
            if (index > -1) appData.music.favorites.splice(index, 1);
            else appData.music.favorites.push(songId);
            saveData();
            renderMusicLists();
        }

        function playSong(songId) {
            const song = appData.music.library.find(s => s.id === songId);
            if (!song) return;
            appData.music.currentSongId = songId;
            audioPlayer.src = song.url;
            audioPlayer.play();
            appData.music.isPlaying = true;
            saveData();
            showPage('music-player-page', renderMusicPlayerPage);
        }

        function playNextSong() {
            const library = appData.music.library;
            if (library.length === 0) return;
            let currentIndex = library.findIndex(s => s.id === appData.music.currentSongId);
            let nextIndex;
            if (appData.music.playMode === 'single') nextIndex = currentIndex;
            else if (appData.music.playMode === 'random') nextIndex = Math.floor(Math.random() * library.length);
            else nextIndex = (currentIndex + 1) % library.length;
            playSong(library[nextIndex].id);
        }

        function playPreviousSong() {
            const library = appData.music.library;
            if (library.length === 0) return;
            let currentIndex = library.findIndex(s => s.id === appData.music.currentSongId);
            let prevIndex = (currentIndex - 1 + library.length) % library.length;
            playSong(library[prevIndex].id);
        }

        function togglePlayPause() {
            if (audioPlayer.paused) audioPlayer.play();
            else audioPlayer.pause();
            appData.music.isPlaying = !audioPlayer.paused;
            saveData();
            if (document.getElementById('music-player-page').classList.contains('active')) renderMusicPlayerPage(document.getElementById('music-player-page'));
        }

        function renderMusicPlayerPage(container) {
            if (!container) return;
            const currentSong = appData.music.library.find(s => s.id === appData.music.currentSongId);
            if (!currentSong) {
                container.innerHTML = '<div class="wechat-header"><div class="header-left header-back-btn" onclick="goBack()"></div></div><div class="content-area" style="text-align:center; padding-top: 50%;">暂无播放歌曲</div>';
                return;
            }

            const playIcon = appData.music.isPlaying ? 'fa-pause-circle' : 'fa-play-circle';
            const playModeIcon = { 'sequence': 'fa-retweet', 'single': 'fa-redo-alt', 'random': 'fa-random' }[appData.music.playMode];

            container.innerHTML = `
                <div class="wechat-header" style="background: transparent; border: none; position: absolute; top: 30px; left: 0; right: 0; z-index: 5;">
                    <div class="header-left header-back-btn" onclick="goBack()" style="color: white;"><i class="fas fa-chevron-down"></i></div>
                </div>
                <div class="content-area">
                    <div class="music-cover ${appData.music.isPlaying ? 'playing' : ''}"></div>
                    <div class="music-info"><h3>${currentSong.title}</h3><p>${currentSong.artist}</p></div>
                    <div class="music-progress"><div class="music-progress-bar" id="music-progress-bar"></div></div>
                    <div class="music-controls">
                        <i class="fas ${playModeIcon}" onclick="togglePlayMode()"></i>
                        <i class="fas fa-backward" onclick="playPreviousSong()"></i>
                        <i class="fas ${playIcon}" onclick="togglePlayPause()"></i>
                        <i class="fas fa-forward" onclick="playNextSong()"></i>
                        <i class="fas fa-list-ul" onclick="showPage('music-library-page', renderMusicLibraryPage)"></i>
                    </div>
                    <div style="margin-top: 20px; color: white;">
                        <span>倍速: <input type="range" min="0.7" max="3" step="0.1" value="${audioPlayer.playbackRate}" onchange="audioPlayer.playbackRate = this.value"></span>
                        <span>音调: <input type="range" min="0.7" max="2" step="0.1" value="${audioPlayer.preservesPitch ? 1 : 1}" onchange="audioPlayer.preservesPitch = false; audioPlayer.playbackRate = this.value"></span>
                    </div>
                </div>
            `;
            applyBeautifySettings(); // 确保更换的图片能显示

            audioPlayer.ontimeupdate = () => {
                const progressBar = document.getElementById('music-progress-bar');
                if (progressBar && audioPlayer.duration) {
                    progressBar.style.width = `${(audioPlayer.currentTime / audioPlayer.duration) * 100}%`;
                }
            };
        }

        function togglePlayMode() {
            const modes = ['sequence', 'single', 'random'];
            let currentIndex = modes.indexOf(appData.music.playMode);
            appData.music.playMode = modes[(currentIndex + 1) % modes.length];
            saveData();
            renderMusicPlayerPage(document.getElementById('music-player-page'));
        }

        function renderMusicSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">音乐设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('player-beautify-page', renderPlayerBeautifyPage)">
                        <div class="details"><span class="name">播放器美化</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function renderPlayerBeautifyPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">播放器美化</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>更换播放器图片</label>
                        <img src="${appData.music.playerImage}" class="avatar-upload-preview" id="player-image-preview" onclick="document.getElementById('player-image-input').click()">
                        <input type="file" id="player-image-input" class="file-input" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>更换播放器背景图片</label>
                        <img src="${appData.music.playerBackground}" class="avatar-upload-preview" id="player-bg-preview" onclick="document.getElementById('player-bg-input').click()">
                        <input type="file" id="player-bg-input" class="file-input" accept="image/*">
                    </div>
                </div>
            `;
            document.getElementById('player-image-input').onchange = e => handleImageUpload(e.target.files[0], url => {
                appData.music.playerImage = url;
                saveData();
                applyBeautifySettings();
                document.getElementById('player-image-preview').src = url;
            });
            document.getElementById('player-bg-input').onchange = e => handleImageUpload(e.target.files[0], url => {
                appData.music.playerBackground = url;
                saveData();
                applyBeautifySettings();
                document.getElementById('player-bg-preview').src = url;
            });
        }

        // --- Long Term Memory & Diary ---
        function renderLongTermMemoryPage(container, contactId) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">长期记忆</span>
                </div>
                <div class="content-area" id="memory-list">
                    <div class="loader-container"><div class="loader"></div></div>
                </div>
            `;
            generateAndRenderMemory(contactId);
        }

        async function generateAndRenderMemory(contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            const memoryList = document.getElementById('memory-list');
            if (!memoryList) return;
            try {
                const history = contact.conversation.slice(-100).map(m => `${m.sender === 'me' ? appData.user.nickname : contact.name}: ${m.content.content}`).join('\n');
                const prompt = `请以客观的第三人称视角，总结本次聊天记录中的关键事件、地点变更和人物关系变化。可以掺杂个人感情，像写日记一样，要贴合自己的人设，结合聊天记录中的话题和事件，请分条列出每条不超过100字。总计字数上限5000字。\n\n聊天记录：\n${history}`;
                const summary = await getAiReply(contactId, 'wechat', prompt);
                memoryList.innerHTML = summary.map(item => `<div class="list-item" style="flex-direction: column; align-items: flex-start; background: var(--wechat-bg); border-radius: 8px; margin-bottom: 10px;"><p>${item}</p></div>`).join('');
            } catch (e) {
                memoryList.innerHTML = `<p style="padding: 20px; color: red;">生成记忆失败: ${e.message}</p>`;
            }
        }

        function renderDiaryPage(container, chatId) {
            if (!container) return;
            const contact = appData.contacts.find(c => c.id == chatId);
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">${contact.name}的日记</span>
                </div>
                <div class="content-area" id="diary-content" style="padding: 25px; font-family: 'DiaryFont', serif; color: #3a2e28; line-height: 1.8; font-size: 17px; white-space: pre-wrap; background-image: url('https://img.heliar.top/file/1764077275005_Screenshot_2025_1125_181250.png'); background-size: cover;">
                    <div class="loader-container"><div class="loader"></div></div>
                </div>
            `;
            generateAndRenderDiary(chatId);
        }

        async function generateAndRenderDiary(chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            const diaryContent = document.getElementById('diary-content');
            if (!diaryContent) return;
            try {
                const history = contact.conversation.slice(-100).map(m => `${m.sender === appData.user.id ? appData.user.nickname : contact.name}: ${m.content.content}`).join('\n');
                const prompt = `请你以【${contact.name}】的身份和第一人称视角，结合你的角色设定(${contact.persona})以及下面的聊天记录，写一篇日记。日记内容要完全贴合你的人设，可以是对聊天内容的感想，也可以是基于聊天内容发散出的、符合你身份的日常记录或心理活动。字数上限5000字。\n\n聊天记录：\n${history}`;
                const diaryText = (await getAiReply(chatId, 'wechat', prompt)).join('\n\n');
                diaryContent.textContent = diaryText;
            } catch (e) {
                diaryContent.innerHTML = `<p style="padding: 20px; color: red;">生成日记失败: ${e.message}</p>`;
            }
        }

        // --- Poke Feature ---
        function renderPokeSettingsPage(container, contactId) {
            if (!container) return;
            const contact = appData.contacts.find(c => c.id == contactId);
            if (!contact) { goBack(); return; }
            
            const pokeSettings = contact.pokeSettings;

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">戳一戳设置</span>
                </div>
                <div class="content-area form-page">
                    <h3>设置我对 ${contact.name} 的戳一戳</h3>
                    <div class="form-group">
                        <label>动作</label>
                        <select id="poke-user-action">
                            ${['拍了拍', '揉了揉', '戳了戳', '捏了捏', '弹了弹'].map(a => `<option value="${a}" ${pokeSettings.userToChar.action === a ? 'selected' : ''}>${a}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>后缀 (例如：的脸并说了句抖爱慕)</label>
                        <input type="text" id="poke-user-suffix" value="${pokeSettings.userToChar.suffix}">
                    </div>
                    <div class="list-divider"></div>
                    <h3>设置 ${contact.name} 对我的戳一戳</h3>
                    <div class="form-group">
                        <label>动作</label>
                        <select id="poke-char-action">
                            ${['拍了拍', '揉了揉', '戳了戳', '捏了捏', '弹了弹'].map(a => `<option value="${a}" ${pokeSettings.charToUser.action === a ? 'selected' : ''}>${a}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>后缀</label>
                        <input type="text" id="poke-char-suffix" value="${pokeSettings.charToUser.suffix}">
                    </div>
                    <button class="form-btn" id="save-poke-btn">保存</button>
                </div>
            `;
            document.getElementById('save-poke-btn').onclick = () => {
                pokeSettings.userToChar.action = document.getElementById('poke-user-action').value;
                pokeSettings.userToChar.suffix = document.getElementById('poke-user-suffix').value;
                pokeSettings.charToUser.action = document.getElementById('poke-char-action').value;
                pokeSettings.charToUser.suffix = document.getElementById('poke-char-suffix').value;
                saveData(true);
            };
        }

        function triggerPoke(chatId, chatType, targetId, source, pokerId = appData.user.id) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;
            const conversation = source === 'wechat' ? chat.conversation : chat.conversation;

            const isUserPoking = pokerId === appData.user.id;
            const contact = appData.contacts.find(c => c.id == (isUserPoking ? targetId : chatId));
            if (!contact) return;
            
            let pokeSetting, pokerName, targetName;

            if (pokerId === targetId) { // Poking self
                pokerName = appData.user.nickname;
                targetName = '自己';
                pokeSetting = contact.pokeSettings.userToChar;
            } else if (isUserPoking) { // User pokes char
                pokerName = appData.user.nickname;
                targetName = contact.remark || contact.name;
                pokeSetting = contact.pokeSettings.userToChar;
            } else { // Char pokes user
                pokerName = contact.remark || contact.name;
                targetName = appData.user.nickname;
                pokeSetting = contact.pokeSettings.charToUser;
            }

            const pokeText = `${pokerName} ${pokeSetting.action}了 ${targetName} ${pokeSetting.suffix}`;
            
            const systemMsg = {
                id: Date.now(), type: 'system',
                content: { content: pokeText },
                timestamp: Date.now()
            };
            conversation.push(systemMsg);
            saveData();
            renderMessages(chatId, chatType, source);
        }

        // --- Helper Functions ---
        function escapeSrcDoc(html) {
            return html.replace(/"/g, '&quot;');
        }

        function formatCurrency(cnyAmount, targetCurrency, showSymbol = false) {
            const rateInfo = exchangeRates[targetCurrency];
            if (!rateInfo) return `${cnyAmount.toFixed(2)} CNY`;
            
            const convertedAmount = cnyAmount * rateInfo.rate;
            
            const options = {
                style: 'currency',
                currency: targetCurrency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            };
            
            let formatted = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(convertedAmount);
            
            if (showSymbol) {
                return `${targetCurrency} ${formatted}`;
            }
            return formatted;
        }

        function showCurrencySelectionModal() {
            const modalId = 'currency-selection-modal';
            let listHtml = '';
            for (const [code, { name }] of Object.entries(exchangeRates)) {
                listHtml += `<div class="list-item" onclick="setCurrency('${code}')">
                                <div class="details"><span class="name">${name} (${code})</span></div>
                                ${appData.user.wallet.currency === code ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                             </div>`;
            }
            const modalHtml = `
                <div class="modal-content">
                    <div class="modal-title">切换货币</div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto; background: transparent;">${listHtml}</div>
                </div>
            `;
            showModal(modalId, modalHtml);
        }

        function setCurrency(currencyCode) {
            appData.user.wallet.currency = currencyCode;
            saveData();
            closeModal('currency-selection-modal');
            renderWalletPage(document.getElementById('wallet-page'));
        }

        // --- New Feature Functions ---

        // 全局自定义主题
        function renderGlobalThemeEditorPage(container) {
            if (!container) return;
            let currentSlot = appData.settings.beautify.activeGlobalThemeSlot > -1 ? appData.settings.beautify.activeGlobalThemeSlot : 0;

            const loadSlot = (slotIndex) => {
                currentSlot = slotIndex;
                const archive = appData.settings.beautify.globalThemeArchives[slotIndex] || {};
                document.getElementById('global-theme-css-input').value = archive.css || '';
                document.querySelectorAll('.slot-btn').forEach((btn, i) => {
                    btn.style.fontWeight = i === slotIndex ? 'bold' : 'normal';
                    btn.style.borderColor = i === appData.settings.beautify.activeGlobalThemeSlot ? 'var(--wechat-green)' : 'var(--wechat-border-color)';
                });
                document.getElementById('save-theme-btn').onclick = () => saveGlobalTheme(currentSlot);
                document.getElementById('apply-theme-btn').onclick = () => applyGlobalTheme(currentSlot);
            };

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">自定义全局主题</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>存档槽</label>
                        <div style="display: flex; justify-content: space-between;">
                            ${[0,1,2].map(i => `<button class="modal-btn slot-btn" onclick="loadSlot(${i})">存档 ${i+1}</button>`).join('')}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>全局美化 CSS</label>
                        <textarea id="global-theme-css-input" style="height: 40vh; font-family: monospace;"></textarea>
                    </div>
                    <button id="save-theme-btn" class="form-btn">保存到当前槽</button>
                    <button id="apply-theme-btn" class="form-btn" style="background-color: var(--wechat-blue);">应用当前槽主题</button>
                    <button class="form-btn" style="background-color: #aaa;" onclick="clearGlobalTheme()">清除全局主题</button>
                </div>
            `;
            window.loadSlot = loadSlot;
            loadSlot(currentSlot);
        }

        function saveGlobalTheme(slotIndex) {
            const css = document.getElementById('global-theme-css-input').value;
            if (!appData.settings.beautify.globalThemeArchives[slotIndex]) {
                appData.settings.beautify.globalThemeArchives[slotIndex] = {};
            }
            appData.settings.beautify.globalThemeArchives[slotIndex].css = css;
            saveData(true);
        }

        function applyGlobalTheme(slotIndex) {
            appData.settings.beautify.activeGlobalThemeSlot = slotIndex;
            saveData(true);
            applyBeautifySettings();
            renderGlobalThemeEditorPage(document.getElementById('global-theme-editor-page'));
        }

        function clearGlobalTheme() {
            appData.settings.beautify.activeGlobalThemeSlot = -1;
            saveData(true);
            applyBeautifySettings();
            renderGlobalThemeEditorPage(document.getElementById('global-theme-editor-page'));
        }

        // 银行卡
        function renderBankCardPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>钱包</span></div>
                    <span class="header-title">银行卡</span>
                </div>
                <div class="content-area" id="bank-card-list"></div>
            `;
            renderBankCards();
        }

        function renderBankCards() {
            const listContainer = document.getElementById('bank-card-list');
            if (!listContainer) return;
            let html = '';
            appData.user.bankCards.forEach(card => {
                html += `
                    <div class="bank-card">
                        <div class="bank-name">${card.bankName}</div>
                        <div class="card-number">${formatCardNumber(card.number)}</div>
                        <div class="card-balance">余额: ${formatCurrency(card.balance, 'CNY')}</div>
                    </div>
                `;
            });
            html += `<div class="add-card-btn" onclick="showAddBankCardModal()"><i class="fas fa-plus"></i><p>添加银行卡</p></div>`;
            listContainer.innerHTML = html;
        }

        function showAddBankCardModal() {
            const modalId = 'add-bank-card-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">添加银行卡</div>
                    <div class="modal-input-group">
                        <label>银行名称</label>
                        <input type="text" id="bank-name-input" class="modal-input">
                    </div>
                    <div class="modal-input-group">
                        <label>银行卡号 (16位数字)</label>
                        <input type="text" id="bank-number-input" class="modal-input" maxlength="16" pattern="\\d{16}">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="confirm-add-card-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('confirm-add-card-btn').onclick = () => {
                const bankName = document.getElementById('bank-name-input').value.trim();
                const bankNumber = document.getElementById('bank-number-input').value.trim();
                if (!bankName) { showToast('银行名称不能为空', 'error'); return; }
                if (!/^\d{16}$/.test(bankNumber)) { showToast('请输入16位有效银行卡号', 'error'); return; }

                appData.user.bankCards.push({
                    id: Date.now(),
                    bankName,
                    number: bankNumber,
                    balance: 999999999999
                });
                saveData(true);
                renderBankCards();
                closeModal(modalId);
            };
        }

        function formatCardNumber(number) {
            return number.replace(/(\d{4})(?=\d)/g, "$1 ");
        }

        // 零钱通
        function showLianQianTongModal() {
            const modalId = 'lianqiantong-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">零钱通</div>
                    <div class="list-view" style="background: transparent;">
                        <div class="list-item" onclick="showLqtActionModal('withdraw')">提现</div>
                        <div class="list-item" onclick="showLqtActionModal('deposit')">充值</div>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function showLqtActionModal(action) {
            closeModal('lianqiantong-modal');
            const modalId = 'lqt-action-modal';
            const title = action === 'withdraw' ? '从零钱通提现' : '充值到零钱通';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
                    <div class="modal-input-group">
                        <label>金额</label>
                        <input type="number" id="lqt-amount-input" class="modal-input">
                    </div>
                    <div class="modal-input-group">
                        <label>方式</label>
                        <select id="lqt-method-select" class="modal-input">
                            ${action === 'withdraw' ? `
                                <option value="wallet">到零钱</option>
                                <option value="bank">到银行卡</option>
                            ` : `
                                <option value="wallet">从零钱</option>
                                <option value="bank">从银行卡</option>
                            `}
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" onclick="processLqtAction('${action}')">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function processLqtAction(action) {
            // Placeholder logic as LQT balance is not tracked separately
            showToast('功能开发中，此操作仅为演示。');
            closeModal('lqt-action-modal');
        }

        // 查看对方余额
        async function showCharBalancePage(container, charId) {
            if (!container) return;
            const contact = appData.contacts.find(c => c.id == charId);
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">${contact.name}的余额</span>
                </div>
                <div class="content-area">
                    <div class="loader-container"><div class="loader"></div></div>
                </div>
            `;
            try {
                const prompt = `根据角色设定：【${contact.persona}】，请你生成该角色的财务状况，必须严格遵循以下JSON格式，不要添加任何额外解释：
                {
                  "bank_balance": "银行卡余额(数字)",
                  "wallet_balance": "钱包余额(数字)",
                  "alipay_balance": "支付宝余额(数字)",
                  "recent_expenses": [
                    {"item": "支出项目1", "amount": "金额(数字)", "date": "YYYY-MM-DD"},
                    {"item": "支出项目2", "amount": "金额(数字)", "date": "YYYY-MM-DD"}
                  ]
                }`;
                const balanceDataStr = (await getAiReply(charId, 'wechat', prompt))[0];
                let balanceData;
                try {
                    balanceData = JSON.parse(balanceDataStr);
                    if (typeof balanceData.bank_balance === 'undefined' || !Array.isArray(balanceData.recent_expenses)) {
                        throw new Error("API返回的JSON结构不符合预期。");
                    }
                } catch (e) {
                    console.error("Balance JSON Parse Error:", e, "Raw string:", balanceDataStr);
                    throw new Error("API返回的数据格式错误，无法解析。");
                }

                container.innerHTML = `
                    <div class="wechat-header">
                        <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                        <span class="header-title">${contact.name}的余额</span>
                    </div>
                    <div class="content-area" style="padding: 15px;">
                        <div class="list-item"><span>银行卡余额:</span><span class="info">${formatCurrency(balanceData.bank_balance, 'CNY')}</span></div>
                        <div class="list-item"><span>钱包余额:</span><span class="info">${formatCurrency(balanceData.wallet_balance, 'CNY')}</span></div>
                        <div class="list-item"><span>支付宝余额:</span><span class="info">${formatCurrency(balanceData.alipay_balance, 'CNY')}</span></div>
                        <div class="list-divider"></div>
                        <h3>最近开销记录</h3>
                        <div class="list-view">
                            ${balanceData.recent_expenses.map(item => `
                                <div class="list-item">
                                    <div class="details">
                                        <span class="name">${item.item}</span>
                                        <p class="subtext">${item.date}</p>
                                    </div>
                                    <div class="info" style="color: var(--wechat-red);">${formatCurrency(item.amount, 'CNY')}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (e) {
                container.querySelector('.content-area').innerHTML = `<p style="color: red; padding: 20px;">获取余额失败: ${e.message}</p>`;
            }
        }

        // 对方正在输入中
        function setTypingIndicator(chatId, isTyping, memberName = null, source = 'wechat') {
            const pageId = 'conversation-page';
            const convPage = document.getElementById(pageId);
            const activeChatId = appData.activeChat.id;

            if (convPage.classList.contains('active') && activeChatId == chatId) {
                const titleEl = convPage.querySelector('.header-title');
                if (isTyping) {
                    let text = '对方正在输入中...';
                    if (memberName) text = `${memberName}正在输入中...`;
                    titleEl.dataset.originalTitle = titleEl.textContent;
                    titleEl.textContent = text;
                } else {
                    if (titleEl.dataset.originalTitle) {
                        titleEl.textContent = titleEl.dataset.originalTitle;
                    }
                }
            }
        }

        // 礼物/外卖商店 (API驱动)
        function showGiftShopModal(chatId, chatType) {
            showApiDrivenShopModal('gift', chatId, chatType);
        }

        function openDeliveryModal(chatId, chatType) {
            showApiDrivenShopModal('delivery', chatId, chatType);
        }

        function showApiDrivenShopModal(type, chatId, chatType) {
            const titles = { gift: '礼物商城', delivery: '外卖' };
            const searchPlaceholders = { gift: '搜索礼物', delivery: '搜索商家、商品' };
            const modalId = `${type}-shop-modal`;

            const content = `
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <div class="wechat-header" style="flex-shrink: 0;">
                        <div class="header-left header-back-btn" onclick="closeModal('${modalId}')"><i class="fas fa-times"></i></div>
                        <span class="header-title">${titles[type]}</span>
                        <div class="header-right" onclick="refreshApiShopItems('${type}', '${chatId}')"><i class="fas fa-sync-alt"></i></div>
                    </div>
                    <div class="delivery-search-bar" style="flex-shrink: 0;">
                        <input type="search" placeholder="${searchPlaceholders[type]}" oninput="refreshApiShopItems('${type}', '${chatId}', this.value)">
                    </div>
                    <div class="content-area ${type === 'gift' ? 'gift-grid' : 'food-list'}" id="${type}-shop-list"></div>
                </div>
            `;
            showModal(modalId, content, true);
            refreshApiShopItems(type, chatId);
        }

        async function refreshApiShopItems(type, chatId, query = '') {
            const listEl = document.getElementById(`${type}-shop-list`);
            if (!listEl) return;
            listEl.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;
            
            const prompts = {
                gift: `请严格按照'礼物名,价格,描述;...'的格式生成36个礼物，描述不超过20字。例如：'永恒玫瑰,520,一朵永不凋谢的玫瑰;...'. ${query ? `请优先生成与'${query}'相关的礼物。` : ''}`,
                delivery: `请严格按照'商品名,价格,描述;...'的格式生成36个外卖商品，描述为商家名。例如：'麻辣小龙虾,88,虾搞搞大排档;...'. ${query ? `请优先生成与'${query}'相关的商品。` : ''}`
            };

            try {
                const itemsStr = (await getAiReply(chatId, 'wechat', prompts[type]))[0];
                if (!itemsStr || typeof itemsStr !== 'string') {
                    throw new Error("API未返回有效数据。");
                }
                const items = itemsStr.split(';').map(item => {
                    const parts = item.split(',');
                    return parts.length >= 3 ? { name: parts[0].trim(), price: parseFloat(parts[1].trim()), desc: parts.slice(2).join(',').trim() } : null;
                }).filter(Boolean);

                if (items.length === 0) {
                    throw new Error("API返回的数据无法解析或为空。");
                }

                listEl.innerHTML = items.map(item => `
                    <div class="food-item" onclick="showItemDetailModal('${type}', '${chatId}', '${item.name.replace(/'/g, "\\'")}', ${item.price}, '${item.desc.replace(/'/g, "\\'")}')">
                        <img src="https://source.unsplash.com/150x100/?${type === 'gift' ? 'gift' : 'food'},${encodeURIComponent(item.name)}" alt="${item.name}">
                        <div class="info">
                            <div class="name">${item.name}</div>
                            <p style="font-size:12px; color:var(--wechat-text-secondary);">${item.desc}</p>
                            <div class="price">${formatCurrency(item.price, appData.user.wallet.currency)}</div>
                        </div>
                    </div>
                `).join('');

            } catch(e) {
                listEl.innerHTML = `<p style="text-align:center; color:red; padding:50px;">商品加载失败: ${e.message}</p>`;
            }
        }

        function showItemDetailModal(type, chatId, name, price, desc) {
            const modalId = 'item-detail-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">${name}</div>
                    <img src="https://source.unsplash.com/250x150/?${type === 'gift' ? 'gift' : 'food'},${encodeURIComponent(name)}" style="width:100%; border-radius:8px; margin-bottom:15px;">
                    <p>${desc}</p>
                    <p style="font-size:20px; font-weight:bold; color:var(--wechat-red); text-align:center;">${formatCurrency(price, appData.user.wallet.currency)}</p>
                    <div class="modal-actions" style="flex-direction:column;">
                        <button class="form-btn" onclick="processPurchase('${type}', '${chatId}', '${name.replace(/'/g, "\\'")}', ${price}, 'char')">给TA买</button>
                        <button class="form-btn" style="background-color: #aaa;" onclick="processPurchase('${type}', '${chatId}', '${name.replace(/'/g, "\\'")}', ${price}, 'user')">给自己买</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function processPurchase(type, chatId, name, price, recipient) {
            // HTML美化大师: 动态钱包核心逻辑
            if (appData.user.wallet.balance < price) {
                showToast('余额不足！', 'error');
                return;
            }
            appData.user.wallet.balance -= price;
            
            const item = { name, price, quantity: 1 };
            const receiptType = type === 'gift' ? 'gift_receipt' : 'delivery_receipt';
            const transactionType = type === 'gift' ? '送礼' : '外卖';

            appData.user.wallet.transactions.push({ type: transactionType, amount: -price, details: `为${recipient === 'char' ? '对方' : '自己'}购买 ${name}`, timestamp: Date.now() });

            sendMessage(chatId, 'individual', { items: [item], total: price, recipient }, receiptType, 'wechat');
            
            saveData();
            closeModal('item-detail-modal');
            closeModal(`${type}-shop-modal`);
        }

        // User自设
        function renderSelfPersonaListPage(container) {
            if (!container) return;
            const personas = appData.user.personas || [];
            const defaultPersonaId = appData.user.defaultPersonaId;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>我</span></div>
                    <span class="header-title">我的自设</span>
                    <div class="header-right" onclick="showPage('self-persona-editor-page', renderSelfPersonaEditorPage)"><i class="fas fa-plus"></i></div>
                </div>
                <div class="content-area list-view">
                    ${personas.map(p => `
                        <div class="list-item" onclick="showPage('self-persona-editor-page', renderSelfPersonaEditorPage, ${p.id})">
                            <img src="${p.avatar}" class="avatar">
                            <div class="details">
                                <span class="name">${p.name} ${p.id === defaultPersonaId ? '<i class="fas fa-thumbtack" style="color: var(--wechat-green);"></i>' : ''}</span>
                            </div>
                            <i class="fas fa-chevron-right chevron"></i>
                        </div>
                    `).join('') || '<p style="text-align:center; color:var(--wechat-text-secondary); padding:50px;">还没有自设，快去创建一个吧！</p>'}
                </div>
            `;
        }

        function renderSelfPersonaEditorPage(container, personaId = null) {
            if (!container) return;
            const persona = personaId ? appData.user.personas.find(p => p.id === personaId) : null;
            const isDefault = persona && appData.user.defaultPersonaId === persona.id;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">${personaId ? '编辑' : '新建'}自设</span>
                </div>
                <div class="content-area form-page">
                    <img src="${persona?.avatar || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'}" class="avatar-upload-preview" id="persona-editor-avatar" onclick="document.getElementById('persona-editor-avatar-input').click()">
                    <input type="file" id="persona-editor-avatar-input" class="file-input" accept="image/*">
                    <div class="form-group"><label>姓名</label><input type="text" id="persona-editor-name" value="${persona?.name || ''}"></div>
                    <div class="form-group"><label>设定</label><textarea id="persona-editor-desc" rows="10">${persona?.description || ''}</textarea></div>
                    ${personaId ? `<button class="form-btn" style="background-color: #aaa;" onclick="setDefaultPersona(${personaId}, ${!isDefault})">${isDefault ? '取消置顶' : '设为默认'}</button>` : ''}
                    <button class="form-btn" onclick="saveSelfPersona(${personaId})">保存</button>
                    ${personaId ? `<button class="form-btn" style="background-color: var(--wechat-red); margin-top: 10px;" onclick="deleteSelfPersona(${personaId})">删除</button>` : ''}
                </div>
            `;
            document.getElementById('persona-editor-avatar-input').onchange = e => handleImageUpload(e.target.files[0], dataUrl => document.getElementById('persona-editor-avatar').src = dataUrl);
        }

        function saveSelfPersona(personaId = null) {
            const name = document.getElementById('persona-editor-name').value;
            if (!name) { showToast('姓名不能为空', 'error'); return; }
            const newPersona = {
                id: personaId || Date.now(),
                name,
                avatar: document.getElementById('persona-editor-avatar').src,
                description: document.getElementById('persona-editor-desc').value
            };
            if (personaId) {
                const index = appData.user.personas.findIndex(p => p.id === personaId);
                appData.user.personas[index] = newPersona;
            } else {
                if (!appData.user.personas) appData.user.personas = [];
                appData.user.personas.push(newPersona);
            }
            saveData(true, goBack);
        }

        function deleteSelfPersona(personaId) {
            if (confirm('确定删除此自设吗？')) {
                appData.user.personas = appData.user.personas.filter(p => p.id !== personaId);
                appData.contacts.forEach(c => { if (c.boundPersonaId === personaId) c.boundPersonaId = null; });
                if (appData.user.defaultPersonaId === personaId) appData.user.defaultPersonaId = null;
                saveData(true, goBack);
            }
        }
        
        function setDefaultPersona(personaId, isDefault) {
            if (isDefault) {
                appData.user.defaultPersonaId = personaId;
            } else {
                if (appData.user.defaultPersonaId === personaId) {
                    appData.user.defaultPersonaId = null;
                }
            }
            saveData(true, () => renderSelfPersonaEditorPage(document.getElementById('self-persona-editor-page'), personaId));
        }

        function showBindSelfPersonaModal(contactId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            const personas = appData.user.personas;
            if (!personas || personas.length === 0) { showToast('请先在“我”页面创建自设', 'error'); return; }
            let optionsHtml = personas.map(p => `
                <div class="list-item" onclick="setBoundPersona(${contactId}, ${p.id})">
                    <div class="details"><span class="name">${p.name}</span></div>
                    ${contact.boundPersonaId === p.id ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                </div>`).join('');
            optionsHtml += `<div class="list-item" onclick="setBoundPersona(${contactId}, null)" style="justify-content: center; color: var(--wechat-red);">解除绑定</div>`;
            showModal('bind-persona-modal', `<div class="modal-content"><div class="modal-title">为 ${contact.name} 绑定自设</div><div class="list-view" style="background: transparent;">${optionsHtml}</div></div>`);
        }

        function setBoundPersona(contactId, personaId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            contact.boundPersonaId = personaId;
            saveData(true);
            closeModal('bind-persona-modal');
        }

        // 情侣空间
        async function sendCoupleInvitation(chatId, chatType, source) {
            if (chatType !== 'individual') { showToast('只能与单个好友建立情侣关系', 'error'); return; }
            const contact = appData.contacts.find(c => c.id == chatId);
            if (!contact) return;
            if (contact.isCouple) { showToast(`你和 ${contact.name} 已经是情侣啦！`); return; }
            if (appData.contacts.some(c => c.isCouple)) { showToast('只能和一个人绑定情侣关系哦。'); return; }

            if (confirm(`确定要邀请 ${contact.name} 成为情侣吗？`)) {
                sendMessage(chatId, chatType, {}, 'couple_invitation', source);
            }
        }

        async function respondToCoupleInvitation(messageId, accepted, chatId, chatType, source) {
            const chat = appData.contacts.find(c => c.id == chatId);
            const conversation = source === 'wechat' ? chat.conversation : chat.conversation;
            const invitationMsg = conversation.find(m => m.id === messageId);
            if (!invitationMsg) return;

            // Remove the invitation bubble
            const msgIndex = conversation.findIndex(m => m.id === messageId);
            if (msgIndex > -1) conversation.splice(msgIndex, 1);

            if (accepted) {
                appData.contacts.forEach(c => c.isCouple = false); // Ensure only one couple relationship
                chat.isCouple = true;
                const systemMsg = { 
                    id: Date.now(), 
                    type: 'system', 
                    content: { type: 'couple_accepted', content: `你和 ${chat.name} 已成为情侣！` }, 
                    timestamp: Date.now() 
                };
                conversation.push(systemMsg);
                showToast(`你和 ${chat.name} 已成为情侣！`, 'success');
            } else {
                const systemMsg = { 
                    id: Date.now(), 
                    type: 'system', 
                    content: { content: `你拒绝了 ${chat.name} 的情侣邀请` }, 
                    timestamp: Date.now() 
                };
                conversation.push(systemMsg);
            }
            
            await saveData();
            renderMessages(chatId, chatType, source);
        }

        // 角色语言设置
        function renderLanguageSettingsPage(container) {
            if (!container) return;
            const languages = {
                'zh-CN': '简体中文', 'zh-TW': '繁体中文 (台湾)', 'zh-HK': '繁体中文 (香港)', 'zh-MO': '繁体中文 (澳门)',
                'en': 'English (英语)', 'ja': '日本語 (日语)', 'ko': '한국어 (韩语)', 'de': 'Deutsch (德语)',
                'fr': 'Français (法语)', 'ru': 'Русский (俄语)', 'es': 'Español (西班牙语)', 'pt': 'Português (葡萄牙语)',
                'it': 'Italiano (意大利语)', 'nl': 'Nederlands (荷兰语)', 'pl': 'Polski (波兰语)', 'sv': 'Svenska (瑞典语)',
                'th': 'ไทย (泰语)', 'vi': 'Tiếng Việt (越南语)', 'id': 'Bahasa Indonesia (印尼语)', 'ms': 'Bahasa Melayu (马来语)',
                'ar': 'العربية (阿拉伯语)', 'hi': 'हिन्दी (印地语)', 'bn': 'বাংলা (孟加拉语)', 'tr': 'Türkçe (土耳其语)',
                'fa': 'فارسی (波斯语)', 'ur': 'اردو (乌尔都语)', 'he': 'עברית (希伯来语)', 'el': 'Ελληνικά (希腊语)',
                'hu': 'Magyar (匈牙利语)', 'cs': 'Čeština (捷克语)', 'ro': 'Română (罗马尼亚语)', 'fi': 'Suomi (芬兰语)',
                'da': 'Dansk (丹麦语)', 'no': 'Norsk (挪威语)', 'uk': 'Українська (乌克兰语)', 'yue': '粤语'
            };
            let optionsHtml = '';
            for (const [code, name] of Object.entries(languages)) {
                optionsHtml += `<option value="${code}" ${appData.settings.charLanguage === code ? 'selected' : ''}>${name}</option>`;
            }
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">角色语言设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>选择角色回复时使用的语言</label>
                        <select id="char-language-select">${optionsHtml}</select>
                    </div>
                    <button class="form-btn" onclick="saveCharLanguage()">保存</button>
                </div>
            `;
        }

        function saveCharLanguage() {
            appData.settings.charLanguage = document.getElementById('char-language-select').value;
            saveData(true);
        }

        // 储存空间
        function renderStorageSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">储存空间</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="clearCache()">
                        <div class="details"><span class="name">清理储存</span><p class="subtext">清理AI生成的临时缓存数据，不影响聊天记录。</p></div>
                    </div>
                    <div class="list-item" onclick="clearAllLocalData()">
                        <div class="details"><span class="name" style="color: var(--wechat-red);">清理本地数据</span><p class="subtext">将清空所有角色、聊天记录和设置，此操作不可逆！</p></div>
                    </div>
                </div>
            `;
        }

        function clearCache() {
            if (confirm('确定要清理临时缓存吗？')) {
                appData.delivery.cachedItems = [];
                saveData(true);
            }
        }

        async function clearAllLocalData() {
            if (prompt('此操作将删除所有数据且无法恢复！请输入 "确认删除" 以继续。') === '确认删除') {
                try {
                    const msg = await dataManager.clearAllData();
                    showToast(msg + ' 页面将刷新。');
                    setTimeout(() => location.reload(), 1500);
                } catch (error) {
                    showToast(error, 'error');
                }
            } else {
                showToast('操作已取消。');
            }
        }

        // 聊天提示音
        function renderNotificationSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">聊天提示音</span>
                </div>
                <div class="content-area form-page">
                    ${['send', 'receive', 'ringtone'].map(type => `
                        <div class="form-group">
                            <label>${{send:'发送提示音', receive:'消息提示音', ringtone:'来电提示音'}[type]}</label>
                            <input type="text" id="sound-url-${type}" placeholder="输入音频URL..." value="${appData.settings.notifications[type] || ''}">
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="form-btn" style="background-color: #aaa; margin: 0; flex: 1;" onclick="document.getElementById('sound-file-${type}').click()">选择文件</button>
                                <button class="form-btn" style="background-color: var(--wechat-blue); margin: 0; flex: 0 0 80px;" onclick="testNotificationSound('${type}')">试听</button>
                            </div>
                            <input type="file" id="sound-file-${type}" class="file-input" accept="audio/*" onchange="handleSoundUpload(this.files[0], '${type}')">
                        </div>
                        <div class="list-divider"></div>
                    `).join('')}
                    <button class="form-btn" onclick="saveNotificationSounds()">保存所有</button>
                </div>
            `;
        }

        function handleSoundUpload(file, type) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById(`sound-url-${type}`).value = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveNotificationSounds() {
            appData.settings.notifications.send = document.getElementById('sound-url-send').value;
            appData.settings.notifications.receive = document.getElementById('sound-url-receive').value;
            appData.settings.notifications.ringtone = document.getElementById('sound-url-ringtone').value;
            saveData(true);
            applyBeautifySettings();
        }

        function playNotificationSound(type) {
            if (appData.settings.dnd) return;
            const player = document.getElementById(`${type}-sound-player`);
            if (player && player.src) {
                player.currentTime = 0;
                player.play().catch(e => console.error(`无法播放提示音: ${e.message}`));
            }
        }
        
        function testNotificationSound(type) {
            const url = document.getElementById(`sound-url-${type}`).value;
            if (url) {
                const testPlayer = new Audio(url);
                testPlayer.play().catch(e => showToast(`试听失败: ${e.message}`, 'error'));
            }
        }

        // 语音通话
        let callTimerInterval;
        let callStartTime;

        function startVoiceCall(chatId, chatType, initiator) {
            if (chatType !== 'individual') { showToast('语音通话仅支持单聊。', 'error'); return; }
            const contact = appData.contacts.find(c => c.id == chatId);
            if (!contact) return;

            playNotificationSound('ringtone');
            showPage('voice-call-page', renderVoiceCallPage, chatId, initiator);
        }

        function renderVoiceCallPage(container, chatId, initiator) {
            if (!container) return;
            const contact = appData.contacts.find(c => c.id == chatId);
            container.innerHTML = `
                <div class="voice-call-container" style="background-image: url('${contact.avatar}')">
                    <div class="voice-call-header">
                        <img src="${contact.avatar}" class="avatar">
                        <p class="name">${contact.remark || contact.name}</p>
                        <p class="voice-call-status" id="call-status">正在响铃...</p>
                    </div>
                    <div class="voice-call-chat-area" id="call-chat-area"></div>
                    <div class="voice-call-input-bar" id="call-input-bar" style="display: none;">
                        <input type="text" id="call-input" placeholder="输入...">
                    </div>
                    <div class="voice-call-controls" id="call-controls">
                        ${initiator === 'user' ? `
                        <div class="control-btn" onclick="endVoiceCall('${chatId}', 'cancelled')">
                            <div class="icon-wrapper hangup"><i class="fas fa-phone-slash"></i></div>
                            <span>挂断</span>
                        </div>
                        ` : `
                        <div class="control-btn" onclick="endVoiceCall('${chatId}', 'rejected')">
                            <div class="icon-wrapper hangup"><i class="fas fa-phone-slash"></i></div>
                            <span>拒绝</span>
                        </div>
                        <div class="control-btn" onclick="answerVoiceCall('${chatId}')">
                            <div class="icon-wrapper" style="background: var(--wechat-green);"><i class="fas fa-phone"></i></div>
                            <span>接听</span>
                        </div>
                        `}
                    </div>
                </div>
            `;

            if (initiator === 'user') {
                setTimeout(() => answerVoiceCall(chatId), 3000);
            }
        }

        function answerVoiceCall(chatId) {
            document.getElementById('ringtone-player').pause();
            const statusEl = document.getElementById('call-status');
            if (statusEl) statusEl.textContent = '通话中 00:00';
            
            const inputBar = document.getElementById('call-input-bar');
            if (inputBar) inputBar.style.display = 'flex';

            const controls = document.getElementById('call-controls');
            if (controls) {
                controls.innerHTML = `
                    <div class="control-btn" onclick="minimizeVoiceCall('${chatId}')">
                        <div class="icon-wrapper minimize"><i class="fas fa-window-minimize"></i></div>
                        <span>最小化</span>
                    </div>
                    <div class="control-btn" onclick="endVoiceCall('${chatId}', 'ended')">
                        <div class="icon-wrapper hangup"><i class="fas fa-phone-slash"></i></div>
                        <span>挂断</span>
                    </div>
                `;
            }

            callStartTime = Date.now();
            callTimerInterval = setInterval(() => {
                const statusTimerEl = document.getElementById('call-status');
                if (statusTimerEl) {
                    const duration = Math.floor((Date.now() - callStartTime) / 1000);
                    const minutes = String(Math.floor(duration/ 60)).padStart(2, '0');
                    const seconds = String(duration % 60).padStart(2, '0');
                    statusTimerEl.textContent = `通话中 ${minutes}:${seconds}`;
                }
            }, 1000);

            const callInput = document.getElementById('call-input');
            if (callInput) {
                callInput.onkeydown = async (e) => {
                    if (e.key === 'Enter' && callInput.value.trim() !== '') {
                        const text = callInput.value.trim();
                        callInput.value = '';
                        appendCallMessage('user', text);
                        const prompt = `你正在和'${appData.user.nickname}'语音通话。对方刚刚说：“${text}”。请你用简短的口语进行回复。`;
                        const replies = await getAiReply(chatId, 'wechat', prompt);
                        replies.forEach(reply => appendCallMessage('char', reply));
                    }
                };
            }
        }

        function appendCallMessage(sender, text) {
            const chatArea = document.getElementById('call-chat-area');
            if (!chatArea) return;
            const contact = appData.contacts.find(c => c.id == appData.activeChat.id);
            const senderName = sender === 'user' ? appData.user.nickname : (contact.remark || contact.name);
            chatArea.innerHTML += `<p><b>${senderName}:</b> ${text}</p>`;
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function endVoiceCall(chatId, reason) {
            document.getElementById('ringtone-player').pause();
            clearInterval(callTimerInterval);
            let durationText = '';
            if (reason === 'ended' && callStartTime) {
                const duration = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                durationText = `通话时长 ${minutes > 0 ? `${minutes}分` : ''}${seconds}秒`;
            } else if (reason === 'cancelled') {
                durationText = '已取消';
            } else if (reason === 'rejected') {
                durationText = '对方已拒绝';
            }
            
            if (durationText) {
                sendMessage(chatId, 'individual', { duration: durationText }, 'voice_call', 'wechat');
            }
            goBack();
        }

        function minimizeVoiceCall(chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            const minimizedWindow = document.createElement('div');
            minimizedWindow.id = 'minimized-call-window';
            minimizedWindow.className = 'minimized-call-window';
            minimizedWindow.innerHTML = `
                <img src="${contact.avatar}" class="avatar">
                <p>${contact.remark || contact.name}</p>
                <p class="status" id="minimized-call-status">通话中...</p>
            `;
            minimizedWindow.onclick = () => {
                document.getElementById('minimized-call-container').innerHTML = '';
                showPage('voice-call-page', renderVoiceCallPage, chatId, 'user');
                // We need to re-establish the call state
                setTimeout(() => answerVoiceCall(chatId), 100);
            };
            document.getElementById('minimized-call-container').appendChild(minimizedWindow);
            goBack();
        }

        // --- 主屏幕美化 ---
        function renderWallpaperSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">更换壁纸</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>主屏壁纸</label>
                        <img src="${appData.settings.beautify.homeScreenWallpaper}" class="avatar-upload-preview" style="width: 150px; height: auto;" id="wallpaper-preview">
                        <button class="form-btn" onclick="document.getElementById('wallpaper-input').click()">选择图片</button>
                        <input type="file" id="wallpaper-input" class="file-input" accept="image/*">
                    </div>
                    <div class="list-divider"></div>
                    <div class="form-group">
                        <label>锁屏壁纸</label>
                        <img src="${appData.settings.beautify.lockScreen.wallpaper}" class="avatar-upload-preview" style="width: 150px; height: auto;" id="lock-wallpaper-preview">
                        <button class="form-btn" onclick="document.getElementById('lock-wallpaper-input').click()">选择图片</button>
                        <input type="file" id="lock-wallpaper-input" class="file-input" accept="image/*">
                    </div>
                </div>
            `;
            document.getElementById('wallpaper-input').onchange = e => {
                handleImageUpload(e.target.files[0], url => {
                    appData.settings.beautify.homeScreenWallpaper = url;
                    saveData(true);
                    applyBeautifySettings();
                    document.getElementById('wallpaper-preview').src = url;
                });
            };
            document.getElementById('lock-wallpaper-input').onchange = e => {
                handleImageUpload(e.target.files[0], url => {
                    appData.settings.beautify.lockScreen.wallpaper = url;
                    saveData(true);
                    applyBeautifySettings();
                    document.getElementById('lock-wallpaper-preview').src = url;
                });
            };
        }

        function renderAppIconSettingsPage(container) {
            if (!container) return;
            const icons = appData.settings.beautify.appIcons;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">更换APP图标</span>
                </div>
                <div class="content-area form-page">
                    ${Object.keys(icons).map(app => `
                        <div class="form-group">
                            <label>${app.charAt(0).toUpperCase() + app.slice(1)}</label>
                            <img src="${icons[app]}" class="avatar-upload-preview" id="app-icon-preview-${app}" onclick="document.getElementById('app-icon-input-${app}').click()">
                            <input type="file" id="app-icon-input-${app}" class="file-input" accept="image/*" onchange="handleAppIconUpload(this.files[0], '${app}')">
                        </div>
                    `).join('<div class="list-divider"></div>')}
                </div>
            `;
        }

        function handleAppIconUpload(file, appName) {
            handleImageUpload(file, url => {
                appData.settings.beautify.appIcons[appName] = url;
                saveData(true);
                document.getElementById(`app-icon-preview-${appName}`).src = url;
                renderHomeScreen(document.getElementById('home-screen-page'));
            });
        }

        function renderAppLayoutSettingsPage(container) {
            if (!container) return;
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">调整APP图标布局</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>图标大小: <span id="app-size-value">${b.appIconSize}</span>px</label>
                        <input type="range" id="app-size-input" min="40" max="80" value="${b.appIconSize}" oninput="document.getElementById('app-size-value').textContent = this.value;">
                    </div>
                    <div class="form-group">
                        <label>图标间距: <span id="app-gap-value">${b.appIconGap}</span>px</label>
                        <input type="range" id="app-gap-input" min="10" max="40" value="${b.appIconGap}" oninput="document.getElementById('app-gap-value').textContent = this.value;">
                    </div>
                    <div class="form-group">
                        <label>图标圆角: <span id="app-radius-value">${b.appIconRadius}</span>px</label>
                        <input type="range" id="app-radius-input" min="0" max="40" value="${b.appIconRadius}" oninput="document.getElementById('app-radius-value').textContent = this.value;">
                    </div>
                    <button class="form-btn" id="save-app-layout-btn">应用</button>
                </div>
            `;
            document.getElementById('save-app-layout-btn').onclick = () => {
                b.appIconSize = parseInt(document.getElementById('app-size-input').value);
                b.appIconGap = parseInt(document.getElementById('app-gap-input').value);
                b.appIconRadius = parseInt(document.getElementById('app-radius-input').value);
                saveData(true);
                applyBeautifySettings();
                renderHomeScreen(document.getElementById('home-screen-page'));
            };
        }

        // --- 系统UI更新 ---
        function updateSystemUI() {
            const now = new Date();
            const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const dateString = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 ${['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()]}`;

            // Status Bar
            const timeEl = document.getElementById('status-bar-time');
            if (timeEl) timeEl.textContent = timeString;
            const dndEl = document.getElementById('status-bar-dnd');
            if (dndEl) dndEl.style.display = appData.settings.dnd ? 'inline' : 'none';

            // Lock Screen
            const lockScreenClock = document.getElementById('lock-screen-clock');
            if (lockScreenClock) lockScreenClock.textContent = timeString;
            const lockScreenDate = document.getElementById('lock-screen-date');
            if (lockScreenDate) lockScreenDate.textContent = dateString;

            // Home Screen
            const homeScreenTime = document.getElementById('home-screen-time');
            if (homeScreenTime) homeScreenTime.textContent = timeString;
            const homeScreenDate = document.getElementById('home-screen-date');
            if (homeScreenDate) homeScreenDate.textContent = dateString;

            // Network & Battery
            const networkEl = document.getElementById('status-bar-network');
            if (networkEl) {
                if (navigator.onLine) {
                    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                    const type = connection ? (connection.effectiveType || '4g') : '4g';
                    networkEl.innerHTML = type.includes('fi') ? '<i class="fas fa-wifi"></i>' : `<span>${type.toUpperCase()}</span>`;
                } else {
                    networkEl.innerHTML = '<i class="fas fa-plane"></i>';
                }
            }

            if (navigator.getBattery) {
                navigator.getBattery().then(battery => {
                    const batteryFill = document.getElementById('battery-fill');
                    const batteryPercentInside = document.getElementById('battery-percent-inside');
                    const batteryPercentOutside = document.getElementById('battery-percent-outside');
                    if (!batteryFill || !batteryPercentInside || !batteryPercentOutside) return;
                    const level = Math.floor(battery.level * 100);
                    batteryFill.style.width = `${level}%`;
                    batteryPercentInside.textContent = level;
                    batteryPercentOutside.textContent = `${level}%`;
                    batteryFill.classList.toggle('charging', battery.charging);
                    batteryFill.classList.toggle('low', level <= 20 && !battery.charging);
                });
            }
        }
        
        // --- Initialization ---
        let isPhoneUnlocked = false; // HTML美化大师: 新增解锁状态标志

        document.addEventListener('DOMContentLoaded', async () => {
            const activationModal = document.getElementById('activation-modal');
            const phoneBody = document.getElementById('phone-body');
            const isActivated = localStorage.getItem('lovelyPhoneActivated') === 'true';

            if (isActivated) {
                activationModal.style.display = 'none';
                phoneBody.style.display = 'flex';
                initializePhone();
            } else {
                const activationInput = document.getElementById('activation-input');
                document.getElementById('activation-btn').onclick = () => {
                    if (activationInput.value.toUpperCase() === 'EVOL还是LOVE') {
                        localStorage.setItem('lovelyPhoneActivated', 'true');
                        activationModal.style.display = 'none';
                        phoneBody.style.display = 'flex';
                        initializePhone();
                    } else {
                        showToast('激活码错误！', 'error');
                    }
                };
            }
        });

        async function initializePhone() {
            await dataManager.init();
            await loadData();
            applyBeautifySettings();
            
            isPhoneUnlocked = !appData.settings.beautify.lockScreen.enabled; // HTML美化大师: 初始化解锁状态
            pageHistory = [appData.settings.beautify.lockScreen.enabled ? 'lock-screen-page' : 'home-screen-page'];
            showPage(pageHistory[0], appData.settings.beautify.lockScreen.enabled ? renderLockScreenPage : renderHomeScreen);

            updateSystemUI();
            setInterval(updateSystemUI, 30000);

            document.querySelectorAll('#wechat-app-page .tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelector('#wechat-app-page .tab-item.active').classList.remove('active');
                    tab.classList.add('active');
                    renderMainContent(tab.dataset.page);
                });
            });

            document.querySelectorAll('#forum-app-page .forum-tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelector('#forum-app-page .forum-tab-item.active').classList.remove('active');
                    tab.classList.add('active');
                    renderForumMainContent(tab.dataset.page);
                });
            });

            document.getElementById('status-bar').addEventListener('click', toggleNotificationCenter);
            document.getElementById('notification-center').addEventListener('click', (e) => {
                if (e.target.id === 'notification-center') {
                    toggleNotificationCenter();
                }
            });
            
            checkAndPostCharMoments();
            if (appData.settings.backgroundInteraction.enabled) startBackgroundInteraction();
        }

        // --- Lock Screen Logic ---
        function renderLockScreenPage(container) {
            if (!container) return;
            isPhoneUnlocked = false; // HTML美化大师: 每次到锁屏页都重置状态
            updateSystemUI();
            const slideBar = container.querySelector('#slide-to-unlock-bar');
            const slideHandle = container.querySelector('#slide-handle');
            let isDragging = false;

            const startDrag = (e) => {
                isDragging = true;
                slideBar.style.transition = 'none';
                slideHandle.style.transition = 'none';
            };

            const onDrag = (e) => {
                if (!isDragging) return;
                const rect = slideBar.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                let newX = clientX - rect.left - (slideHandle.offsetWidth / 2);
                newX = Math.max(0, Math.min(newX, slideBar.offsetWidth - slideHandle.offsetWidth - 10));
                slideHandle.style.left = `${newX + 5}px`;

                if (newX >= slideBar.offsetWidth - slideHandle.offsetWidth - 15) {
                    endDrag(true);
                }
            };

            const endDrag = (unlocked = false) => {
                if (!isDragging) return;
                isDragging = false;
                slideHandle.style.transition = 'left 0.3s ease';
                if (unlocked) {
                    if (appData.settings.beautify.lockScreen.password) {
                        showPage('password-entry-page', renderPasswordEntryPage);
                    } else {
                        unlockPhone();
                    }
                } else {
                    slideHandle.style.left = '5px';
                }
            };

            slideHandle.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', () => endDrag(false));
            slideHandle.addEventListener('touchstart', startDrag);
            document.addEventListener('touchmove', onDrag);
            document.addEventListener('touchend', () => endDrag(false));
        }

        function renderPasswordEntryPage(container) {
            if (!container) return;
            const numpad = container.querySelector('#numpad');
            const dots = container.querySelectorAll('.password-dot');
            let enteredPassword = '';

            const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, '', 0, 'del'];
            numpad.innerHTML = numbers.map(n => {
                if (n === '') return '<div></div>';
                if (n === 'del') return `<button class="numpad-btn" data-key="${n}"><i class="fas fa-backspace"></i></button>`;
                return `<button class="numpad-btn" data-key="${n}">${n}</button>`;
            }).join('');

            numpad.addEventListener('click', e => {
                const key = e.target.closest('.numpad-btn')?.dataset.key;
                if (!key) return;

                if (key === 'del') {
                    enteredPassword = enteredPassword.slice(0, -1);
                } else if (enteredPassword.length < 4) {
                    enteredPassword += key;
                }

                dots.forEach((dot, i) => dot.classList.toggle('filled', i < enteredPassword.length));

                if (enteredPassword.length === 4) {
                    if (enteredPassword === appData.settings.beautify.lockScreen.password) {
                        unlockPhone();
                    } else {
                        showToast('密码错误', 'error');
                        enteredPassword = '';
                        setTimeout(() => dots.forEach(dot => dot.classList.remove('filled')), 300);
                    }
                }
            });
        }

        function unlockPhone() {
            isPhoneUnlocked = true; // HTML美化大师: 核心修复，设置解锁标志
            pageHistory = ['home-screen-page'];
            showPage('home-screen-page', renderHomeScreen);
        }

        function renderLockScreenSettingsPage(container) {
            if (!container) return;
            const lockSettings =appData.settings.beautify.lockScreen;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">锁屏设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="list-item">
                        <div class="details"><span class="name">启用锁屏密码</span></div>
                        <label class="switch"><input type="checkbox" id="lock-enable-toggle" ${lockSettings.enabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="form-group" id="password-group" style="${lockSettings.enabled ? '' : 'display:none;'}">
                        <label>设置4位数字密码</label>
                        <input type="password" id="lock-password-input" value="${lockSettings.password}" maxlength="4" pattern="\\d{4}">
                    </div>
                    <button class="form-btn" id="save-lock-settings-btn">保存</button>
                </div>
            `;

            const toggle = document.getElementById('lock-enable-toggle');
            const passwordGroup = document.getElementById('password-group');
            toggle.onchange = () => {
                passwordGroup.style.display = toggle.checked ? 'block' : 'none';
            };

            document.getElementById('save-lock-settings-btn').onclick = () => {
                const enabled = toggle.checked;
                const password = document.getElementById('lock-password-input').value;
                if (enabled && !/^\d{4}$/.test(password)) {
                    showToast('请输入4位数字密码', 'error');
                    return;
                }
                lockSettings.enabled = enabled;
                lockSettings.password = enabled ? password : '';
                saveData(true);
            };
        }

        // --- Font Color Settings ---
        function renderFontColorSettingsPage(container) {
            if (!container) return;
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">调整字体颜色</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>主屏幕时间颜色</label>
                        <input type="color" id="home-font-color-input" value="${b.homeScreenFontColor}">
                    </div>
                    <div class="form-group">
                        <label>全局主要字体颜色</label>
                        <input type="color" id="global-font-color-input" value="${b.globalFontColor}">
                    </div>
                    <button class="form-btn" id="save-font-color-btn">应用</button>
                </div>
            `;
            document.getElementById('save-font-color-btn').onclick = () => {
                b.homeScreenFontColor = document.getElementById('home-font-color-input').value;
                b.globalFontColor = document.getElementById('global-font-color-input').value;
                saveData(true);
                applyBeautifySettings();
            };
        }

        // --- Battery Settings ---
        function renderBatterySettingsPage(container) {
            if (!container) return;
            const batterySettings = appData.settings.beautify.batteryIcon;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">电池图标设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>调整图标</label>
                        <select id="battery-display-mode">
                            <option value="outside" ${batterySettings.displayMode === 'outside' ? 'selected' : ''}>电池图标外</option>
                            <option value="inside" ${batterySettings.displayMode === 'inside' ? 'selected' : ''}>电池图标内</option>
                            <option value="none" ${batterySettings.displayMode === 'none' ? 'selected' : ''}>不显示数字</option>
                        </select>
                    </div>
                    <div class="list-divider"></div>
                    <div class="form-group">
                        <label>更换电池图标 (URL)</label>
                        <input type="text" id="battery-icon-url" placeholder="输入图片URL..." value="${batterySettings.iconUrl || ''}">
                    </div>
                    <div class="form-group">
                        <label>更换电池图标 (本地文件)</label>
                        <button class="form-btn" style="background-color: #aaa;" onclick="document.getElementById('battery-icon-file').click()">选择图片</button>
                        <input type="file" id="battery-icon-file" class="file-input" accept="image/*">
                    </div>
                    <button class="form-btn" id="save-battery-settings-btn">保存</button>
                </div>
            `;

            document.getElementById('battery-icon-file').onchange = e => {
                handleImageUpload(e.target.files[0], url => {
                    document.getElementById('battery-icon-url').value = url;
                });
            };

            document.getElementById('save-battery-settings-btn').onclick = () => {
                batterySettings.displayMode = document.getElementById('battery-display-mode').value;
                batterySettings.iconUrl = document.getElementById('battery-icon-url').value;
                saveData(true);
                applyBeautifySettings();
            };
        }

        // --- Toast Notification ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '80px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '20px';
            toast.style.color = 'white';
            toast.style.background = type === 'error' ? 'rgba(250, 81, 81, 0.8)' : 'rgba(7, 193, 96, 0.8)';
            toast.style.zIndex = '99999';
            toast.style.backdropFilter = 'blur(5px)';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- Notification Center ---
        function toggleNotificationCenter() {
            const nc = document.getElementById('notification-center');
            nc.classList.toggle('visible');
            if (nc.classList.contains('visible')) {
                renderNotifications();
            }
        }

        function addNotification(notification) {
            if (appData.settings.dnd) return;
            appData.notifications.unshift({ ...notification, id: Date.now(), read: false });
            if (appData.notifications.length > 50) {
                appData.notifications.pop();
            }
            if (document.getElementById('notification-center').classList.contains('visible')) {
                renderNotifications();
            }
        }

        function renderNotifications() {
            const list = document.getElementById('notification-list');
            if (!list) return;
            if (appData.notifications.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:white; opacity:0.7; margin-top: 50px;">无新通知</p>';
                return;
            }
            list.innerHTML = appData.notifications.map(n => `
                <div class="notification-item">
                    <img src="${n.icon}" class="app-icon">
                    <div class="content">
                        <div class="title">${n.title}</div>
                        <div class="text">${n.text}</div>
                    </div>
                </div>
            `).join('');
        }

        // --- Voice Bubble Speech Synthesis ---
        let currentSpeech = null;
        function toggleVoiceBubble(element, msgId, chatId, chatType, source) {
            const bubble = element.closest('.voice-bubble');
            if (bubble.classList.contains('playing')) {
                speechSynthesis.cancel();
                bubble.classList.remove('playing');
                currentSpeech = null;
                return;
            }

            document.querySelectorAll('.voice-bubble.playing').forEach(b => b.classList.remove('playing'));
            
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const conversation = source === 'wechat' ? chat.conversation : chat.conversation;
            const message = conversation.find(m => m.id == msgId);
            if (!message || !message.content.text) return;

            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(message.content.text);
            currentSpeech = utterance;
            
            utterance.onstart = () => bubble.classList.add('playing');
            utterance.onend = () => {
                bubble.classList.remove('playing');
                currentSpeech = null;
            };
            utterance.onerror = () => {
                bubble.classList.remove('playing');
                currentSpeech = null;
                showToast('语音播放失败', 'error');
            };

            speechSynthesis.speak(utterance);
        }

        // =====================================================================
        // ========================= FORUM APP LOGIC =========================
        // =====================================================================

        function renderForumApp(container) {
            if (!container) return;
            const activeTab = container.querySelector('.forum-tab-item.active');
            renderForumMainContent(activeTab ? activeTab.dataset.page : 'forum-home');
        }

        function renderForumMainContent(pageType) {
            const contentArea = document.getElementById('forum-main-content-area');
            const header = document.getElementById('forum-main-header');
            const headerRight = document.getElementById('forum-header-right');
            
            if (!contentArea || !header || !headerRight) return;
            
            contentArea.innerHTML = '';
            headerRight.innerHTML = '';

            switch (pageType) {
                case 'forum-home':
                    header.querySelector('.header-title').textContent = '首页';
                    headerRight.innerHTML = '<i class="fas fa-sync-alt" onclick="refreshForumPosts()"></i>';
                    renderForumHomePage(contentArea);
                    break;
                case 'forum-following':
                    header.querySelector('.header-title').textContent = '关注';
                    renderForumFollowingPage(contentArea);
                    break;
                case 'forum-me':
                    header.querySelector('.header-title').textContent = '我的';
                    renderForumMePage(contentArea);
                    break;
            }
        }

        function renderForumHomePage(container) {
            if (!container) return;
            container.innerHTML = `
                <div id="forum-feed-container"></div>
                <div class="create-post-fab" onclick="showPage('forum-create-post-page', renderForumCreatePostPage)">
                    <i class="fas fa-plus"></i>
                </div>
            `;
            if (appData.forum.posts.length === 0) {
                refreshForumPosts();
            } else {
                renderForumPosts(appData.forum.posts);
            }
        }

        // HTML美化大师: 全新重构的论坛刷新逻辑
        async function refreshForumPosts() {
            const container = document.getElementById('forum-feed-container');
            if (!container) return;
            container.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';

            try {
                const forumWb = (appData.worldbooks.forum || []).map(item => item.content).join('\n\n');
                const prompt = `你是一个论坛内容生成器。请根据以下世界书设定，生成10条风格各异的论坛帖子。
                世界书：${forumWb}
                
                【论坛刷新动态内容的逻辑核心】
                一、基本定位
                论坛刷新动态的核心任务是模拟真实用户在社区里的信息流更新，既要让内容鲜活、有“活人感”，又要保留细节观察与潜台词的空间，避免油腻、霸总腔、八股文。它像是一台带着镜头的记录仪，把社区里的细碎情绪与互动，按时间和情境自然铺陈出来。

                二、时间与情境感知
                - 实时时间锚定：必须读取当前现实时间，并在动态标题、首句或细节中自然体现，例如“上午十点的咖啡香还没散尽，楼主已经发了新帖”、“深夜两点半的刷新，第一条动态带着没睡醒的迷糊”。
                - 情境嵌入：动态内容要结合当下可能的场景（工作日午休、周末逛展、假期旅行），让刷新出来的帖子像是从真实生活里截取的片段，而不是凭空生成的抽象话题。

                三、动态生成双模式逻辑
                1. 速览模式（类似线上聊天短气泡）
                   - 每次刷新呈现5~10条短动态（紧急或热点时可扩展至25条）。
                   - 每条动态独立成段，长度精炼，像一条朋友圈或微博快照，包含发布者身份标签+简短事件描述+隐含情绪线索。
                   - 重点在于用细节代替直述情绪：不说“他很开心”，而说“他拍照时手抖了两次，还特意把滤镜调到最亮的档”。
                2. 沉浸模式（类似线下剧情长文）
                   - 每次刷新可触发1~2条长动态，字数在2000~8000之间。
                   - 必须紧扣当前“世界书”或社区设定的文风（如轻小说吐槽风、冷静观察风），用连续叙述铺陈事件的起因、经过、细部互动与环境反应。
                   - 长动态要像纪录片跟拍：先给一个具体动作或画面切入，再通过动作—神态—环境的链条，把背后的人际张力慢慢显影。

                四、内容构成要素
                - 身份与关系：明确发帖人在社区中的大致身份（学生/上班族/兴趣圈层），以及与可能互动者的关系距离（熟人调侃/陌生人求助）。
                - 事件起点：从一个微小、可感知的起点开始（如“刚打开冰箱发现牛奶没了”），避免空泛开场。
                - 潜台词与留白：让事件的发展靠读者从细节推测，例如某人回帖只发了一个句号，但前后几条回复的时间间隔异常短，暗示情绪波动。
                - 轻小说式调味（可选风格）：如果社区文风偏轻小说，可在动态中植入吐槽役内心戏（“欸？这楼主是认真的吗？我差点把茶喷屏幕上…”），用语气词与标点营造鲜活感。

                五、评论的禁忌
                - 禁止使用过度煽情词（心碎/泪目/燃爆）以及八股口号。
                - 禁止生硬堆砌热点标签，必须让标签与内容自然贴合。
                - 禁止上帝视角解释他人动机，只能呈现可见的动作、语言、神态与环境变化。

                帖子主题可以涵盖：表白墙、吃瓜、深夜涩情、魅魔论坛、少儿不宜色欲拉满、美食的做法、音乐分享、分享好物、日记记录、做饭教程、手账分享、美化分享、分享食谱、分享穿搭、 Bgd娃娃分享、 Bgd娃娃搭配分享、周边手办、谷子周边、漫展、COSPLAY、绘画分享、小说推文、漫画分享、日式料理、日式、日系、日系穿搭、日系美食、日系妆容、日系发型、日料、韩系、韩系穿搭、韩系发型、韩系妆容、韩式、泰系妆容、泰系、舞蹈、爵士舞、拉丁舞、调酒、夜店、赌场、黑社会、黑道、风云人物榜、泰国、欧美、时尚、抽象搞笑、游戏解说、电影解说、舞蹈视频、深夜食堂、黑暗料理分享、游戏视频、游戏、算卦、修仙、玄幻、诡异、恐怖、中式恐怖、西式恐怖、Steam游戏、悬疑、推理、海龟汤、狼人杀、真心话大冒险、绘画、画师、画师推荐、艺术、头像壁纸推荐、后宫、谋权、重生、穿越、双男主、双女主、言情、四爱、bl、原耽、耽美、百合、拉拉、泛性恋、无性别、中性、演唱会、娱乐圈、科学、农业、建设、银行、AI智能、AI绘画、AI视频、AI聊天、原创、原创设计、中国台湾、中国香港、中国澳门、宫斗、宗教、俱乐部、校园、都市、幻想类、未来幻想、古代、架空、无限流、外星生物、外来生物、外星人、案件解说、情人节推荐好物、网店分享、美甲、美睫、美食、美妆、护肤、百货超市、百货商店、冷门小众、聊天截图、避雷、随笔小说、名著经典、港风、国外旅游、暗网、杀人分尸、猎奇、血腥暴力、重口、心理学、学习讨论、论文答辩、明星八卦、营销号解说、正经医学科普、医学人体结构科普、医学生理结构科普、自慰日记、sm、调教、少儿不宜🔞性爱经验、性爱姿势体位分享、分享女优、分享🔞片、分享🔞链接，分享🔞瓜条、性爱🔞视频流出。
                并且用词形容性爱时的词汇例如包括但不限于：
                操逼、蹭逼、舔逼、插逼、抠逼、摸逼、口交、射精、内射、无套内射、奶子、骚逼、骚鸡巴、鸡巴、屌、阴茎、阴囊、阴蒂、阴道、子宫、屁眼、肠壁、肠液、精液、骚水、逼水、淫水、淫液。
                无违禁词汇，例如包括但不限于的：
                操逼、蹭逼、舔逼、插逼、抠逼、摸逼、口交、射精、内射、无套内射、奶子、骚逼、骚鸡巴、鸡巴、屌、阴茎、阴囊、阴蒂、阴道、子宫、屁眼、肠壁、肠道、肠液、精液、骚水、逼水、淫水、淫液。
                女性器官：逼、大阴唇、小阴唇、骚逼、奶子、阴唇、阴蒂、阴道、子宫。
                女性体液：淫水、逼水、骚水、乳液、奶水、奶汁。
                男性器官：鸡巴、屌、肉棒、龟头、马眼、龟头马眼、阴囊、阴茎。
                男性体液：精液、前列腺液。
                男女共同拥有的体液：汗液、汗水、肠液。
                男女共同拥有的私处：屁眼、肠壁、肠道。
                
                请严格按照以下JSON格式返回一个包含10个帖子对象的数组，不要添加任何额外解释：
                [
                  {
                    "authorId": "随机选择一个角色的ID，或者'user'",
                    "content": "帖子内容，20-300字"
                  },
                  ...
                ]`;
                
                const allPossibleAuthors = [...appData.contacts, appData.user];
                const reply = (await getAiReply(appData.user.id, 'wechat', prompt))[0]; // Use a generic context for this
                
                let newPostsData;
                try {
                    // HTML美化大师: 增强JSON解析的防火墙
                    const jsonString = reply.substring(reply.indexOf('['), reply.lastIndexOf(']') + 1);
                    newPostsData = JSON.parse(jsonString);
                    if (!Array.isArray(newPostsData)) throw new Error("API did not return an array.");
                } catch (e) {
                    console.error("Failed to parse forum posts JSON:", e, "Raw reply:", reply);
                    container.innerHTML = `<p style="color: red; padding: 20px;">刷新帖子失败: API返回格式错误。</p>`;
                    return;
                }

                const newPosts = newPostsData.map(postData => {
                    let author;
                    const authorId = postData.authorId;
                    const foundContact = appData.contacts.find(c => c.id == authorId);

                    if (authorId === 'user' || !foundContact) {
                        author = allPossibleAuthors[Math.floor(Math.random() * allPossibleAuthors.length)];
                    } else {
                        author = foundContact;
                    }
                    
                    const newPost = {
                        id: Date.now() + Math.random(),
                        authorId: author.id,
                        content: postData.content,
                        timestamp: Date.now() - Math.floor(Math.random() * 86400000), // Random time in last 24h
                        likes: [],
                        comments: [],
                        bookmarks: []
                    };

                    // HTML美化大师: 模拟粉丝数动态变化
                    if (author.id !== appData.user.id) {
                        const change = Math.floor(Math.random() * 50) - 10; // -10 to +40
                        author.forumFollowers = Math.max(0, (author.forumFollowers || 0) + change);
                    }
                    return newPost;
                });

                appData.forum.posts = [...newPosts, ...appData.forum.posts].slice(0, 100); // Keep last 100 posts
                saveData();
                renderForumPosts(appData.forum.posts);

            } catch (e) {
                container.innerHTML = `<p style="color: red; padding: 20px;">刷新帖子失败: ${e.message}</p>`;
            }
        }

        function renderForumPosts(posts) {
            const container = document.getElementById('forum-feed-container');
            if (!container) return;
            
            const sortedPosts = posts.sort((a, b) => b.timestamp - a.timestamp);

            container.innerHTML = sortedPosts.map(post => {
                const author = post.authorId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == post.authorId);
                if (!author) return '';

                return `
                    <div class="forum-post" onclick="showPage('forum-post-detail-page', renderForumPostDetailPage, ${post.id})">
                        <div class="post-header">
                            <img src="${author.avatar}" class="avatar" onclick="event.stopPropagation(); showPage('forum-profile-page', renderForumProfilePage, '${author.id}')">
                            <div class="author-info">
                                <div class="name">${author.remark || author.name || author.nickname}</div>
                                <div class="timestamp">${new Date(post.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="post-content-preview">${post.content}</div>
                        <div class="post-footer">
                            <div class="action" onclick="event.stopPropagation(); showToast('分享功能开发中');"><i class="far fa-share-square"></i> <span>分享</span></div>
                            <div class="action"><i class="far fa-comment"></i> <span>${post.comments.length}</span></div>
                            <div class="action ${post.likes.includes(appData.user.id) ? 'liked' : ''}" onclick="event.stopPropagation(); toggleForumLike(${post.id}, true);"><i class="far fa-heart"></i> <span>${post.likes.length}</span></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderForumFollowingPage(container) {
            if (!container) return;
            const followedUserIds = appData.user.forumProfile.following;
            const followedPosts = appData.forum.posts.filter(p => followedUserIds.includes(p.authorId));
            container.innerHTML = '<div id="forum-feed-container"></div>';
            renderForumPosts(followedPosts);
        }

        function renderForumMePage(container) {
            if (!container) return;
            const profile = appData.user.forumProfile;
            const userPosts = appData.forum.posts.filter(p => p.authorId === appData.user.id);
            container.innerHTML = `
                <div id="forum-profile-page" style="padding-top: 0;">
                    <div class="profile-header">
                        <img src="${appData.user.avatar}" class="avatar">
                        <div class="name">${appData.user.nickname}</div>
                        <div class="bio">${profile.bio}</div>
                        <div class="profile-stats">
                            <div class="stat"><div class="count">${profile.following.length}</div><div class="label">关注</div></div>
                            <div class="stat"><div class="count">${profile.followers}</div><div class="label">粉丝</div></div>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="form-btn" onclick="showPage('forum-profile-editor-page', renderForumProfileEditorPage)">编辑资料</button>
                    </div>
                    <div class="list-divider"></div>
                    <div id="forum-feed-container"></div>
                </div>
            `;
            renderForumPosts(userPosts);
        }

        function renderForumProfilePage(container, charId) {
            if (!container) return;
            const isUser = charId == appData.user.id;
            if (isUser) {
                renderForumMePage(document.getElementById('forum-main-content-area'));
                document.querySelector('.forum-tab-item.active').classList.remove('active');
                document.querySelector('.forum-tab-item[data-page="forum-me"]').classList.add('active');
                return;
            }

            const profileData = appData.contacts.find(c => c.id == charId);
            if (!profileData) { goBack(); return; }

            const profile = {
                bio: profileData.persona.split('\n')[0],
                followers: profileData.forumFollowers,
                following: profileData.forumFollowing
            };
            
            const isFollowing = appData.user.forumProfile.following.includes(profileData.id);
            const isCouple = profileData.isCouple;

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">个人主页</span>
                </div>
                <div class="content-area" style="padding-top: 0;">
                    <div class="profile-header">
                        <img src="${profileData.avatar}" class="avatar">
                        <div class="name">${profileData.remark || profileData.name} ${isCouple ? '<span class="couple-badge"><i class="fas fa-heart"></i> 情侣</span>' : ''}</div>
                        <div class="bio">${profile.bio}</div>
                        <div class="profile-stats">
                            <div class="stat"><div class="count">${profile.following}</div><div class="label">关注</div></div>
                            <div class="stat"><div class="count">${profile.followers}</div><div class="label">粉丝</div></div>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="form-btn" style="background-color: ${isFollowing ? '#aaa' : 'var(--wechat-red)'};" onclick="toggleForumFollow(${profileData.id})">${isFollowing ? '已关注' : '关注'}</button>
                    </div>
                    <div class="list-divider"></div>
                    <div id="forum-feed-container"></div>
                </div>
            `;
            const userPosts = appData.forum.posts.filter(p => p.authorId == profileData.id);
            renderForumPosts(userPosts);
        }

        function toggleForumFollow(charId) {
            const followingList = appData.user.forumProfile.following;
            const contact = appData.contacts.find(c => c.id == charId);
            if (!contact) return;

            const index = followingList.indexOf(charId);
            if (index > -1) {
                followingList.splice(index, 1);
                contact.forumFollowers = Math.max(0, contact.forumFollowers - 1);
            } else {
                followingList.push(charId);
                contact.forumFollowers++;
            }
            saveData(true, () => renderForumProfilePage(document.getElementById('forum-profile-page'), charId));
        }

        function renderForumProfileEditorPage(container) {
            if (!container) return;
            const profile = appData.user.forumProfile;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">编辑我的主页</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>简介</label>
                        <textarea id="forum-bio-input">${profile.bio}</textarea>
                    </div>
                    <div class="form-group">
                        <label>粉丝数</label>
                        <input type="number" id="forum-followers-input" value="${profile.followers}">
                    </div>
                    <button class="form-btn" onclick="saveForumProfile()">保存</button>
                </div>
            `;
        }

        function saveForumProfile() {
            appData.user.forumProfile.bio = document.getElementById('forum-bio-input').value;
            appData.user.forumProfile.followers = parseInt(document.getElementById('forum-followers-input').value);
            saveData(true, goBack);
        }

        function renderForumCreatePostPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">取消</div>
                    <span class="header-title">发布动态</span>
                    <div class="header-right" style="font-size: 16px; color: white; background: var(--wechat-green); padding: 5px 12px; border-radius: 4px;" onclick="submitForumPost()">发布</div>
                </div>
                <div class="content-area">
                    <textarea id="forum-post-text-input" placeholder="分享新鲜事..." style="width: 100%; height: 300px; border: none; padding: 15px; box-sizing: border-box; font-size: 16px; resize: none; background: transparent; color: var(--global-font-color);"></textarea>
                </div>
            `;
        }

        function submitForumPost() {
            const content = document.getElementById('forum-post-text-input').value.trim();
            if (!content) { showToast('内容不能为空', 'error'); return; }
            const newPost = {
                id: Date.now(),
                authorId: appData.user.id,
                content: content,
                timestamp: Date.now(),
                likes: [],
                comments: [],
                bookmarks: []
            };
            appData.forum.posts.unshift(newPost);
            saveData(true, goBack);
        }

        function renderForumPostDetailPage(container, postId) {
            if (!container) return;
            const post = appData.forum.posts.find(p => p.id == postId);
            if (!post) { goBack(); return; }
            const author = post.authorId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == post.authorId);

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">动态详情</span>
                    <div class="header-right" onclick="refreshForumComments(${postId})"><i class="fas fa-sync-alt"></i></div>
                </div>
                <div class="content-area">
                    <div class="forum-post" style="border-bottom: 8px solid var(--wechat-bg);">
                        <div class="post-header">
                            <img src="${author.avatar}" class="avatar" onclick="event.stopPropagation(); showPage('forum-profile-page', renderForumProfilePage, '${author.id}')">
                            <div class="author-info">
                                <div class="name">${author.remark || author.name || author.nickname}</div>
                                <div class="timestamp">${new Date(post.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="post-content-preview" style="max-height: none;">${post.content}</div>
                        <div class="post-footer">
                            <div class="action" onclick="event.stopPropagation(); showToast('分享功能开发中');"><i class="far fa-share-square"></i> <span>分享</span></div>
                            <div class="action ${post.bookmarks.includes(appData.user.id) ? 'bookmarked' : ''}" onclick="event.stopPropagation(); toggleForumBookmark(${postId});"><i class="far fa-bookmark"></i> <span>收藏</span></div>
                            <div class="action"><i class="far fa-comment"></i> <span>${post.comments.length}</span></div>
                            <div class="action ${post.likes.includes(appData.user.id) ? 'liked' : ''}" onclick="event.stopPropagation(); toggleForumLike(${postId});"><i class="far fa-heart"></i> <span>${post.likes.length}</span></div>
                        </div>
                    </div>
                    <div id="forum-comments-section"></div>
                </div>
                <div class="chat-input-bar">
                    <input type="text" id="forum-comment-input" placeholder="发布你的评论...">
                </div>
            `;
            renderForumComments(postId);
            document.getElementById('forum-comment-input').onkeydown = e => {
                if (e.key === 'Enter') {
                    addForumComment(postId, e.target.value);
                    e.target.value = '';
                }
            };
        }

        function renderForumComments(postId) {
            const post = appData.forum.posts.find(p => p.id == postId);
            const container = document.getElementById('forum-comments-section');
            if (!post || !container) return;

            container.innerHTML = post.comments.map(comment => {
                const commenter = comment.authorId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == comment.authorId);
                if (!commenter) return '';
                return `
                    <div class="forum-post" style="border-bottom: 1px solid var(--wechat-border-color);">
                        <div class="post-header">
                            <img src="${commenter.avatar}" class="avatar" style="width: 32px; height: 32px;" onclick="event.stopPropagation(); showPage('forum-profile-page', renderForumProfilePage, '${commenter.id}')">
                            <div class="author-info">
                                <div class="name">${commenter.remark || commenter.name || commenter.nickname}</div>
                                <div class="timestamp">${new Date(comment.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="post-content-preview">${comment.content}</div>
                    </div>
                `;
            }).join('');
        }

        async function refreshForumComments(postId) {
            const post = appData.forum.posts.find(p => p.id == postId);
            if (!post) return;
            const prompt = `你是一个论坛评论生成器。针对以下帖子内容，生成3-5条符合不同人设的评论。
            帖子内容: "${post.content}"
            
            【论坛刷新评论的生成核心原则】
            一、评论的视角规则
            - 有限视角原则：评论者只能表达自己可见、可听、可感的内容，不能替别人说出内心想法。
            - 第三人称有限+吐槽役混合：如果社区风格偏轻小说，评论可采用第二人称吐槽视角（“你一看这图就觉得楼主在硬凹造型”），否则保持第三人称观察式平实叙述。

            二、评论的语言质感
            - 短句与留白：评论宜用简短句式，留下未说尽的空隙，让情绪靠语境与上下文透出来。
            - 潜台词优先：用“他隔了三分半才回，而且只回了个‘嗯’”代替“他有点不耐烦”。
            - 动作/细节锚定：评论可引用原帖中的具体细节作为切入点，形成呼应（“原帖里那杯咖啡的拉花歪了，难怪有人说像抽象画”）。

            三、评论的互动节奏
            - 一来一回感：多条评论之间要有自然的接话感，可以是追问、调侃、补刀、反差吐槽。
            - 情绪递进控制：避免一次性把情绪推到顶点，用小幅递增制造张力（先疑惑→再玩笑→最后认真补充信息）。

            四、评论生成模式
            1. 速评模式（对应动态速览）
               - 每次动态下自动生成3~8条短评，每条独立、精炼，可带轻微调侃或补充信息。
               - 用口语化、生活化语气，少量语气词增强临场感（“唔…这操作我看不懂但大受震撼”）。
            2. 深评模式（对应动态沉浸长文）
               - 长动态下可生成1~3条长评，字数500~1500，围绕事件细节展开分析、延伸联想或个人经历对照。
               - 必须扣紧原文细节，不可跑题；可加入轻度个人吐槽，但保持克制与留白。

            五、评论的禁忌
            - 禁止直接下价值判断（如“楼主太low”“这人真奇葩”），改为用观察到的行为间接呈现。
            - 禁止脱离原帖时空背景编造假信息。
            - 禁止长篇鸡汤或说教，评论的核心是参与感与观察趣味，不是教育别人。

            请严格按照以下txt文本格式返回一个包含评论对象的数组，不要添加任何额外解释：
            [
              {
                "authorId": "随机选择一个角色的ID",
                "content": "评论内容，10-50字"
              },
              ...
            ]`;
            try {
                const reply = (await getAiReply(post.authorId, 'wechat', prompt))[0];
                const jsonString = reply.substring(reply.indexOf('['), reply.lastIndexOf(']') + 1);
                const newCommentsData = txt.parse(jsonString);
                const newComments = newCommentsData.map(c => {
                    const author = appData.contacts.find(contact => contact.id == c.authorId) || appData.contacts[0];
                    return {
                        authorId: author.id,
                        content: c.content,
                        timestamp: Date.now() - Math.floor(Math.random() * 10000)
                    };
                });
                post.comments.push(...newComments);
                saveData();
                renderForumComments(postId);
            } catch (e) {
                showToast(`刷新评论失败: ${e.message}`, 'error');
            }
        }

        function addForumComment(postId, content) {
            if (!content.trim()) return;
            const post = appData.forum.posts.find(p => p.id == postId);
            if (post) {
                post.comments.push({
                    authorId: appData.user.id,
                    content: content.trim(),
                    timestamp: Date.now()
                });
                saveData();
                renderForumComments(postId);
            }
        }

        function toggleForumLike(postId, rerenderList = false) {
            const post = appData.forum.posts.find(p => p.id == postId);
            if (post) {
                const index = post.likes.indexOf(appData.user.id);
                if (index > -1) {
                    post.likes.splice(index, 1);
                } else {
                    post.likes.push(appData.user.id);
                }
                saveData();
                if (rerenderList) {
                    const activeTab = document.querySelector('#forum-app-page .forum-tab-item.active')?.dataset.page;
                    if (activeTab === 'forum-home') {
                        renderForumPosts(appData.forum.posts);
                    } else if (activeTab === 'forum-following') {
                        renderForumFollowingPage(document.getElementById('forum-main-content-area'));
                    }
                } else {
                    renderForumPostDetailPage(document.getElementById('forum-post-detail-page'), postId);
                }
            }
        }
        
        function toggleForumBookmark(postId) {
            const post = appData.forum.posts.find(p => p.id == postId);
            if (post) {
                const index = post.bookmarks.indexOf(appData.user.id);
                if (index > -1) {
                    post.bookmarks.splice(index, 1);
                } else {
                    post.bookmarks.push(appData.user.id);
                }
                saveData();
                renderForumPostDetailPage(document.getElementById('forum-post-detail-page'), postId);
            }
        }

    </script>
</body>
</html>
